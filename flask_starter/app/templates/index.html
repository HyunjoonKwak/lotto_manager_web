{% extends "base.html" %}

{% block content %}
<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results -->
  {% if latest %}
  <section class="card highlight-card">
    <div class="card-header">
      <h2>ğŸ¯ {{ latest.round }}íšŒ ìµœì‹  ì¶”ì²¨ê²°ê³¼</h2>
      <div class="header-actions">
        <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
        <button id="checkNewDrawBtn" class="btn-update" onclick="checkForNewDraw()">
          ìƒˆ íšŒì°¨ í™•ì¸
        </button>
      </div>
    </div>
    <div class="draw-result">
      <div class="numbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball">{{ latest.bonus }}</span>
        <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
      </div>
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
    <p>ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì •ë³´ì¡°íšŒ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
  </section>
  {% endif %}



  <!-- Latest Winning Shops -->
  {% if latest and shops_rank1 %}
  <section class="card">
    <div class="card-header">
      <h2>ğŸª {{ latest.round }}íšŒ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h2>
    </div>

    {% if shops_rank1|length > 0 %}
    <div class="table-container">
      <table>
        <thead>
          <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
        </thead>
        <tbody>
          {% for s in shops_rank1 %}
          <tr>
            <td>{{ s.sequence or '' }}</td>
            <td><strong>{{ s.name }}</strong></td>
            <td><span class="badge-method">{{ s.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
            <td>{{ s.address }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="info-box">
      <p>ì•„ì§ 1ë“± ë‹¹ì²¨ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    <div style="margin-top: 1rem; text-align: center;">
      <p><small>ë” ìì„¸í•œ ë‹¹ì²¨ì  ì •ë³´ëŠ” <a href="{{ url_for('main.info_page') }}">ì •ë³´ì¡°íšŒ í˜ì´ì§€</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</small></p>
    </div>
  </section>
  {% endif %}

</div> <!-- End main-content -->

<style>
.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.btn-update {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-update:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.btn-update:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

@media (max-width: 768px) {
  .header-actions {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .draw-date {
    order: 2;
  }

  .btn-update {
    order: 1;
    align-self: flex-end;
  }
}
</style>

<script>
async function checkForNewDraw() {
  const button = document.getElementById('checkNewDrawBtn');
  const originalText = button.innerHTML;

  button.disabled = true;
  button.innerHTML = '<span class="spinner">â³</span> í™•ì¸ì¤‘...';

  try {
    // ìƒˆë¡œìš´ íšŒì°¨ê°€ ìˆëŠ”ì§€ í™•ì¸
    const response = await fetch('/api/check-new-draw');
    const data = await response.json();

    if (data.has_new_draw) {
      const confirmed = confirm(`ìƒˆë¡œìš´ ${data.latest_round}íšŒ ì¶”ì²¨ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);

      if (confirmed) {
        button.innerHTML = '<span class="spinner">â³</span> ì—…ë°ì´íŠ¸ì¤‘...';

        // ìµœì‹  íšŒì°¨ ë°ì´í„° ì—…ë°ì´íŠ¸
        const updateResponse = await fetch('/api/update-new-draw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            round: data.latest_round
          })
        });

        const updateData = await updateResponse.json();

        if (updateData.success) {
          alert(`${data.latest_round}íšŒ ì¶”ì²¨ ê²°ê³¼ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateData.message}`);
        }
      }
    } else {
      alert('ìƒˆë¡œìš´ ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('Error checking for new draw:', error);
    alert('í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
</script>

{% endblock %}
