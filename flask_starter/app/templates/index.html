<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flask Starter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <main>
      <div class="container">
      <div class="header">
        <div>
          <h1>ë¡œë˜ ëŒ€ì‹œë³´ë“œ</h1>
          <div class="muted">íšŒì°¨ë³„ ë‹¹ì²¨ë²ˆí˜¸, ë‹¹ì²¨ì , ì¶”ì²œë²ˆí˜¸(ìë™ 3ê°œ/ë°˜ìë™ 2ê°œ)</div>
        </div>
        <div class="stats">
          <div class="stat">ì €ì¥ íšŒì°¨: {{ total_rounds }}</div>
          {% if latest %}<div class="stat">ìµœê·¼ íšŒì°¨: {{ latest.round }}</div>{% endif %}
        </div>
      </div>
      <!-- Main Content Grid -->
      <div class="main-content">

        <!-- 1. Latest Draw Results - Most Important -->
        {% if latest %}
        <section class="card highlight-card">
          <div class="card-header">
            <h2>ğŸ¯ {{ latest.round }}íšŒ ìµœì‹  ì¶”ì²¨ê²°ê³¼</h2>
            <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
          </div>
          <div class="draw-result">
            <div class="numbers">
              {% for num in latest.numbers_list() %}
                <span class="number-ball">{{ num }}</span>
              {% endfor %}
            </div>
            <div class="bonus-section">
              <span class="plus">+</span>
              <span class="bonus-ball">{{ latest.bonus }}</span>
              <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
            </div>
          </div>
        </section>
        {% else %}
        <section class="card error-card">
          <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
          <p>ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
        </section>
        {% endif %}

        <!-- 2. Quick Actions Panel -->
        <section class="card actions-card">
          <div class="card-header">
            <h2>âš¡ ë¹ ë¥¸ ì‘ì—…</h2>
          </div>

          <div class="action-groups-vertical">
            <div class="action-group">
              <h3>ğŸ”„ ë°ì´í„° í¬ë¡¤ë§</h3>
              <div class="button-row">
                <form class="action-form" method="post" action="/update-full">
                  <button type="submit" class="btn-primary">ì „ì²´ ë‹¤ì‹œ í¬ë¡¤ë§</button>
                </form>
              </div>
              <div class="button-row">
                <form class="action-form" method="post" action="/update-missing">
                  <button type="submit" class="btn-secondary">ë¹ ì§„íšŒì°¨ í¬ë¡¤ë§</button>
                </form>
              </div>
              <div class="button-row">
                <form class="action-form" method="post" action="/update-latest">
                  <button type="submit" class="btn-secondary">ìµœì‹ íšŒì°¨ í¬ë¡¤ë§</button>
                </form>
              </div>
              <div class="button-row">
                <form class="action-form" method="post" action="/update">
                  <input type="number" name="round" min="1" placeholder="íšŒì°¨ ë²ˆí˜¸" required />
                  <button type="submit" class="btn-secondary">íŠ¹ì • íšŒì°¨ í¬ë¡¤ë§</button>
                </form>
              </div>
            </div>

            <div class="action-group">
              <h3>ğŸª ë‹¹ì²¨ì •ë³´ ì¡°íšŒ</h3>
              <div class="round-input-container">
                <div class="round-input-group">
                  <button type="button" class="round-btn" onclick="changeRound(-1)">-</button>
                  <input type="number" id="round-input" name="round" min="1" value="{{ latest.round if latest else 1 }}" />
                  <button type="button" class="round-btn" onclick="changeRound(1)">+</button>
                </div>
                <button type="button" class="btn-accent" onclick="viewDrawInfo()">ë‹¹ì²¨ì •ë³´ ì¡°íšŒ</button>
              </div>
              {% if fixed %}
                <input type="hidden" id="fixed-input" value="{{ fixed|join(',') }}" />
              {% endif %}
            </div>
          </div>
        </section>

        <!-- 3. Recent Draws Table -->
        <section class="card">
          <div class="card-header">
            <h2>ğŸ“Š ìµœê·¼ 10íšŒ ì¶”ì²¨ ê¸°ë¡</h2>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>íšŒì°¨</th><th>ë‚ ì§œ</th><th>ë‹¹ì²¨ë²ˆí˜¸</th><th>ë³´ë„ˆìŠ¤</th></tr>
              </thead>
              <tbody>
                {% for d in draws %}
                <tr>
                  <td><strong>{{ d.round }}íšŒ</strong></td>
                  <td>{{ d.draw_date if d.draw_date else '-' }}</td>
                  <td class="numbers-cell">{{ d.numbers }}</td>
                  <td class="bonus-cell">{{ d.bonus }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

      {% if shops_round is not none %}
      <!-- 4. Winning Shops Header -->
      <section class="card shops-header-card">
        <div class="card-header">
          <h2>ğŸª {{ shops_round }}íšŒ ë‹¹ì²¨ì  í˜„í™©</h2>
        </div>
        <div class="shops-summary">
          <div class="summary-stats">
            <div class="stat-item">
              <span class="stat-number">{{ shops_rank1|length }}</span>
              <span class="stat-label">1ë“± ë‹¹ì²¨ì </span>
            </div>
            <div class="stat-item">
              <span class="stat-number">{{ shops_rank2_total }}</span>
              <span class="stat-label">2ë“± ë‹¹ì²¨ì </span>
            </div>
          </div>
        </div>
      </section>

      {% if shops_rank1 %}
      <section class="card">
        <h2>ğŸ¥‡ {{ shops_round }}íšŒ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h2>
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for s in shops_rank1 %}
            <tr>
              <td>{{ s.sequence or '' }}</td>
              <td><strong>{{ s.name }}</strong></td>
              <td><span class="badge-method">{{ s.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
              <td>{{ s.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      {% endif %}

      {% if shops_rank2_total > 0 %}
      <section class="card">
        <h2>ğŸ¥ˆ {{ shops_round }}íšŒ 2ë“± ë‹¹ì²¨ì  (ì´ {{ shops_rank2_total }}ê°œ)</h2>

        {% if shops_rank2_total_pages > 1 %}
        <div class="info-box">
          <p>ğŸ“Œ í˜ì´ì§€ {{ shops_rank2_page }}/{{ shops_rank2_total_pages }} ({{ (shops_rank2_page - 1) * shops_rank2_per_page + 1 }}~{{ (shops_rank2_page - 1) * shops_rank2_per_page + shops_rank2|length }}ë²ˆì§¸)</p>
        </div>
        {% endif %}

        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for s in shops_rank2 %}
            <tr>
              <td>{{ s.sequence or '' }}</td>
              <td>{{ s.name }}</td>
              <td>{{ s.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if shops_rank2_total_pages > 1 %}
        <div class="pagination">
          {% set current_params = request.args.to_dict() %}
          {% if shops_rank2_page > 1 %}
            {% set prev_params = current_params.copy() %}
            {% set _ = prev_params.update({'rank2_page': shops_rank2_page - 1}) %}
            <a href="?{{ prev_params.items() | list | urlencode }}" class="page-btn">â† ì´ì „</a>
          {% endif %}

          <span class="page-info">{{ shops_rank2_page }} / {{ shops_rank2_total_pages }}</span>

          {% if shops_rank2_page < shops_rank2_total_pages %}
            {% set next_params = current_params.copy() %}
            {% set _ = next_params.update({'rank2_page': shops_rank2_page + 1}) %}
            <a href="?{{ next_params.items() | list | urlencode }}" class="page-btn">ë‹¤ìŒ â†’</a>
          {% endif %}
        </div>

        <!-- Quick page jumps for large datasets -->
        {% if shops_rank2_total_pages > 3 %}
        <div class="quick-pages">
          <span>ë¹ ë¥¸ ì´ë™:</span>
          {% for page_num in [1, ((shops_rank2_total_pages + 1) // 2), shops_rank2_total_pages] %}
            {% if page_num != shops_rank2_page and page_num <= shops_rank2_total_pages %}
              {% set jump_params = current_params.copy() %}
              {% set _ = jump_params.update({'rank2_page': page_num}) %}
              <a href="?{{ jump_params.items() | list | urlencode }}" class="quick-page-btn">{{ page_num }}</a>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
      </section>
      {% endif %}
      {% endif %}
      <!-- Recommendation Section -->
      <section class="card recommendations-card">
        <div class="card-header">
          <h2>ğŸ² AI ì¶”ì²œë²ˆí˜¸</h2>
        </div>

        <div class="recommendation-controls">
          <form class="recommendation-form" method="get" action="/">
            <div class="input-group">
              <label for="fixed-numbers">ë°˜ìë™ ê³ ì •ë²ˆí˜¸ (ìµœëŒ€ 5ê°œ):</label>
              <input type="text" id="fixed-numbers" name="fixed"
                     value="{{ fixed|join(', ') if fixed else '' }}"
                     placeholder="ì˜ˆ: 7, 14, 21, 35" />
              <span class="input-help">ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥</span>
            </div>
            {% if shops_round is not none %}
              <input type="hidden" name="shops_round" value="{{ shops_round }}" />
            {% endif %}
            <button type="submit" class="btn-accent">ğŸ”„ ìƒˆ ì¶”ì²œë²ˆí˜¸ ìƒì„±</button>
          </form>
        </div>

        <div class="recommendations-grid">
          <div class="recommendation-type">
            <h3>ğŸ¤– ì™„ì „ìë™ (3ì„¸íŠ¸)</h3>
            <div class="recommendation-list">
              {% for rec in auto_recs %}
                <div class="recommendation-item">
                  <div class="number-set">
                    {% for num in rec %}
                      <span class="rec-number">{{ num }}</span>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          {% if fixed %}
          <div class="recommendation-type">
            <h3>ğŸ¯ ë°˜ìë™ (2ì„¸íŠ¸) - ê³ ì •: {{ fixed|join(', ') }}</h3>
            <div class="recommendation-list">
              {% for rec in semi_recs %}
                <div class="recommendation-item">
                  <div class="number-set">
                    {% for num in rec %}
                      <span class="rec-number {% if num in fixed %}fixed-number{% endif %}">{{ num }}</span>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Footer -->
      <div class="footer">
        <p>í—¬ìŠ¤ì²´í¬: <code><a href="/health">/health</a></code></p>
      </div>

      </div> <!-- End main-content -->
    </main>

    <script>
      function changeRound(delta) {
        const input = document.getElementById('round-input');
        const currentValue = parseInt(input.value) || {{ latest.round if latest else 1 }};
        const newValue = Math.max(1, currentValue + delta);
        input.value = newValue;
      }

      function viewDrawInfo() {
        const round = document.getElementById('round-input').value;
        const fixed = document.getElementById('fixed-input')?.value || '';
        let url = `/?shops_round=${round}`;
        if (fixed) {
          url += `&fixed=${encodeURIComponent(fixed)}`;
        }
        window.location.href = url;
      }
    </script>
  </body>
  </html>
