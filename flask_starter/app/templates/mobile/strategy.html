{% extends "mobile/base.html" %}

{% block title %}ëª¨ë°”ì¼ ì „ëµë¶„ì„{% endblock %}

{% block content %}
<!-- ëª¨ë°”ì¼ í—¤ë” -->
<div class="mobile-header">
  <div class="title">
    <h1>ğŸ“Š ì „ëµë¶„ì„</h1>
    <div class="subtitle">AI ê¸°ë°˜ ë²ˆí˜¸ ì¶”ì²œ</div>
  </div>
</div>

<!-- ì¶”ì²œ ë²ˆí˜¸ ì¹´ë“œ -->
{% if recommendations %}
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ¯ AI ì¶”ì²œ ë²ˆí˜¸</h2>
    <button class="refresh-btn" onclick="refreshRecommendations()">ğŸ”„</button>
  </div>

  {% for rec in recommendations[:3] %}
  <div class="recommendation-item">
    <div class="rec-header">
      <span class="rec-type">{{ rec.recommendation_type }}</span>
      <span class="rec-score">ì‹ ë¢°ë„ {{ "%.0f"|format(rec.confidence * 100) }}%</span>
    </div>

    <div class="numbers">
      {% for num in rec.numbers.split(',') %}
      <span class="number">{{ num }}</span>
      {% endfor %}
    </div>

    {% if rec.reason %}
    <div class="rec-reason">{{ rec.reason }}</div>
    {% endif %}

    <div class="rec-actions">
      <button class="btn-small btn-primary" onclick="addToPurchase('{{ rec.numbers }}')">
        êµ¬ë§¤ ì¶”ê°€
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- êµ¬ë§¤ ëª©ë¡ -->
{% if purchases %}
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ›’ ìµœê·¼ êµ¬ë§¤</h2>
    <span class="count">{{ purchases|length }}ê±´</span>
  </div>

  <div class="purchase-list">
    {% for purchase in purchases[:5] %}
    <div class="purchase-item">
      <div class="purchase-header">
        <span class="purchase-date">{{ purchase.purchase_date.strftime('%m/%d %H:%M') }}</span>
        <span class="purchase-round">{{ purchase.round }}íšŒ</span>
      </div>

      <div class="numbers">
        {% for num in purchase.numbers.split(',') %}
        <span class="number small">{{ num }}</span>
        {% endfor %}
      </div>

      {% if purchase.winning_amount %}
      <div class="winning-result">
        <span class="winning-amount">{{ "{:,}".format(purchase.winning_amount) }}ì› ë‹¹ì²¨!</span>
      </div>
      {% endif %}
    </div>
    {% endfor %}

    {% if purchases|length > 5 %}
    <div class="more-items">
      <a href="{{ url_for('main.purchase_history') }}">ì „ì²´ êµ¬ë§¤ë‚´ì—­ ë³´ê¸° â†’</a>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- í†µê³„ ì¹´ë“œ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ“ˆ ë‚˜ì˜ í†µê³„</h2>
  </div>

  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-number">{{ total_purchases or 0 }}</div>
      <div class="stat-label">ì´ êµ¬ë§¤</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ total_spent or 0 | int }}ì›</div>
      <div class="stat-label">ì´ êµ¬ë§¤ê¸ˆì•¡</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ total_winnings or 0 | int }}ì›</div>
      <div class="stat-label">ì´ ë‹¹ì²¨ê¸ˆì•¡</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ win_rate or 0 }}%</div>
      <div class="stat-label">ë‹¹ì²¨ë¥ </div>
    </div>
  </div>
</div>

<!-- ë¹ ë¥¸ ì•¡ì…˜ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ² ë¹ ë¥¸ ì•¡ì…˜</h2>
  </div>

  <div class="action-buttons">
    <button class="btn-action" onclick="getNewRecommendation()">
      <span class="action-icon">ğŸ”®</span>
      <span class="action-text">ìƒˆ ì¶”ì²œë°›ê¸°</span>
    </button>
    <button class="btn-action" onclick="quickPurchase()">
      <span class="action-icon">âš¡</span>
      <span class="action-text">ë¹ ë¥¸ êµ¬ë§¤</span>
    </button>
    <a href="{{ url_for('main.crawling_page') }}" class="btn-action">
      <span class="action-icon">ğŸ”„</span>
      <span class="action-text">ë°ì´í„° ì—…ë°ì´íŠ¸</span>
    </a>
  </div>
</div>

<!-- ë°ìŠ¤í¬í†± ë²„ì „ ë§í¬ -->
<div class="desktop-link">
  <a href="{{ url_for('main.strategy') }}?desktop=1" class="link-desktop">
    ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ë²„ì „ìœ¼ë¡œ ë³´ê¸°
  </a>
</div>
{% endblock %}

{% block scripts %}
<style>
.refresh-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 0.3rem 0.6rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  cursor: pointer;
}

.recommendation-item {
  padding: 1rem;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
  margin-bottom: 0.5rem;
  border-radius: 0.8rem;
}

.recommendation-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.rec-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.rec-type {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
}

.rec-score {
  font-size: 0.8rem;
  color: #718096;
  font-weight: 500;
}

.rec-reason {
  font-size: 0.8rem;
  color: #4a5568;
  margin: 0.5rem 0;
  line-height: 1.4;
}

.rec-actions {
  margin-top: 0.5rem;
}

.btn-small {
  padding: 0.4rem 0.8rem;
  font-size: 0.8rem;
  border-radius: 0.5rem;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.purchase-list {
  padding: 1rem;
}

.purchase-item {
  padding: 0.8rem;
  background: #f8fafc;
  margin-bottom: 0.5rem;
  border-radius: 0.8rem;
  border-left: 3px solid #4299e1;
}

.purchase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.purchase-date {
  font-size: 0.85rem;
  color: #718096;
}

.purchase-round {
  font-size: 0.8rem;
  background: #e2e8f0;
  padding: 0.2rem 0.5rem;
  border-radius: 0.3rem;
  color: #4a5568;
  font-weight: 500;
}

.number.small {
  width: 2rem;
  height: 2rem;
  font-size: 0.75rem;
}

.winning-result {
  margin-top: 0.5rem;
}

.winning-amount {
  color: #e53e3e;
  font-weight: 700;
  font-size: 0.9rem;
}

.more-items {
  text-align: center;
  padding: 0.8rem;
}

.more-items a {
  color: #4299e1;
  text-decoration: none;
  font-weight: 500;
  font-size: 0.9rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  padding: 1rem;
}

.stat-item {
  text-align: center;
  padding: 1rem;
  background: linear-gradient(135deg, #f7fafc, #edf2f7);
  border-radius: 0.8rem;
}

.stat-number {
  font-size: 1.2rem;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 0.3rem;
}

.stat-label {
  font-size: 0.8rem;
  color: #718096;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 1rem;
}

.btn-action {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f7fafc, #edf2f7);
  border: 1px solid #e2e8f0;
  border-radius: 0.8rem;
  text-decoration: none;
  color: #4a5568;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-action:active {
  transform: scale(0.98);
  background: linear-gradient(135deg, #edf2f7, #e2e8f0);
}

.action-icon {
  font-size: 1.3rem;
}

.action-text {
  font-size: 0.9rem;
}
</style>

<script>
// ì¶”ì²œ ìƒˆë¡œê³ ì¹¨
async function refreshRecommendations() {
  const response = await fetch('/api/refresh-recommendations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });

  if (response.ok) {
    window.location.reload();
  } else {
    alert('ì¶”ì²œ ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// êµ¬ë§¤ ì¶”ê°€
function addToPurchase(numbers) {
  // ê°„ë‹¨í•œ í™•ì¸ í›„ êµ¬ë§¤ í˜ì´ì§€ë¡œ ì´ë™
  const confirmed = confirm(`ì¶”ì²œ ë²ˆí˜¸ ${numbers}ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
  if (confirmed) {
    // êµ¬ë§¤ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë²ˆí˜¸ í¬í•¨)
    window.location.href = `/purchases?auto_numbers=${encodeURIComponent(numbers)}`;
  }
}

// ìƒˆ ì¶”ì²œë°›ê¸°
async function getNewRecommendation() {
  const response = await fetch('/api/recommend');
  if (response.ok) {
    window.location.reload();
  } else {
    alert('ìƒˆ ì¶”ì²œì„ ë°›ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë¹ ë¥¸ êµ¬ë§¤
function quickPurchase() {
  window.location.href = '{{ url_for("main.purchase_history") }}';
}
</script>
{% endblock %}
