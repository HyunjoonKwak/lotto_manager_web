{% extends "base.html" %}

{% block content %}
<div class="header">
  <div>
    <h1>ğŸ” ë¡œë˜ ì •ë³´ì¡°íšŒ</h1>
    <div class="muted">íšŒì°¨ë³„ ë‹¹ì²¨ë²ˆí˜¸ ë° ë‹¹ì²¨ì í¬ ì •ë³´ ì¡°íšŒ</div>
  </div>
  <div class="stats">
    <div class="stat">ì €ì¥ íšŒì°¨: {{ total_rounds }}</div>
    {% if latest %}<div class="stat">ìµœê·¼ íšŒì°¨: {{ latest.round }}</div>{% endif %}
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results with Winning Shops -->
  {% if latest %}
  <section class="card highlight-card">
    <div class="card-header">
      <h2>ğŸ¯ {{ latest.round }}íšŒ ìµœì‹  ì¶”ì²¨ê²°ê³¼</h2>
      <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
    </div>
    <div class="draw-result">
      <div class="numbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball">{{ latest.bonus }}</span>
        <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
      </div>
    </div>
  </section>

  <!-- Latest Winning Shops -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸª {{ latest.round }}íšŒ ë‹¹ì²¨ì  ì •ë³´</h2>
    </div>

    {% if shops_rank1 %}
    <div class="shops-section">
      <h4>ğŸ¥‡ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank1 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td><strong>{{ shop.name }}</strong></td>
              <td><span class="badge-method">{{ shop.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    {% if shops_rank2_total > 0 %}
    <div id="rank2-section" class="shops-section">
      <div class="section-header">
        <h4>ğŸ¥ˆ 2ë“± ë‹¹ì²¨ì  (ì´ {{ shops_rank2_total }}ê°œ)</h4>
        {% if shops_rank2_total_pages > 1 %}
        <div class="page-info">
          <span>í˜ì´ì§€ {{ shops_rank2_page }}/{{ shops_rank2_total_pages }}</span>
        </div>
        {% endif %}
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank2 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td>{{ shop.name }}</td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if shops_rank2_total_pages > 1 %}
      <div class="pagination-controls">
        <button
          type="button"
          class="page-btn prev-btn"
          onclick="changeRank2Page({{ shops_rank2_page - 1 }})"
          {% if shops_rank2_page <= 1 %}disabled{% endif %}>
          â—€ ì´ì „
        </button>

        <span class="page-display">{{ shops_rank2_page }} / {{ shops_rank2_total_pages }}</span>

        <button
          type="button"
          class="page-btn next-btn"
          onclick="changeRank2Page({{ shops_rank2_page + 1 }})"
          {% if shops_rank2_page >= shops_rank2_total_pages %}disabled{% endif %}>
          ë‹¤ìŒ â–¶
        </button>
      </div>

      {% if shops_rank2_total_pages > 3 %}
      <div class="quick-jump">
        <span>ë¹ ë¥¸ ì´ë™:</span>
        <button type="button" class="jump-btn" onclick="changeRank2Page(1)">1</button>
        {% if shops_rank2_total_pages > 2 %}
          <button type="button" class="jump-btn" onclick="changeRank2Page({{ (shops_rank2_total_pages + 1) // 2 }})">{{ (shops_rank2_total_pages + 1) // 2 }}</button>
        {% endif %}
        <button type="button" class="jump-btn" onclick="changeRank2Page({{ shops_rank2_total_pages }})">{{ shops_rank2_total_pages }}</button>
      </div>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if not shops_rank1 and not shops_rank2 %}
    <div class="info-box">
      <p>ì•„ì§ ë‹¹ì²¨ì  ì •ë³´ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
  </section>
  {% else %}
  <section class="card error-card">
    <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
    <p>ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="{{ url_for('main.crawling_page') }}">í¬ë¡¤ë§ í˜ì´ì§€</a>ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
  </section>
  {% endif %}


  <!-- Draw Info Lookup Panel -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ¯ ë‹¹ì²¨ì •ë³´ ì¡°íšŒ</h2>
    </div>

    <div class="lookup-panel">
      <div class="lookup-description">
        <p>íšŒì°¨ë³„ ë‹¹ì²¨ë²ˆí˜¸ì™€ ë‹¹ì²¨ì í¬ ì •ë³´ë¥¼ ìƒì„¸íˆ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
      </div>

      <div class="round-selector">
        <label for="round-input" class="round-label">ì¡°íšŒí•  íšŒì°¨:</label>
        <div class="round-input-group">
          <button type="button" class="round-btn" onclick="changeRound(-1)" title="ì´ì „ íšŒì°¨">â—€</button>
          <input type="number" id="round-input" name="round" min="1" max="9999" value="{{ latest.round if latest else 1 }}" class="round-number-input" />
          <button type="button" class="round-btn" onclick="changeRound(1)" title="ë‹¤ìŒ íšŒì°¨">â–¶</button>
        </div>
        <button type="button" class="btn-accent lookup-btn" onclick="viewDrawInfo()">ğŸ“Š ìƒì„¸ ì¡°íšŒ</button>
      </div>

      <div class="lookup-shortcuts">
        <button type="button" class="shortcut-btn" onclick="setRound({{ latest.round if latest else 1 }})">ìµœì‹ íšŒì°¨</button>
        <button type="button" class="shortcut-btn" onclick="setRound(1000)">1000íšŒ</button>
        <button type="button" class="shortcut-btn" onclick="setRound(500)">500íšŒ</button>
      </div>
    </div>
  </section>

  <!-- Recent draws table -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ“Š ìµœê·¼ 10íšŒ ì¶”ì²¨ ê¸°ë¡</h2>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>íšŒì°¨</th><th>ë‚ ì§œ</th><th>ë‹¹ì²¨ë²ˆí˜¸</th><th>ë³´ë„ˆìŠ¤</th></tr>
        </thead>
        <tbody>
          {% for d in draws %}
          <tr>
            <td><strong>{{ d.round }}íšŒ</strong></td>
            <td>{{ d.draw_date if d.draw_date else '-' }}</td>
            <td class="numbers-cell">
              {% for num in d.numbers_list() %}
                <span class="small-number-ball">{{ num }}</span>
              {% endfor %}
            </td>
            <td class="bonus-cell">{{ d.bonus }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Footer -->
  <div class="footer">
    <p>í—¬ìŠ¤ì²´í¬: <code><a href="/health">/health</a></code></p>
  </div>

</div> <!-- End main-content -->

<script>
  function changeRound(delta) {
    const input = document.getElementById('round-input');
    const currentValue = parseInt(input.value) || {{ latest.round if latest else 1 }};
    const newValue = Math.max(1, Math.min(9999, currentValue + delta));
    input.value = newValue;
  }

  function setRound(roundNumber) {
    const input = document.getElementById('round-input');
    input.value = Math.max(1, Math.min(9999, roundNumber));
  }

  function viewDrawInfo() {
    const round = document.getElementById('round-input').value;
    if (!round || parseInt(round) < 1) {
      alert('ì˜¬ë°”ë¥¸ íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    window.location.href = `/draw-info?round=${round}`;
  }

  function changeRank2Page(newPage) {
    if (newPage < 1) return;

    // Save current scroll position
    const currentScroll = window.pageYOffset;
    sessionStorage.setItem('infoScrollPosition', currentScroll);

    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('rank2_page', newPage);

    // Navigate with new page parameter
    window.location.href = `${window.location.pathname}?${urlParams.toString()}#rank2-section`;
  }

  // Initialize round input
  document.addEventListener('DOMContentLoaded', function() {
    // Add enter key support for round input
    const roundInput = document.getElementById('round-input');
    if (roundInput) {
      roundInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          viewDrawInfo();
        }
      });
    }

    // Restore scroll position for pagination
    const savedScroll = sessionStorage.getItem('infoScrollPosition');
    if (savedScroll && window.location.hash === '#rank2-section') {
      setTimeout(() => {
        window.scrollTo(0, parseInt(savedScroll));
        sessionStorage.removeItem('infoScrollPosition');
      }, 100);
    }
  });
</script>

<style>
/* Simple table-based shops styles */
.shops-section {
  margin-bottom: 1.5rem;
}

.shops-section h4 {
  margin-bottom: 0.75rem;
  color: #333;
  font-size: 1.1rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.page-info {
  font-size: 0.9rem;
  color: #666;
  background: #f8f9fa;
  padding: 0.5rem 0.75rem;
  border-radius: 0.25rem;
}

.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.page-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.page-btn:hover:not(:disabled) {
  background: #5a67d8;
}

.page-btn:disabled {
  background: #e2e8f0;
  color: #a0aec0;
  cursor: not-allowed;
}

.page-display {
  font-weight: 500;
  color: #333;
  padding: 0.5rem 1rem;
  background: #f8f9fa;
  border-radius: 0.25rem;
}

.quick-jump {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
  font-size: 0.9rem;
}

.jump-btn {
  background: #f8f9fa;
  border: 1px solid #e2e8f0;
  color: #667eea;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.jump-btn:hover {
  background: #667eea;
  color: white;
}

.lookup-panel {
  margin-top: 1rem;
}

.lookup-description {
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .section-header {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .pagination-controls {
    gap: 0.5rem;
  }

  .page-btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
}
</style>
{% endblock %}
