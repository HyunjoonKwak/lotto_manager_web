{% extends "base.html" %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
</script>
<div class="header">
  <div>
    <h1>ğŸ“¥ ë°ì´í„° í¬ë¡¤ë§</h1>
    <div class="muted">ë¡œë˜ ë°ì´í„° ìˆ˜ì§‘ ë° ì—…ë°ì´íŠ¸</div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Status Information -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ“Š ë°ì´í„° í˜„í™©</h2>
      <button type="button" class="btn-detail" onclick="toggleDataDetail()">Detail</button>
    </div>
    <div class="info-grid">
      <div class="info-item">
        <h4>ì €ì¥ëœ íšŒì°¨</h4>
        <p>{{ total_rounds }}íšŒ</p>
      </div>
      {% if latest %}
      <div class="info-item">
        <h4>ìµœì‹  íšŒì°¨</h4>
        <p>{{ latest.round }}íšŒ</p>
      </div>
      {% endif %}
      <div class="info-item">
        <h4>ëˆ„ë½ëœ íšŒì°¨</h4>
        <p id="missing-count">ê³„ì‚° ì¤‘...</p>
      </div>
      <div class="info-item">
        <h4>ë°ì´í„° ì™„ì„±ë„</h4>
        <p id="completion-rate">ê³„ì‚° ì¤‘...</p>
      </div>
    </div>
    
    <!-- ìƒì„¸ ì •ë³´ íŒ¨ë„ -->
    <div id="data-detail-panel" class="detail-panel" style="display: none;">
      <div class="detail-header">
        <h3>ğŸ“‹ ìƒì„¸ ë°ì´í„° í˜„í™©</h3>
        <button type="button" class="btn-close" onclick="toggleDataDetail()">Ã—</button>
      </div>
      
      <div class="detail-tabs">
        <button class="tab-btn active" onclick="showDetailTab('missing')">ëˆ„ë½ íšŒì°¨</button>
        <button class="tab-btn" onclick="showDetailTab('existing')">ì €ì¥ëœ íšŒì°¨</button>
        <button class="tab-btn" onclick="showDetailTab('summary')">ìš”ì•½ ì •ë³´</button>
      </div>
      
      <div class="detail-content">
        <div id="missing-tab" class="tab-content active">
          <div class="loading-indicator" id="missing-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <div id="missing-list" style="display: none;"></div>
        </div>
        
        <div id="existing-tab" class="tab-content">
          <div class="loading-indicator" id="existing-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <div id="existing-list" style="display: none;"></div>
        </div>
        
        <div id="summary-tab" class="tab-content">
          <div class="loading-indicator" id="summary-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <div id="summary-info" style="display: none;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Data Collection Panel -->
  <section id="data-collection" class="card actions-card">
    <div class="card-header">
      <h2>ğŸ”„ ë¡œë˜ ë°ì´í„° í¬ë¡¤ë§</h2>
    </div>

    <div class="action-groups-vertical">
      <!-- Progress Status - ìœ„ìª½ìœ¼ë¡œ ì´ë™ -->
      <section class="card progress-card" id="progress-section">
        <div class="card-header">
          <h3>âš¡ í¬ë¡¤ë§ ì§„í–‰ ìƒíƒœ</h3>
        </div>
        <div id="progress-container">
          <div class="progress-status">
            <div class="status-text" id="status-text">ëŒ€ê¸°ì¤‘</div>
            <div class="operation-type" id="operation-type"></div>
            <button type="button" class="btn-danger btn-stop" id="stop-btn" onclick="stopCrawling()" style="display: none;">
              â¹ï¸ ì¤‘ì§€
            </button>
          </div>
          <div class="progress-details" id="progress-details" style="display: none;">
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="progress-text" id="progress-text">0%</div>
            </div>
            <div class="round-info">
              <span id="current-round-info">í˜„ì¬: -</span>
              <span id="total-rounds-info">ì „ì²´: -</span>
            </div>
            <div class="time-info">
              <span id="elapsed-time">ê²½ê³¼: 0ì´ˆ</span>
              <span id="remaining-time" style="display: none;">ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: -</span>
            </div>
          </div>
        </div>
      </section>

      <!-- í¬ë¡¤ë§ ì˜µì…˜ ì„ íƒ -->
      <div class="crawling-type-selector">
        <h4>í¬ë¡¤ë§ ë°ì´í„° ì„ íƒ</h4>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="both" checked>
            <span class="radio-label">ë‹¹ì²¨ë²ˆí˜¸ + íŒë§¤ì  (ì „ì²´)</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="numbers">
            <span class="radio-label">ë‹¹ì²¨ë²ˆí˜¸ë§Œ</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="shops">
            <span class="radio-label">íŒë§¤ì ë§Œ</span>
          </label>
        </div>
      </div>

      <div class="action-group">
        <div class="crawling-grid">
          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">1</span>
              <h4>ì „ì²´ ë‹¤ì‹œ í¬ë¡¤ë§</h4>
            </div>
            <p class="option-desc">1íšŒì°¨ë¶€í„° ìµœì‹ íšŒì°¨ê¹Œì§€ ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ìˆ˜ì§‘í•©ë‹ˆë‹¤</p>
            <button type="button" class="btn-primary" onclick="startCrawling('full')">ì‹¤í–‰</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">2</span>
              <h4>ë¹ ì§„íšŒì°¨ í¬ë¡¤ë§</h4>
            </div>
            <p class="option-desc">ëˆ„ë½ëœ íšŒì°¨ë§Œ ì„ ë³„í•˜ì—¬ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('missing')">ì‹¤í–‰</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">3</span>
              <h4>ìµœì‹ íšŒì°¨ í¬ë¡¤ë§</h4>
            </div>
            <p class="option-desc">ê°€ì¥ ìµœê·¼ ì¶”ì²¨íšŒì°¨ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('latest')">ì‹¤í–‰</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">4</span>
              <h4>ë²”ìœ„ í¬ë¡¤ë§</h4>
            </div>
            <p class="option-desc">ì§€ì •í•œ íšŒì°¨ ë²”ìœ„ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤</p>
            <div class="range-input">
              <input type="number" id="startRound" min="1" placeholder="ì‹œì‘ íšŒì°¨" />
              <span>~</span>
              <input type="number" id="endRound" min="1" placeholder="ë íšŒì°¨" />
            </div>
            <button type="button" class="btn-secondary" onclick="startRangeCrawling()">ì‹¤í–‰</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">5</span>
              <h4>íŠ¹ì •íšŒì°¨ í¬ë¡¤ë§</h4>
            </div>
            <p class="option-desc">ì›í•˜ëŠ” íšŒì°¨ë¥¼ ì§€ì •í•˜ì—¬ í•´ë‹¹ ë°ì´í„°ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤</p>
            <div class="specific-round-input">
              <input type="number" id="specificRound" min="1" placeholder="íšŒì°¨ ë²ˆí˜¸" />
              <button type="button" class="btn-secondary" onclick="startSpecificCrawling()">ì‹¤í–‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</div> <!-- End main-content -->

<style>
.crawling-type-selector {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.crawling-type-selector h4 {
  margin-bottom: 0.8rem;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
}

.radio-group {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  color: #333;
}

.radio-option input[type="radio"] {
  margin: 0;
  transform: scale(1.1);
}

.crawling-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-top: 1rem;
}

.crawling-option {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1.2rem;
  transition: all 0.3s ease;
}

.crawling-option:hover {
  border-color: #667eea;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.option-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.option-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  font-weight: bold;
  border-radius: 50%;
  font-size: 1rem;
}

.option-header h4 {
  margin: 0;
  color: #333;
  font-size: 1.1rem;
}

.option-desc {
  color: #666;
  margin-bottom: 1.2rem;
  line-height: 1.4;
  font-size: 0.9rem;
}

.range-input {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.range-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.range-input span {
  font-weight: bold;
  color: #666;
}

.specific-round-input {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.specific-round-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.btn-primary, .btn-secondary {
  width: 100%;
  padding: 0.8rem 1.2rem;
  border: none;
  border-radius: 0.4rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.specific-round-input .btn-secondary {
  width: auto;
  padding: 0.5rem 1rem;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.info-item {
  text-align: center;
  padding: 2rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
}

.info-item h4 {
  margin: 0 0 0.5rem 0;
  color: #666;
  font-size: 1rem;
}

.info-item p {
  margin: 0;
  font-size: 2rem;
  font-weight: bold;
  color: #333;
}

/* Progress Card Styles */
.progress-card {
  background: #fff;
  margin-bottom: 1.5rem;
}

.progress-card .card-header h3 {
  margin: 0;
  font-size: 1.3rem;
  color: #333;
}

/* Progress Status Styles */
.progress-status {
  text-align: center;
  margin-bottom: 1rem;
}

.status-text {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.5rem;
}

.operation-type {
  font-size: 1rem;
  color: #666;
  font-weight: 500;
}

.progress-details {
  margin-top: 1.5rem;
}

.progress-bar-container {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.progress-bar {
  flex: 1;
  height: 20px;
  background: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 10px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-text {
  font-weight: bold;
  color: #333;
  min-width: 50px;
}

.round-info, .time-info {
  display: flex;
  justify-content: space-between;
  margin: 0.5rem 0;
  font-size: 0.9rem;
  color: #666;
}

.round-info span, .time-info span {
  font-weight: 500;
}

.progress-status {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: center;
}

.btn-stop {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
}

.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

@media (max-width: 768px) {
  .crawling-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .radio-group {
    flex-direction: column;
    gap: 0.8rem;
  }

  .crawling-option {
    padding: 1rem;
  }

  .info-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .range-input {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .specific-round-input {
    flex-direction: column;
    gap: 0.5rem;
  }

  .specific-round-input .btn-secondary {
    width: 100%;
  }

  .crawling-type-selector {
    padding: 0.8rem;
  }

  .progress-card .card-header h3 {
    font-size: 1.2rem;
  }

  .status-text {
    font-size: 1.3rem;
  }
}

/* ë°ì´í„° ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
.btn-detail {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.4rem;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-detail:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.detail-panel {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border: 2px solid #e9ecef;
  border-radius: 0.8rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e9ecef;
}

.detail-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.2rem;
}

.btn-close {
  background: #dc3545;
  color: white;
  border: none;
  padding: 0.3rem 0.8rem;
  border-radius: 0.4rem;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-close:hover {
  background: #c82333;
  transform: scale(1.1);
}

.detail-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #e9ecef;
}

.tab-btn {
  background: none;
  border: none;
  padding: 0.8rem 1.5rem;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
}

.tab-btn.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.tab-btn:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.detail-content {
  min-height: 400px;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.loading-indicator {
  text-align: center;
  padding: 2rem;
  color: #666;
  font-style: italic;
}

.round-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 0.5rem;
  margin-top: 1rem;
  max-height: 400px;
  overflow-y: auto;
  padding: 0.5rem;
  border: 1px solid #e9ecef;
  border-radius: 0.5rem;
}

.round-item {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.4rem;
  padding: 0.5rem;
  text-align: center;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.round-item.missing {
  background: #fff5f5;
  border-color: #fed7d7;
  color: #c53030;
}

.round-item.existing {
  background: #f0fff4;
  border-color: #c6f6d5;
  color: #25543e;
}

.round-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.stat-card {
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border: 2px solid #e9ecef;
  border-radius: 0.8rem;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-card:hover {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #667eea;
  margin-bottom: 0.5rem;
}

.stat-label {
  color: #666;
  font-weight: 600;
}

.range-display {
  margin-bottom: 1rem;
  padding: 1rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border-radius: 0.8rem;
  text-align: center;
  font-weight: 600;
}

@media (max-width: 768px) {
  .detail-tabs {
    flex-direction: column;
    gap: 0;
  }
  
  .tab-btn {
    border-bottom: none;
    border-right: 3px solid transparent;
  }
  
  .tab-btn.active {
    border-right-color: #667eea;
    border-bottom-color: transparent;
  }
  
  .round-list {
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 0.3rem;
  }
  
  .summary-stats {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
let progressInterval;
let lastUpdateTime = 0;

function formatTime(seconds) {
  if (seconds < 60) return `${seconds}ì´ˆ`;
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
}

function getCrawlingType() {
  const checkedRadio = document.querySelector('input[name="crawling-type"]:checked');
  return checkedRadio ? checkedRadio.value : 'both';
}

function startCrawling(type) {
  const crawlingType = getCrawlingType();
  const url = `/update-${type}`;

  // í¬ë¡¤ë§ ì‹œì‘ ì „ UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  const statusText = document.getElementById('status-text');
  const operationType = document.getElementById('operation-type');
  const stopBtn = document.getElementById('stop-btn');

  statusText.textContent = 'ì‹œì‘ì¤‘...';
  let operationTypeText = '';
  switch(type) {
    case 'full': operationTypeText = '[ì „ì²´ í¬ë¡¤ë§]'; break;
    case 'missing': operationTypeText = '[ë¹ ì§„íšŒì°¨ í¬ë¡¤ë§]'; break;
    case 'latest': operationTypeText = '[ìµœì‹ íšŒì°¨ í¬ë¡¤ë§]'; break;
  }
  operationType.textContent = operationTypeText;

  // ì¦‰ì‹œ ì§„í–‰ ëª¨ë‹ˆí„°ë§ ì‹œì‘
  startProgressMonitoring();

  const formData = new FormData();
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch(url, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`ì˜¤ë¥˜: ${data.error}`);
      // ì˜¤ë¥˜ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
      statusText.textContent = 'ëŒ€ê¸°ì¤‘';
      operationType.textContent = '';
      stopProgressMonitoring();
    }
  })
  .catch(error => {
    console.error('Crawling error:', error);
    // ì—ëŸ¬ ë°œìƒí•´ë„ ëª¨ë‹ˆí„°ë§ ê³„ì† (ì„œë²„ì—ì„œ í¬ë¡¤ë§ì´ ì‹œì‘ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
  });
}

function startRangeCrawling() {
  const startRound = document.getElementById('startRound').value;
  const endRound = document.getElementById('endRound').value;
  const crawlingType = getCrawlingType();

  if (!startRound || !endRound) {
    alert('ì‹œì‘ íšŒì°¨ì™€ ë íšŒì°¨ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (parseInt(startRound) > parseInt(endRound)) {
    alert('ì‹œì‘ íšŒì°¨ê°€ ë íšŒì°¨ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const formData = new FormData();
  formData.append('start', startRound);
  formData.append('end', endRound);
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch('/update-range', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`ì˜¤ë¥˜: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Range crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function startSpecificCrawling() {
  const round = document.getElementById('specificRound').value;
  const crawlingType = getCrawlingType();

  if (!round) {
    alert('íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const formData = new FormData();
  formData.append('round', round);
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch('/update', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`ì˜¤ë¥˜: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Specific crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function updateProgress() {
  const currentTime = Date.now();

  // ë„ˆë¬´ ë¹ˆë²ˆí•œ ì—…ë°ì´íŠ¸ ë°©ì§€ (ìµœì†Œ 500ms ê°„ê²©)
  if (currentTime - lastUpdateTime < 500) {
    return;
  }

  lastUpdateTime = currentTime;

  fetch('/api/crawling-progress')
    .then(response => response.json())
    .then(data => {
      const statusText = document.getElementById('status-text');
      const operationType = document.getElementById('operation-type');
      const progressDetails = document.getElementById('progress-details');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const currentRoundInfo = document.getElementById('current-round-info');
      const totalRoundsInfo = document.getElementById('total-rounds-info');
      const elapsedTime = document.getElementById('elapsed-time');
      const remainingTime = document.getElementById('remaining-time');

      // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì„ ë°©ì§€)
      if (statusText.textContent !== data.status) {
        statusText.textContent = data.status;
      }

      const operationText = data.operation_type ? `[${data.operation_type}]` : '';
      if (operationType.textContent !== operationText) {
        operationType.textContent = operationText;
      }

      if (data.is_running) {
        // ì§„í–‰ ìƒí™© í‘œì‹œ
        progressDetails.style.display = 'block';

        // ì¤‘ì§€ ë²„íŠ¼ í‘œì‹œ
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.style.display = 'block';

        // ì§„í–‰ë¥  ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        const percentage = data.total_rounds > 0 ?
          Math.round((data.completed_rounds / data.total_rounds) * 100) : 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;

        // íšŒì°¨ ì •ë³´ ì—…ë°ì´íŠ¸
        currentRoundInfo.textContent = `í˜„ì¬: ${data.current_round}íšŒ`;
        totalRoundsInfo.textContent = `ì „ì²´: ${data.total_rounds}íšŒ (ì™„ë£Œ: ${data.completed_rounds})`;

        // ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.elapsed_seconds) {
          elapsedTime.textContent = `ê²½ê³¼: ${formatTime(data.elapsed_seconds)}`;
        }

        if (data.estimated_remaining_seconds && data.estimated_remaining_seconds > 0) {
          remainingTime.textContent = `ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ${formatTime(data.estimated_remaining_seconds)}`;
          remainingTime.style.display = 'inline';
        } else {
          remainingTime.style.display = 'none';
        }
      } else {
        // í¬ë¡¤ë§ ì™„ë£Œ ë˜ëŠ” ëŒ€ê¸° ìƒíƒœ
        if (data.status !== 'ëŒ€ê¸°ì¤‘') {
          // ì™„ë£Œ ìƒíƒœ ì ì‹œ í‘œì‹œ í›„ ìˆ¨ê¹€
          setTimeout(() => {
            if (!document.querySelector('#status-text').textContent.includes('ì§„í–‰ì¤‘')) {
              progressDetails.style.display = 'none';
            }
          }, 3000);
        } else {
          progressDetails.style.display = 'none';
        }

        // ì¤‘ì§€ ë²„íŠ¼ ìˆ¨ê¹€
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.style.display = 'none';

        // í¬ë¡¤ë§ ì™„ë£Œì‹œ ì§„í–‰ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        if (data.status.includes('ì™„ë£Œ') || data.status === 'ëŒ€ê¸°ì¤‘') {
          stopProgressMonitoring();
        }
      }
    })
    .catch(error => {
      console.error('Progress update error:', error);
      // ì—ëŸ¬ ë°œìƒì‹œ ì ì‹œ í›„ ì¬ì‹œë„
      setTimeout(updateProgress, 2000);
    });
}

function startProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }

  // ì¦‰ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
  updateProgress();

  // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (1ì´ˆ ê°„ê²©)
  progressInterval = setInterval(updateProgress, 1000);
}

function stopProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

// í¬ë¡¤ë§ ì¤‘ì§€ í•¨ìˆ˜
function stopCrawling() {
  const confirmed = confirm('ì§„í–‰ ì¤‘ì¸ í¬ë¡¤ë§ì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');

  if (!confirmed) {
    return;
  }

  const stopBtn = document.getElementById('stop-btn');
  stopBtn.disabled = true;
  stopBtn.innerHTML = 'â³ ì¤‘ì§€ì¤‘...';

  fetch('/api/stop-crawling', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'csrf_token=' + encodeURIComponent(window.csrfToken)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ì¤‘ì§€ ì„±ê³µ - UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      document.getElementById('status-text').textContent = 'ì¤‘ì§€ë¨';
      document.getElementById('operation-type').textContent = '';
      stopBtn.style.display = 'none';
      stopProgressMonitoring();

      // 3ì´ˆ í›„ ëŒ€ê¸°ì¤‘ìœ¼ë¡œ ë³€ê²½
      setTimeout(() => {
        document.getElementById('status-text').textContent = 'ëŒ€ê¸°ì¤‘';
        document.getElementById('progress-details').style.display = 'none';
      }, 3000);
    } else {
      alert(`ì¤‘ì§€ ì‹¤íŒ¨: ${data.message}`);
      stopBtn.disabled = false;
      stopBtn.innerHTML = 'â¹ï¸ ì¤‘ì§€';
    }
  })
  .catch(error => {
    console.error('Stop crawling error:', error);
    alert('ì¤‘ì§€ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    stopBtn.disabled = false;
    stopBtn.innerHTML = 'â¹ï¸ ì¤‘ì§€';
  });
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì§„í–‰ ìƒíƒœ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  loadBasicStats();

  // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ëª¨ë‹ˆí„°ë§ ì‹œì‘
  setTimeout(() => {
    const statusText = document.getElementById('status-text').textContent;
    if (statusText.includes('ì§„í–‰ì¤‘') || statusText.includes('ìˆ˜ì§‘ì¤‘')) {
      startProgressMonitoring();
    }
  }, 500);
});

// í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
  stopProgressMonitoring();
});

// ê¸°ë³¸ í†µê³„ ì •ë³´ ë¡œë“œ
async function loadBasicStats() {
  try {
    const response = await fetch('/api/data-stats');
    const data = await response.json();
    
    document.getElementById('missing-count').textContent = `${data.missing_count}íšŒ`;
    document.getElementById('completion-rate').textContent = `${data.completion_rate}%`;
  } catch (error) {
    console.error('Failed to load basic stats:', error);
    document.getElementById('missing-count').textContent = 'ì˜¤ë¥˜';
    document.getElementById('completion-rate').textContent = 'ì˜¤ë¥˜';
  }
}

// ìƒì„¸ ì •ë³´ íŒ¨ë„ í† ê¸€
function toggleDataDetail() {
  const panel = document.getElementById('data-detail-panel');
  
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    loadDetailData();
  } else {
    panel.style.display = 'none';
  }
}

// íƒ­ ì „í™˜
function showDetailTab(tabName) {
  // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // ì„ íƒëœ íƒ­ í™œì„±í™”
  document.querySelector(`button[onclick="showDetailTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // ë°ì´í„° ë¡œë“œ
  loadTabData(tabName);
}

// íƒ­ë³„ ë°ì´í„° ë¡œë“œ
async function loadTabData(tabName) {
  const loadingId = `${tabName}-loading`;
  const contentId = `${tabName}-list`;
  
  document.getElementById(loadingId).style.display = 'block';
  document.getElementById(contentId).style.display = 'none';
  
  try {
    const response = await fetch(`/api/data-detail/${tabName}`);
    const data = await response.json();
    
    document.getElementById(loadingId).style.display = 'none';
    document.getElementById(contentId).style.display = 'block';
    
    switch(tabName) {
      case 'missing':
        renderMissingRounds(data);
        break;
      case 'existing':
        renderExistingRounds(data);
        break;
      case 'summary':
        renderSummaryInfo(data);
        break;
    }
  } catch (error) {
    console.error(`Failed to load ${tabName} data:`, error);
    document.getElementById(loadingId).textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
  }
}

// ì „ì²´ ë°ì´í„° ë¡œë“œ
async function loadDetailData() {
  loadTabData('missing');
}

// ëˆ„ë½ íšŒì°¨ ë Œë”ë§
function renderMissingRounds(data) {
  const container = document.getElementById('missing-list');
  
  if (data.rounds.length === 0) {
    container.innerHTML = '<p class="no-data">ëˆ„ë½ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</p>';
    return;
  }
  
  const rangeDisplay = `<div class="range-display">ëˆ„ë½ íšŒì°¨: ${data.total_missing}ê°œ (${data.range.start}~${data.range.end} ì¤‘)</div>`;
  const roundsList = `<div class="round-list">${data.rounds.map(round => 
    `<div class="round-item missing" onclick="showRoundInfo(${round})">${round}</div>`
  ).join('')}</div>`;
  
  container.innerHTML = rangeDisplay + roundsList;
}

// ì €ì¥ëœ íšŒì°¨ ë Œë”ë§
function renderExistingRounds(data) {
  const container = document.getElementById('existing-list');
  
  const rangeDisplay = `<div class="range-display">ì €ì¥ëœ íšŒì°¨: ${data.total_existing}ê°œ (${data.range.start}~${data.range.end} ì¤‘)</div>`;
  const roundsList = `<div class="round-list">${data.rounds.map(round => 
    `<div class="round-item existing" onclick="showRoundInfo(${round})">${round}</div>`
  ).join('')}</div>`;
  
  container.innerHTML = rangeDisplay + roundsList;
}

// ìš”ì•½ ì •ë³´ ë Œë”ë§
function renderSummaryInfo(data) {
  const container = document.getElementById('summary-info');
  
  const statsHtml = `
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-number">${data.total_existing}</div>
        <div class="stat-label">ì €ì¥ëœ íšŒì°¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${data.total_missing}</div>
        <div class="stat-label">ëˆ„ë½ëœ íšŒì°¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${data.completion_rate}%</div>
        <div class="stat-label">ì™„ì„±ë„</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${data.range.end}</div>
        <div class="stat-label">ìµœì‹  íšŒì°¨</div>
      </div>
    </div>
    <div class="range-display">
      ì „ì²´ ë²”ìœ„: ${data.range.start}íšŒ ~ ${data.range.end}íšŒ
    </div>
  `;
  
  container.innerHTML = statsHtml;
}

// íšŒì°¨ ì •ë³´ í‘œì‹œ (ê°„ë‹¨í•œ ì•Œë¦¼)
function showRoundInfo(round) {
  alert(`${round}íšŒì°¨ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.\n\nì´ ê¸°ëŠ¥ì€ ì¶”í›„ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ë¡œ í™•ì¥ ì˜ˆì •ì…ë‹ˆë‹¤.`);
}
</script>
{% endblock %}
