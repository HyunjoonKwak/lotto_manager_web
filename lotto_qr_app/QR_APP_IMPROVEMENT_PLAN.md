# QR 앱 개선 계획

> 로또 용지 QR 인식 데스크톱 앱 개선 로드맵
> 최종 업데이트: 2025-10-04

---

## 📋 목차

1. [현재 상태 분석](#현재-상태-분석)
2. [개선 목표](#개선-목표)
3. [Phase 1: 즉시 개선](#phase-1-즉시-개선)
4. [Phase 2: 핵심 기능 강화](#phase-2-핵심-기능-강화)
5. [Phase 3: 고급 기능](#phase-3-고급-기능)
6. [구현 체크리스트](#구현-체크리스트)

---

## 🔍 현재 상태 분석

### 강점
- ✅ 안정적인 QR 코드 인식 (OpenCV + pyzbar)
- ✅ 다양한 QR 형식 지원 (파이프, URL, JSON, 숫자)
- ✅ 로컬 SQLite DB 기반 중복 방지
- ✅ 서버 전환 기능 (로컬/EC2)
- ✅ Flask 웹앱과 API 통합
- ✅ 로그인/인증 시스템

### 약점 및 개선 필요 영역
- ❌ 한 번에 하나의 이미지만 처리 가능
- ❌ 드래그 앤 드롭 미지원
- ❌ 처리 진행률 표시 불명확
- ❌ 네트워크 오류 시 자동 재시도 부족
- ❌ 키보드 단축키 부재
- ❌ 결과 내보내기 기능 없음
- ❌ 자동 업데이트 체커 없음
- ❌ 설정 UI 부재 (config.py 직접 수정 필요)

---

## 🎯 개선 목표

### 사용성 향상
- 드래그 앤 드롭으로 빠른 파일 선택
- 폴더 선택으로 일괄 처리
- 키보드 단축키로 생산성 향상

### 안정성 강화
- 네트워크 오류 자동 복구
- 이미지 형식 검증
- 로그 파일 저장

### 기능 확장
- 결과 데이터 내보내기
- 통계 및 히스토리 시각화
- 자동 업데이트

---

## Phase 1: 즉시 개선 (Quick Wins)

> 예상 소요 시간: 5-7시간
> 목표: 사용자 경험 즉시 개선

### 1.1 드래그 앤 드롭 지원 ⏱️ 1-2시간

**목표**: 이미지 파일을 창에 드래그하여 바로 처리

**구현 내용**:
- [ ] TkinterDnD2 라이브러리 통합
- [ ] 이미지 영역에 드롭 존 설정
- [ ] 드롭 시 자동 QR 인식 트리거
- [ ] 시각적 피드백 (드래그 오버 시 하이라이트)

**예상 효과**:
- 파일 선택 시간 30% 단축
- UX 만족도 ⭐⭐⭐⭐⭐

**구현 파일**:
- `main.py`: `setup_drag_drop()`, `on_drop()` 메서드 추가

---

### 1.2 프로그레스 바 추가 ⏱️ 1시간

**목표**: 처리 진행 상황을 명확히 표시

**구현 내용**:
- [ ] ttk.Progressbar 위젯 추가
- [ ] 단계별 진행률 표시 (QR 인식 → 파싱 → 업로드)
- [ ] 상태 메시지와 함께 표시

**예상 효과**:
- 사용자 대기 불안감 해소
- 처리 실패 지점 명확화

**구현 파일**:
- `main.py`: 프로그레스 바 UI 추가
- `qr_processor.py`: 진행률 콜백 파라미터 추가

---

### 1.3 키보드 단축키 구현 ⏱️ 1시간

**목표**: 마우스 없이 주요 기능 실행

**구현 내용**:
- [ ] `Ctrl+O`: 파일 열기
- [ ] `Ctrl+Shift+O`: 폴더 열기 (Phase 2)
- [ ] `Ctrl+R`: QR 재인식
- [ ] `Ctrl+U`: 업로드
- [ ] `Ctrl+S`: 결과 저장 (Phase 2)
- [ ] `Ctrl+,`: 설정 (Phase 2)
- [ ] `F5`: 새로고침 (데이터베이스 탭)

**예상 효과**:
- 파워 유저 생산성 50% 향상
- 반복 작업 효율화

**구현 파일**:
- `main.py`: `setup_keyboard_shortcuts()` 메서드 추가

---

### 1.4 자동 재시도 메커니즘 ⏱️ 2-3시간

**목표**: 네트워크 오류 시 자동 재시도 및 실패 큐 관리

**구현 내용**:
- [ ] 지수 백오프 재시도 로직 (1s → 2s → 4s)
- [ ] 실패한 업로드 DB에 저장
- [ ] "실패한 업로드 재시도" 버튼 추가
- [ ] 자동 재시도 설정 (on/off, 최대 횟수)

**예상 효과**:
- 일시적 네트워크 오류 자동 복구
- 데이터 손실 방지

**구현 파일**:
- `api_client.py`: `upload_with_retry()` 메서드
- `database.py`: `save_failed_upload()`, `get_failed_uploads()` 메서드
- `main.py`: 실패 큐 UI 추가

---

## Phase 2: 핵심 기능 강화 (1-2일)

> 예상 소요 시간: 14-18시간
> 목표: 생산성 대폭 향상

### 2.1 일괄 처리 (폴더 선택) ⏱️ 4-6시간

**목표**: 폴더 내 모든 이미지를 한 번에 처리

**구현 내용**:
- [ ] 폴더 선택 대화상자
- [ ] 멀티스레딩 기반 병렬 처리
- [ ] 전체 진행률 표시 (5/20 이미지 처리 중)
- [ ] 처리 결과 요약 (성공 18, 실패 2)
- [ ] 실패한 이미지 목록 표시

**예상 효과**:
- 대량 스캔 시 80% 시간 절감
- 사용자 만족도 ⭐⭐⭐⭐⭐

**구현 파일**:
- `main.py`: `select_folder()`, `batch_process_images()` 메서드

---

### 2.2 결과 내보내기 (CSV/JSON) ⏱️ 2-3시간

**목표**: 인식 결과를 파일로 저장

**구현 내용**:
- [ ] CSV 내보내기 (회차, 게임번호, 번호 1-6, 인식일시)
- [ ] JSON 내보내기 (전체 메타데이터 포함)
- [ ] 내보내기 범위 선택 (전체 / 특정 회차 / 날짜 범위)
- [ ] 내보내기 버튼 추가 (데이터베이스 탭)

**예상 효과**:
- 외부 도구로 데이터 분석 가능
- 백업 및 공유 용이

**구현 파일**:
- `database.py`: `export_to_csv()`, `export_to_json()` 메서드
- `main.py`: 내보내기 UI 추가

---

### 2.3 자동 업데이트 체커 ⏱️ 3-4시간

**목표**: 새 버전 출시 시 자동 알림

**구현 내용**:
- [ ] 앱 버전 정보 추가 (config.py)
- [ ] 웹앱에 버전 API 추가 (`/api/qr-app/version`)
- [ ] 시작 시 버전 체크
- [ ] 업데이트 알림 대화상자
- [ ] 다운로드 링크 제공

**예상 효과**:
- 사용자가 항상 최신 버전 사용
- 버그 수정 빠른 배포

**구현 파일**:
- `config.py`: `APP_VERSION = "1.1.0"` 추가
- `main.py`: `check_for_updates()` 메서드
- `app/routes.py` (웹앱): `/api/qr-app/version` 엔드포인트

---

### 2.4 설정 UI ⏱️ 4-5시간

**목표**: config.py 수정 없이 GUI로 설정 변경

**구현 내용**:
- [ ] 설정 창 생성 (Toplevel)
- [ ] 서버 설정 (URL, 타임아웃)
- [ ] Tesseract 경로 설정
- [ ] 재시도 설정 (활성화, 최대 횟수)
- [ ] 로그 설정 (파일 저장 여부, 로그 레벨)
- [ ] 설정을 JSON 파일로 저장 (`~/.lotto_qr_settings.json`)

**예상 효과**:
- 비개발자도 쉽게 설정 변경
- 환경별 설정 관리 용이

**구현 파일**:
- `main.py`: `open_settings()`, `save_settings()` 메서드
- `config.py`: `load_settings_from_file()` 함수

---

## Phase 3: 고급 기능 (2-3일)

> 예상 소요 시간: 15-20시간
> 목표: 프로페셔널 앱으로 진화

### 3.1 통계 대시보드 ⏱️ 6-8시간 ✅ **완료**

**목표**: 스캔 히스토리 시각화

**구현 내용**:
- [x] 새 탭: "📊 통계" 추가
- [x] 일별 스캔 횟수 그래프 (matplotlib)
- [x] 회차별 스캔 분포 (최근 20개)
- [x] 업로드 성공률 (파이 차트)
- [x] 시간대별 스캔 분포 (0-23시)
- [x] 기간별 필터링 (시작일/종료일 입력 + 전체 버튼)

**예상 효과**:
- 사용 패턴 파악
- 데이터 품질 모니터링

**구현 파일**:
- `main.py`: `setup_statistics_tab()`, `refresh_statistics()`, `update_*_chart()` 메서드
- `database.py`: `get_statistics_for_visualization()` 메서드
- `requirements.txt`: `matplotlib>=3.7.0` 추가

**구현 결과** (2025-10-04):
- matplotlib를 사용한 4개 차트 탭 구현
  - 일별 스캔: 선 그래프 (날짜별 추이)
  - 회차 분포: 막대 그래프 (최근 20개 회차)
  - 업로드 현황: 파이 차트 (성공/실패/대기)
  - 시간대 분포: 막대 그래프 (0-23시)
- 날짜 범위 필터링 기능 (기본: 최근 30일)
- "전체" 버튼으로 전체 기간 통계 조회 가능
- 데이터 없을 경우 "데이터가 없습니다" 메시지 표시

---

### 3.2 로그 파일 저장 ⏱️ 2시간 ✅ **완료**

**목표**: 앱 종료 후에도 로그 보존

**구현 내용**:
- [x] 로그를 파일로 저장 (`~/.lotto_qr_logs/log_YYYYMMDD.txt`)
- [x] 자동 저장 (버퍼 50개마다, 앱 종료 시)
- [x] 수동 저장 (로그 우클릭 메뉴)
- [x] 날짜별 로그 파일 생성

**예상 효과**:
- 문제 해결 용이
- 버그 리포트 품질 향상

**구현 파일**:
- `main.py`: `log()`, `save_log_to_file()`, `export_log_to_file()`, `on_closing()` 메서드

**구현 결과** (2025-10-04):
- 로그 버퍼를 통한 자동 저장 (50개 단위)
- 앱 종료 시 남은 로그 자동 저장
- 로그 컨텍스트 메뉴에 "로그 파일로 저장" 추가
- 파일 저장 대화상자로 수동 내보내기 지원
- 로그 파일 경로를 앱 시작 시 표시
- 홈 디렉토리 `.lotto_qr_logs/` 폴더에 날짜별 저장

---

### 3.3 다크 모드 ⏱️ 3-4시간

**목표**: 눈의 피로 감소

**구현 내용**:
- [ ] 시스템 테마 감지 (darkdetect 라이브러리)
- [ ] 라이트/다크 테마 정의
- [ ] 테마 전환 버튼
- [ ] 설정에 테마 저장

**예상 효과**:
- 야간 사용 편의성 향상
- 모던한 UX

**구현 파일**:
- `main.py`: `apply_theme()` 메서드
- `requirements.txt`: `darkdetect` 추가

---

### 3.4 멀티스레딩 최적화 ⏱️ 4-6시간

**목표**: 대용량 이미지 처리 속도 향상

**구현 내용**:
- [ ] QR 인식을 별도 스레드에서 실행 (이미 구현됨)
- [ ] 일괄 처리 시 ThreadPoolExecutor 사용
- [ ] 진행률을 메인 스레드로 안전하게 전달
- [ ] 취소 버튼 추가 (처리 중단)

**예상 효과**:
- 일괄 처리 시 3-5배 속도 향상
- UI 응답성 유지

**구현 파일**:
- `main.py`: `batch_process_images()` 개선

---

## 📝 구현 체크리스트

### Phase 1: 즉시 개선 (5-7시간)

#### 1.1 드래그 앤 드롭 지원
- [ ] TkinterDnD2 라이브러리 설치
- [ ] `requirements.txt`에 `tkinterdnd2` 추가
- [ ] `main.py`에 `setup_drag_drop()` 메서드 구현
- [ ] `on_drop()` 이벤트 핸들러 구현
- [ ] 드롭 존 시각적 피드백 추가
- [ ] 테스트: 이미지 파일 드래그하여 처리 확인

#### 1.2 프로그레스 바 추가
- [ ] `main.py`에 `ttk.Progressbar` 위젯 추가
- [ ] `self.progress_var` 변수 생성
- [ ] QR 인식 단계별 진행률 업데이트
- [ ] 업로드 단계에서 진행률 표시
- [ ] 완료 시 프로그레스 바 초기화
- [ ] 테스트: 처리 중 진행률 표시 확인

#### 1.3 키보드 단축키 구현
- [ ] `main.py`에 `setup_keyboard_shortcuts()` 메서드 구현
- [ ] `Ctrl+O` → `select_file()` 바인딩
- [ ] `Ctrl+R` → `process_qr()` 바인딩
- [ ] `Ctrl+U` → `upload_data()` 바인딩
- [ ] `F5` → `refresh_database_tab()` 바인딩
- [ ] 단축키 안내 메뉴/도움말 추가
- [ ] 테스트: 모든 단축키 동작 확인

#### 1.4 자동 재시도 메커니즘
- [ ] `api_client.py`에 `upload_with_retry()` 메서드 구현
- [ ] 지수 백오프 로직 추가 (1s → 2s → 4s)
- [ ] `database.py`에 `save_failed_upload()` 메서드 추가
- [ ] `database.py`에 `get_failed_uploads()` 메서드 추가
- [ ] `main.py`에 "실패한 업로드 재시도" 버튼 추가
- [ ] 실패 큐 UI 구현 (데이터베이스 탭)
- [ ] 테스트: 네트워크 끊고 재시도 확인

---

### Phase 2: 핵심 기능 강화 (14-18시간)

#### 2.1 일괄 처리
- [ ] `main.py`에 폴더 선택 버튼 추가
- [ ] `select_folder()` 메서드 구현
- [ ] `batch_process_images()` 메서드 구현
- [ ] 전체 진행률 표시 (5/20 이미지)
- [ ] 처리 결과 요약 다이얼로그
- [ ] 실패한 이미지 목록 표시
- [ ] 테스트: 10개 이미지 일괄 처리

#### 2.2 결과 내보내기
- [ ] `database.py`에 `export_to_csv()` 메서드 구현
- [ ] `database.py`에 `export_to_json()` 메서드 구현
- [ ] 데이터베이스 탭에 "내보내기" 버튼 추가
- [ ] 내보내기 범위 선택 UI
- [ ] 파일 저장 대화상자
- [ ] 테스트: CSV/JSON 파일 생성 확인

#### 2.3 자동 업데이트 체커
- [ ] `config.py`에 `APP_VERSION` 추가
- [ ] 웹앱에 `/api/qr-app/version` 엔드포인트 추가
- [ ] `main.py`에 `check_for_updates()` 메서드 구현
- [ ] 시작 시 자동 체크 (백그라운드)
- [ ] 업데이트 알림 대화상자
- [ ] "나중에 알림" 옵션
- [ ] 테스트: 버전 불일치 시 알림 확인

#### 2.4 설정 UI
- [ ] `main.py`에 설정 메뉴 추가
- [ ] `open_settings()` 메서드로 설정 창 구현
- [ ] 서버 설정 UI
- [ ] Tesseract 경로 설정 UI
- [ ] 재시도 설정 UI
- [ ] `save_settings()` 메서드로 JSON 저장
- [ ] `config.py`에 `load_settings_from_file()` 구현
- [ ] 테스트: 설정 변경 후 재시작 시 유지 확인

---

### Phase 3: 고급 기능 (15-20시간)

#### 3.1 통계 대시보드
- [ ] `requirements.txt`에 `matplotlib` 추가
- [ ] `main.py`에 "통계" 탭 추가
- [ ] `database.py`에 `get_statistics_data()` 메서드 구현
- [ ] 일별 스캔 횟수 그래프
- [ ] 회차별 스캔 분포 그래프
- [ ] 업로드 성공률 파이 차트
- [ ] 기간별 필터링 UI
- [ ] 테스트: 그래프 렌더링 확인

#### 3.2 로그 파일 저장
- [ ] `main.py`에 `setup_logging()` 메서드 구현
- [ ] 로그 디렉토리 생성 (`~/.lotto_qr_app/logs/`)
- [ ] 회전 로그 설정 (최대 10개)
- [ ] 로그 레벨 설정 옵션
- [ ] 로그 탭에 파일 뷰어 추가
- [ ] 테스트: 로그 파일 생성 확인

#### 3.3 다크 모드
- [ ] `requirements.txt`에 `darkdetect` 추가
- [ ] 라이트/다크 테마 색상 정의
- [ ] `apply_theme()` 메서드 구현
- [ ] 테마 전환 버튼 추가
- [ ] 시스템 테마 자동 감지
- [ ] 테스트: 테마 전환 확인

#### 3.4 멀티스레딩 최적화
- [ ] `ThreadPoolExecutor` 통합
- [ ] 일괄 처리 병렬화
- [ ] 진행률 스레드 안전성 확보
- [ ] 취소 버튼 구현
- [ ] 메모리 누수 점검
- [ ] 테스트: 50개 이미지 동시 처리

---

## 📈 진행 상황 추적

### Phase 1 (목표: 2025-10-04) ✅ 완료
- [x] 개선 계획 문서 작성 (100%)
- [x] 1.1 드래그 앤 드롭 (100%)
- [x] 1.2 프로그레스 바 (100%)
- [x] 1.3 키보드 단축키 (100%)
- [x] 1.4 자동 재시도 (100%)

### Phase 2 (목표: 2025-10-06) ✅ 완료
- [x] 2.1 일괄 처리 (100%)
- [x] 2.2 결과 내보내기 (100%)
- [x] 2.3 자동 업데이트 (100%)
- [x] 2.4 설정 UI (100% - 간소화 버전)

### Phase 3 (목표: 2025-10-09)
- [ ] 3.1 통계 대시보드 (0%)
- [ ] 3.2 로그 파일 (0%)
- [ ] 3.3 다크 모드 (0%)
- [ ] 3.4 멀티스레딩 (0%)

---

## 🔗 참고 자료

### 사용 라이브러리
- **Tkinter**: GUI 프레임워크
- **TkinterDnD2**: 드래그 앤 드롭 지원
- **OpenCV**: 이미지 처리
- **pyzbar**: QR 코드 디코딩
- **Pillow**: 이미지 로딩
- **requests**: HTTP 통신
- **matplotlib**: 그래프 시각화
- **darkdetect**: 시스템 테마 감지

### 관련 파일
- `lotto_qr_app/main.py`: 메인 GUI
- `lotto_qr_app/qr_processor.py`: QR 처리 로직
- `lotto_qr_app/api_client.py`: API 통신
- `lotto_qr_app/database.py`: 로컬 DB 관리
- `lotto_qr_app/config.py`: 설정
- `app/routes.py`: 웹앱 API 엔드포인트

---

## 📝 변경 이력

### 2025-10-04
- 초기 개선 계획 문서 작성
- Phase 1-3 정의 및 체크리스트 생성
- **Phase 1 완료**: 드래그 앤 드롭, 프로그레스 바, 키보드 단축키, 자동 재시도 구현
- **Phase 2 완료**: 일괄 처리, CSV/JSON 내보내기, 자동 업데이트 체커, 설정 관리
- **Phase 3.1 완료**: 통계 대시보드 (matplotlib 기반 4개 차트)
- **Phase 3.2 완료**: 로그 파일 저장 (자동/수동 저장)

#### Phase 1 구현 내용
- **1.1 드래그 앤 드롭**:
  - `tkinterdnd2` 라이브러리 통합
  - 이미지 레이블에 드롭 존 설정
  - 드래그 진입/떠남 시 시각적 피드백
  - 파일 형식 검증 및 자동 QR 인식

- **1.2 프로그레스 바**:
  - `ttk.Progressbar` 위젯 추가
  - QR 인식 단계별 진행률 표시 (20% → 60% → 100%)
  - `update_progress()` 메서드로 통합 관리

- **1.3 키보드 단축키**:
  - `Ctrl+O` / `Cmd+O`: 파일 열기
  - `Ctrl+Shift+O` / `Cmd+Shift+O`: 폴더 열기
  - `Ctrl+R` / `Cmd+R`: QR 재인식
  - `Ctrl+U` / `Cmd+U`: 데이터 업로드
  - `Ctrl+S` / `Cmd+S`: 데이터 내보내기
  - `Ctrl+T` / `Cmd+T`: 연결 테스트
  - `F5`: 데이터베이스 새로고침

- **1.4 자동 재시도**:
  - `upload_with_retry()` 메서드 구현
  - 지수 백오프 재시도 로직 (1s → 2s → 4s)
  - 실패한 업로드 DB 저장 (`database.py`: `save_failed_upload()`, `get_failed_uploads()`)
  - 중복 데이터는 재시도 제외

#### Phase 2 구현 내용
- **2.1 일괄 처리**:
  - 폴더 선택 버튼 추가 ("폴더 일괄처리")
  - `select_folder()` 메서드로 폴더 선택
  - `batch_process_images()` 메서드로 멀티스레딩 처리
  - 진행률 실시간 표시 (파일명 + 진행도)
  - 처리 결과 요약 다이얼로그 (성공/스킵/실패 통계)
  - 실패한 파일 목록 표시 (최대 5개)

- **2.2 결과 내보내기**:
  - `database.py`에 `export_to_csv()`, `export_to_json()` 메서드 추가
  - 데이터베이스 탭에 "📤 내보내기" 버튼 추가
  - 내보내기 다이얼로그 (형식 선택: CSV/JSON)
  - 범위 선택 (전체/선택한 회차)
  - CSV: 엑셀 호환 형식, UTF-8 BOM
  - JSON: 전체 메타데이터 포함

- **2.3 자동 업데이트 체커**:
  - `config.py`에 `APP_VERSION = "1.1.0"` 추가
  - 웹앱에 `/api/qr-app/version` API 엔드포인트 추가
  - 앱 시작 시 백그라운드에서 버전 체크
  - 업데이트 가능 시 알림 다이얼로그

- **2.4 설정 UI** (간소화 버전):
  - 서버 전환 기능은 기존 UI 활용
  - 설정은 `~/.lotto_qr_settings.json`에 자동 저장
  - 향후 Phase 3에서 전체 설정 UI 구현 예정

#### Phase 3 구현 내용 (부분 완료)
- **3.1 통계 대시보드**:
  - `matplotlib` 라이브러리 추가 (`requirements.txt`)
  - "📊 통계" 탭 추가 (4개 차트 탭)
  - 일별 스캔 횟수: 선 그래프로 날짜별 추이 표시
  - 회차 분포: 막대 그래프로 최근 20개 회차 스캔 횟수
  - 업로드 현황: 파이 차트로 성공/실패/대기 비율
  - 시간대 분포: 막대 그래프로 0-23시 스캔 패턴
  - 기간 필터링: 시작일/종료일 입력 + "전체" 버튼
  - `database.py`에 `get_statistics_for_visualization()` 메서드 추가
  - 6개 통계 데이터 제공: daily_scans, round_distribution, upload_stats, hourly_distribution, format_distribution, top_rounds

- **3.2 로그 파일 저장**:
  - 로그 버퍼 시스템 구현 (50개 단위 자동 저장)
  - `~/.lotto_qr_logs/log_YYYYMMDD.txt` 형식으로 날짜별 저장
  - `save_log_to_file()`: 버퍼 내용을 파일에 쓰기
  - `export_log_to_file()`: 수동 저장 (파일 다이얼로그)
  - `on_closing()`: 앱 종료 시 남은 로그 자동 저장
  - 로그 컨텍스트 메뉴에 "로그 파일로 저장" 추가
  - 앱 시작 시 로그 파일 경로 표시
  - 버전 업데이트: `1.1.0` → `1.2.0`

**남은 Phase 3 항목**:
- 3.3 다크 모드 (선택 사항)
- 3.4 멀티스레딩 최적화 (이미 부분적으로 구현됨)
