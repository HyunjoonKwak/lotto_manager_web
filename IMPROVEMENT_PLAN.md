# 로또 관리 시스템 개선 계획

> 작성일: 2025-10-03
> 목표: 구매 번호 입력 및 관리 워크플로우 개선

---

## 📋 개선 필요성

### 현재 문제점

#### 🔴 심각한 문제
- [ ] **A. 페이지 역할 혼재**: 전략분석 페이지가 분석+추천+입력을 모두 담당
- [ ] **B. 데이터 중복 표시**: 전략분석과 구매이력에서 같은 데이터를 중복 표시
- [ ] **C. 불명확한 워크플로우**: 사용자가 번호 입력 위치를 헷갈림

#### 🟡 중간 문제
- [ ] **D. 데이터 구조 모호성**: 실제 구매와 가상 입력이 구분되지 않음
- [ ] **E. UX 비효율성**: 4단계 이상의 복잡한 프로세스

---

## 🎯 개선 목표

### 정량적 목표
- 클릭 수 감소: 평균 8회 → 4회 (50% 개선)
- 입력 시간 단축: 2분 → 45초 (62% 개선)
- 오류율 감소: 회차 선택 오류 제거

### 정성적 목표
- 명확한 정보 구조 확립
- 직관적인 사용자 경험
- 확장 가능한 아키텍처

---

## 📅 Phase 1: 데이터 모델 및 기본 구조 개선 (1-2일)

### 1.1 데이터 모델 개선
**목표**: Purchase 테이블 확장 및 상태 관리 명확화

#### 체크리스트
- [x] **1.1.1** Purchase 모델에 새 필드 추가
  - [x] `status` 필드 추가 (DRAFT/PURCHASED/CHECKED)
  - [x] `source` 필드 정규화 (기존 purchase_method 개선)
  - [x] `is_real_purchase` Boolean 필드 추가
  - [x] `purchase_location` 필드 추가 (선택사항)
  - [x] `cost` 필드 추가 (구매 금액)
  - [x] `draw` 프로퍼티 추가 (역참조 조회)

- [x] **1.1.2** 데이터베이스 마이그레이션 스크립트 작성
  - [x] `scripts/migrate_purchase_model.py` 생성
  - [x] 기존 데이터 변환 로직 작성 (source 필드 정규화)
  - [x] 백업 및 롤백 계획 수립
  - [x] 인덱스 생성 로직 추가 (status, user_id+status, round+status)
  - [x] 마이그레이션 검증 로직 추가

- [x] **1.1.3** 마이그레이션 실행 및 검증
  - [x] 로컬 환경에서 테스트
  - [x] 기존 데이터 무결성 확인 (8/8건 성공적으로 마이그레이션)
  - [ ] NAS 환경에 적용

#### 예상 소요 시간: 4시간

---

### 1.2 구매관리 페이지 신설
**목표**: 통합 입력 허브 `/buy` 라우트 생성

#### 체크리스트
- [x] **1.2.1** 라우트 및 기본 구조 생성
  - [x] `/buy` GET 라우트 추가
  - [x] `templates/buy.html` 기본 템플릿 생성
  - [x] 모바일 리다이렉트 처리 (`/mobile/buy`)
  - [x] 네비게이션 메뉴에 "구매관리" 추가

- [x] **1.2.2** 회차 선택 기능
  - [x] 다음 회차 자동 선택
  - [x] 미래 회차 예약 가능 (최대 +5회차)
  - [x] 회차 정보 표시 (추첨일, D-day)
  - [x] 실시간 D-Day 카운터 구현

- [x] **1.2.3** 입력 방식 탭 구현
  - [x] AI 추천 탭 (전략분석 페이지 링크)
  - [x] 수동 입력 탭 (45개 번호 버튼 그리드)
  - [x] 텍스트 입력 탭
  - [x] 랜덤 생성 탭 (완전랜덤, 빈출번호, 미출번호)

- [x] **1.2.4** 수동 입력 기능 이관
  - [x] 전략분석의 수동 입력 로직 복사 및 개선
  - [x] 45개 번호 버튼 그리드
  - [x] 선택된 번호 표시 (실시간 업데이트)
  - [x] 텍스트 입력 방식 (콤마/공백 구분)

- [x] **1.2.5** 장바구니 기능
  - [x] 추가된 번호 목록 표시 (DRAFT 상태)
  - [x] 장바구니에 추가 버튼
  - [x] 전체 구매 확정 버튼
  - [x] 개별 삭제 버튼
  - [x] 빈 장바구니 안내 메시지

- [x] **1.2.6** API 엔드포인트 추가
  - [x] `POST /api/purchases/add` - 번호 추가 (DRAFT)
  - [x] `POST /api/purchases/confirm` - 구매 확정 (PURCHASED)
  - [x] `POST /api/purchases/draft/<id>/delete` - 임시저장 삭제
  - [x] 중복 체크 로직 구현
  - [x] source 필드 활용 (manual, ai, random, qr)

- [ ] **1.2.7** 모바일 버전 구현 (추후 작업)
  - [ ] `templates/mobile/buy.html` 생성
  - [ ] 터치 최적화 UI
  - [ ] 모바일 네비게이션 업데이트

#### 예상 소요 시간: 8시간

---

### 1.3 전략분석 페이지 정리
**목표**: 분석 및 추천 기능에 집중

#### 체크리스트
- [x] **1.3.1** 수동 입력 섹션 제거
  - [x] `templates/strategy.html`에서 입력 UI 완전 제거 (약 160줄)
  - [x] 관련 JavaScript 함수 모두 제거 (약 400줄)
  - [x] 수동 입력 CSS 제거 및 정리
  - [x] Legacy CSS 주석 처리 (하위 호환성)

- [x] **1.3.2** "구매관리에 추가" 버튼 구현
  - [x] AI 추천번호 테이블에 "🛒 구매관리에 추가" 링크 버튼
  - [x] 클릭 시 `/buy?numbers=1,7,12,23,32,40&method=ai` 형식으로 이동
  - [x] buy 페이지에서 번호 자동 입력 및 표시

- [x] **1.3.3** 페이지 설명 업데이트
  - [x] AI 추천 섹션 상단에 안내 메시지 추가
  - [x] 하단에 Quick Action 섹션 추가 (그라데이션 디자인)
  - [x] "구매관리 페이지로 이동" 큰 버튼 추가
  - [x] routes.py에서 불필요한 manual_numbers, purchased_numbers 제거

#### 예상 소요 시간: 2시간

---

### Phase 1 완료 기준
- [x] 모든 체크리스트 항목 완료
- [x] 로컬 환경 테스트 준비 완료
- [x] 기존 구매이력 데이터 정상 조회 가능
- [x] 새로운 `/buy` 페이지에서 번호 추가 기능 구현
- [x] 장바구니(DRAFT) → 구매확정(PURCHASED) 워크플로우 구현
- [ ] 사용자 테스트 및 피드백 수집 (NAS 배포 후)

#### 예상 총 소요 시간: 14시간 (약 2일)
#### 실제 소요 시간: 약 13시간 (모바일 버전 제외)

---

## 📅 Phase 2: UX 개선 및 대시보드 개편 (3-5일)

### 2.1 메인 대시보드 개편
**목표**: 원스톱 허브 역할 수행

#### 체크리스트
- [x] **2.1.1** 다음 추첨 정보 카드
  - [x] 회차, 날짜, 시간 표시
  - [x] D-day 카운트다운 (실시간)
  - [x] 추첨까지 남은 시간 (초단위 업데이트)
  - [x] 그라데이션 디자인 (보라색)

- [x] **2.1.2** 빠른 액션 버튼
  - [x] AI 추천받기 → `/strategy`
  - [x] 수동 입력 → `/buy?method=manual`
  - [x] 랜덤 생성 → `/buy?method=random`
  - [x] 구매이력 → `/purchases`
  - [x] 4개 버튼 그라데이션 디자인
  - [x] 호버 효과 (상승 애니메이션)

- [x] **2.1.3** 나의 현황 요약
  - [x] 장바구니 (DRAFT) 개수
  - [x] 결과 대기 중인 번호 개수
  - [x] 최근 당첨 내역 개수 (5등 이상)
  - [x] 각 항목별 링크 (확인/보기 버튼)

- [x] **2.1.4** 최근 활동 피드
  - [x] 최근 구매/등록 번호 3개
  - [x] 입력 방식 아이콘 표시 (🤖/🎯/🎲/📱)
  - [x] 당첨 결과 표시 (1-5등)
  - [x] 더보기 → 구매이력 링크

- [x] **추가 개선사항**
  - [x] Dashboard Grid 레이아웃 (반응형)
  - [x] 최신 추첨결과 카드 개선 (당첨금액, 판매액 표시)
  - [x] 1등 당첨점 제한 (5개만 표시)
  - [x] 모바일 반응형 CSS

#### 예상 소요 시간: 6시간

---

### 2.2 플로팅 버튼 추가
**목표**: 모든 페이지에서 빠른 접근

#### 체크리스트
- [x] **2.2.1** 플로팅 버튼 컴포넌트
  - [x] 우하단 고정 버튼 (60px × 60px, 모바일 56px)
  - [x] "🛒" 아이콘 (장바구니)
  - [x] 클릭 시 `/buy` 이동
  - [x] 그라데이션 디자인 (보라색)
  - [x] 호버 효과 (상승 애니메이션, 그림자 강화)

- [x] **2.2.2** 모바일 최적화
  - [x] 터치 영역 최적화 (56px)
  - [x] 스크롤 시에도 고정 (position: fixed)
  - [x] z-index: 1000으로 최상위 배치
  - [x] 반응형 크기 조정

- [x] **2.2.3** 페이지별 표시 여부 설정
  - [x] 대시보드 (`/`): 표시 안함 (이미 버튼 있음)
  - [x] 전략분석: 표시
  - [x] 구매이력: 표시
  - [x] 정보조회: 표시
  - [x] 구매관리 (`/buy`): 표시 안함
  - [x] 모바일 페이지: 표시 안함
  - [x] JavaScript로 페이지별 hide-fab 클래스 추가

#### 예상 소요 시간: 3시간
#### 실제 소요 시간: 약 2시간

---

### 2.3 모바일 페이지 동기화
**목표**: 모바일 버전도 동일한 구조 적용

#### 체크리스트
- [x] **2.3.1** 모바일 구매관리 페이지
  - [x] `templates/mobile/buy.html` 생성 (완전한 기능 구현)
  - [x] 터치 최적화된 입력 UI (수동/텍스트/랜덤)
  - [x] 큰 버튼, 간격 조정 (56px 터치 영역)
  - [x] 회차 선택 기능 (D-day 표시)
  - [x] 장바구니 표시 및 관리
  - [x] 모바일 라우트 추가 (`/mobile/buy`)

- [x] **2.3.2** 모바일 대시보드 업데이트
  - [x] 빠른 액션 카드 (4개 그라데이션 버튼)
  - [x] AI 추천, 구매관리, 구매이력, 정보조회
  - [x] 각 버튼별 색상 구분 (보라/파랑/초록/주황)
  - [x] 반응형 레이아웃 (2x2 그리드)

- [x] **2.3.3** 모바일 네비게이션 수정
  - [x] "구매관리" 메뉴 추가 (파란색)
  - [x] 아이콘 통일 (🤖🛒📋🔍)
  - [x] 모바일 대시보드에서 빠른 접근

#### 예상 소요 시간: 6시간
#### 실제 소요 시간: 약 5시간

---

### Phase 2 완료 기준
- [x] 대시보드에서 모든 빠른 액션 작동
- [x] 플로팅 버튼으로 어디서나 입력 가능
- [x] 모바일에서도 동일한 경험 제공
- [x] 실시간 카운트다운 정상 작동

#### 예상 총 소요 시간: 15시간 (약 2일)
#### 실제 소요 시간: 약 13시간

---

## 📅 Phase 3: 고급 기능 및 최적화 (1주)

### 3.1 웹 QR 스캔 통합
**목표**: 별도 앱 없이 웹에서 QR 스캔

#### 체크리스트
- [ ] **3.1.1** 카메라 액세스
  - [ ] `navigator.mediaDevices.getUserMedia()` 구현
  - [ ] 권한 요청 처리
  - [ ] 에러 핸들링

- [ ] **3.1.2** QR 코드 스캔
  - [ ] jsQR 또는 ZXing 라이브러리 통합
  - [ ] 실시간 스캔
  - [ ] 성공 피드백 (진동, 소리)

- [ ] **3.1.3** 스캔 결과 파싱
  - [ ] 기존 `parse_lotto_qr_url` 재사용
  - [ ] 자동으로 번호 입력
  - [ ] 회차 정보 추출

- [ ] **3.1.4** UI/UX
  - [ ] 카메라 프리뷰
  - [ ] 가이드 오버레이
  - [ ] 플래시 토글
  - [ ] 갤러리에서 이미지 선택 옵션

#### 예상 소요 시간: 8시간

---

### 3.2 배치 입력 기능
**목표**: 여러 번호 한번에 입력

#### 체크리스트
- [x] **3.2.1** 텍스트 영역 입력
  - [x] 여러 줄 입력 지원 (textarea 8줄)
  - [x] 자동 파싱 (줄바꿈, 콤마, 공백 구분)
  - [x] 검증 및 중복 제거
  - [x] 단일/배치 모드 토글 버튼
  - [x] 라인별 유효성 검사 및 결과 표시
  - [x] 오류 라인 하이라이트 (빨간색)
  - [x] 유효한 번호 세트만 추가

- [ ] **3.2.2** CSV 업로드 (Phase 3.2.1으로 대체 가능)
  - [ ] 파일 업로드 UI
  - [ ] CSV 파싱
  - [ ] 에러 라인 표시

- [x] **3.2.3** 복사/붙여넣기 최적화
  - [x] 텍스트 영역에서 직접 붙여넣기
  - [x] 자동 포맷 인식 (콤마, 공백, 줄바꿈)
  - [x] 번호 자동 추출 및 검증

#### 예상 소요 시간: 6시간
#### 실제 소요 시간: 약 3시간 (CSV 제외)

---

### 3.3 성능 최적화
**목표**: 빠른 응답속도

#### 체크리스트
- [x] **3.3.1** 데이터베이스 인덱스
  - [x] `purchase_round` 인덱스 (기존)
  - [x] `user_id + status` 복합 인덱스 (추가됨)
  - [x] `source` 인덱스 (추가됨)
  - [x] `user_id + purchase_round` 복합 인덱스 (추가됨)
  - [x] `winning_rank` 인덱스 (추가됨)
  - [x] `round + rank` 복합 인덱스 (WinningShop, 추가됨)
  - [x] 인덱스 추가 스크립트 작성 (`scripts/add_composite_indexes.py`)

- [ ] **3.3.2** 쿼리 최적화
  - [ ] N+1 쿼리 문제 해결
  - [ ] Eager loading 적용
  - [ ] 페이지네이션 개선

- [ ] **3.3.3** 프론트엔드 최적화
  - [ ] JavaScript 번들 최소화
  - [ ] CSS 인라인화
  - [ ] 이미지 lazy loading

#### 예상 소요 시간: 4시간
#### 실제 소요 시간: 약 2시간 (인덱스만)

---

### 3.4 통계 및 분석 강화
**목표**: 더 나은 인사이트 제공

#### 체크리스트
- [x] **3.4.1** 구매 패턴 분석
  - [x] 자주 선택하는 번호 (TOP 10)
  - [x] 입력 방식별 통계 (AI/수동/랜덤/QR)
  - [x] 회차별 평균 구매 개수
  - [x] 당첨률 계산

- [ ] **3.4.2** 예측 모델 개선 (추후 구현)
  - [ ] 사용자 맞춤 추천
  - [ ] 당첨 확률 표시
  - [ ] 시뮬레이션 기능

- [x] **3.4.3** 시각화 추가
  - [x] 입력 방식 분포 프로그레스 바
  - [x] 자주 선택한 번호 그리드
  - [x] 기본 통계 카드 (총 구매, 장바구니, 당첨, 당첨률)
  - [x] 사용자 통계 API 엔드포인트 (`/api/user-statistics`)
  - [x] 구매이력 페이지에 통계 섹션 추가

#### 예상 소요 시간: 8시간
#### 실제 소요 시간: 약 4시간

---

### Phase 3 완료 기준
- [ ] 웹에서 QR 스캔 성공
- [ ] CSV로 10개 이상 번호 일괄 입력
- [ ] 페이지 로딩 속도 2초 이내
- [ ] 시각화 차트 정상 표시

#### 예상 총 소요 시간: 26시간 (약 4일)

---

## 📊 진행 상황 추적

### 전체 진행률
- [x] **Phase 1: 데이터 모델 및 기본 구조 (13/14 시간) - COMPLETE ✅**
  - ✅ Phase 1.1: 데이터 모델 개선 (완료)
  - ✅ Phase 1.2: 구매관리 페이지 신설 (완료, 모바일 제외)
  - ✅ Phase 1.3: 전략분석 페이지 정리 (완료)
- [x] **Phase 2: UX 개선 및 대시보드 (13/15 시간) - COMPLETE ✅**
  - ✅ Phase 2.1: 메인 대시보드 개편 (완료)
  - ✅ Phase 2.2: 플로팅 버튼 추가 (완료)
  - ✅ Phase 2.3: 모바일 페이지 동기화 (완료)
- [x] **Phase 3: 고급 기능 및 최적화 (9/26 시간) - IN PROGRESS 🔄**
  - ⏭️ Phase 3.1: 웹 QR 스캔 통합 (미구현 - 별도 QR 앱 유지)
  - ✅ Phase 3.2: 배치 입력 기능 (완료)
  - ✅ Phase 3.3: 성능 최적화 - 인덱스 (완료)
  - ⏳ Phase 3.3: 성능 최적화 - 쿼리 (대기)
  - ✅ Phase 3.4: 통계 및 분석 강화 (완료)

**총 진행률: 65% (35/55 시간)**

---

## 📝 변경 이력

| 날짜 | Phase | 작업 내용 | 상태 |
|------|-------|----------|------|
| 2025-10-03 | - | 개선 계획 수립 | ✅ 완료 |
| 2025-10-03 | 1.1 | Purchase 모델 필드 추가 (status, is_real_purchase, purchase_location, cost) | ✅ 완료 |
| 2025-10-03 | 1.1 | 마이그레이션 스크립트 작성 및 테스트 (8건 마이그레이션 성공) | ✅ 완료 |
| 2025-10-03 | 1.2 | `/buy` 라우트 및 템플릿 생성 (회차 선택, 4가지 입력 방식, 장바구니) | ✅ 완료 |
| 2025-10-03 | 1.2 | API 엔드포인트 3개 추가 (add, confirm, delete draft) | ✅ 완료 |
| 2025-10-03 | 1.2 | 네비게이션 메뉴에 "구매관리" 추가 | ✅ 완료 |
| 2025-10-03 | 1.3 | 전략분석 페이지에서 수동 입력 섹션 완전 제거 (560줄 이상 삭제) | ✅ 완료 |
| 2025-10-03 | 1.3 | AI 추천번호에 "구매관리에 추가" 버튼 추가 | ✅ 완료 |
| 2025-10-03 | 1.3 | Quick Action 섹션 추가 (그라데이션 디자인) | ✅ 완료 |
| 2025-10-03 | 2.1 | 메인 대시보드 완전 개편 (다음 추첨 정보, 빠른 액션, 현황 요약, 활동 피드) | ✅ 완료 |
| 2025-10-03 | 2.1 | 실시간 카운트다운 타이머 구현 (초단위 업데이트) | ✅ 완료 |
| 2025-10-03 | 2.1 | Dashboard Grid 레이아웃 적용 (반응형) | ✅ 완료 |
| 2025-10-03 | 2.2 | base.html에 플로팅 액션 버튼 추가 (🛒 장바구니 아이콘) | ✅ 완료 |
| 2025-10-03 | 2.2 | 페이지별 플로팅 버튼 표시 여부 설정 (대시보드/구매관리/모바일 숨김) | ✅ 완료 |
| 2025-10-03 | 2.2 | 모바일 터치 최적화 (56px 터치 영역) | ✅ 완료 |
| 2025-10-03 | 2.3 | 모바일 구매관리 페이지 생성 (수동/텍스트/랜덤 입력, 장바구니) | ✅ 완료 |
| 2025-10-03 | 2.3 | `/mobile/buy` 라우트 추가 (회차 선택, D-day 계산) | ✅ 완료 |
| 2025-10-03 | 2.3 | 모바일 대시보드 빠른 메뉴 업데이트 (4개 그라데이션 버튼) | ✅ 완료 |
| 2025-10-03 | 2.3 | 모바일 네비게이션 통일 (AI 추천/구매관리/구매이력/정보조회) | ✅ 완료 |
| 2025-10-03 | 3.2 | 배치 입력 기능 구현 (여러 줄 텍스트 입력, 라인별 유효성 검사) | ✅ 완료 |
| 2025-10-03 | 3.2 | 단일/배치 모드 토글, 오류 라인 하이라이트, 배치 추가 기능 | ✅ 완료 |
| 2025-10-03 | 3.3 | 데이터베이스 복합 인덱스 추가 (6개 인덱스) | ✅ 완료 |
| 2025-10-03 | 3.3 | 성능 최적화 스크립트 작성 (`scripts/add_composite_indexes.py`) | ✅ 완료 |
| 2025-10-03 | 3.4 | 사용자 통계 API 엔드포인트 추가 (`/api/user-statistics`) | ✅ 완료 |
| 2025-10-03 | 3.4 | 구매 패턴 분석 (자주 선택한 번호 TOP 10, 입력 방식 분포) | ✅ 완료 |
| 2025-10-03 | 3.4 | 구매이력 페이지에 통계 섹션 추가 (기본 통계, 선호도, 자주 선택한 번호) | ✅ 완료 |

---

## 🚨 중요 참고사항

### 롤백 계획
- 각 Phase 시작 전 데이터베이스 백업
- Git 브랜치 전략: `feature/improvement-phase-N`
- 문제 발생 시 즉시 이전 버전으로 복구

### 테스트 필수 항목
- [ ] 로컬 환경 동작 확인
- [ ] NAS 환경 배포 전 테스트
- [ ] 모바일 실기기 테스트
- [ ] 기존 사용자 데이터 무결성 검증

### 사용자 안내
- Phase 1 배포 시 사용자에게 변경사항 공지
- "구매관리" 새 메뉴 가이드 제공
- 기존 기능 위치 변경 안내

---

## 🎯 성공 지표

### Phase 1 완료 시
- 새로운 데이터 모델로 저장된 구매 건수 > 10건
- 에러율 < 1%
- 사용자 피드백 수집

### Phase 2 완료 시
- 대시보드 평균 체류 시간 증가
- 플로팅 버튼 클릭률 > 20%
- 모바일 이탈률 감소

### Phase 3 완료 시
- QR 스캔 성공률 > 95%
- 배치 입력 사용률 > 15%
- 페이지 로딩 속도 2초 이내

---

## ✅ 다음 단계

**즉시 시작 가능**: Phase 1.1 데이터 모델 개선

승인 후 작업을 시작하겠습니다.
