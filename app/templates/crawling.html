{% extends "base.html" %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
  // Cache busting - v2.0
  console.log('Crawling page loaded - v2.0 with enhanced stats');
</script>
<div class="header">
  <div>
    <h1>📥 데이터 크롤링</h1>
    <div class="muted">로또 데이터 수집 및 업데이트</div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Status Information -->
  <section class="card">
    <div class="card-header">
      <h2>📊 데이터 현황</h2>
      <button type="button" class="btn-detail" onclick="toggleDataDetail()">Detail</button>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="stats-loading-overlay" class="stats-loading-overlay">
      <div class="spinner"></div>
      <p>데이터를 불러오는 중...</p>
    </div>

    <div id="stats-content" class="info-grid" style="opacity: 0.3;">
      <div class="info-item tooltip-container">
        <h4>
          저장된 회차
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">데이터베이스에 저장된 총 로또 회차 수</span>
        </h4>
        <p id="total-rounds-display">{{ total_rounds }}회</p>
      </div>

      <div class="info-item tooltip-container">
        <h4>
          최신 회차
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">현재까지 발표된 가장 최근 로또 회차</span>
        </h4>
        <p id="latest-round-display">
          {% if latest %}{{ latest.round }}회{% else %}로딩중...{% endif %}
        </p>
      </div>

      <div class="info-item tooltip-container">
        <h4>
          누락된 회차
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">수집되지 않은 회차의 개수</span>
        </h4>
        <p id="missing-count" class="stat-loading">계산 중...</p>
      </div>

      <div class="info-item tooltip-container">
        <h4>
          데이터 완성도
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">전체 회차 대비 수집 완료 비율</span>
        </h4>
        <p id="completion-rate" class="stat-loading">계산 중...</p>
      </div>

      <div class="info-item tooltip-container">
        <h4>
          DB 용량
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">데이터베이스 파일 크기</span>
        </h4>
        <p id="db-size" class="stat-loading">계산 중...</p>
      </div>

      <div class="info-item tooltip-container">
        <h4>
          판매점 정보
          <span class="tooltip-icon">ℹ️</span>
          <span class="tooltip-text">저장된 당첨 판매점 정보 수</span>
        </h4>
        <p id="shops-count" class="stat-loading">계산 중...</p>
      </div>
    </div>

    <!-- 에러 메시지 -->
    <div id="stats-error" class="stats-error" style="display: none;">
      <div class="error-icon">⚠️</div>
      <p class="error-message"></p>
      <button class="btn-retry" onclick="loadBasicStats()">다시 시도</button>
    </div>

    <!-- 상세 정보 패널 -->
    <div id="data-detail-panel" class="detail-panel" style="display: none;">
      <div class="detail-header">
        <h3>📋 상세 데이터 현황</h3>
        <button type="button" class="btn-close" onclick="toggleDataDetail()">×</button>
      </div>

      <div class="detail-tabs">
        <button class="tab-btn active" onclick="showDetailTab('missing')">누락 회차</button>
        <button class="tab-btn" onclick="showDetailTab('existing')">저장된 회차</button>
      </div>

      <div class="detail-content">
        <div id="missing-tab" class="tab-content active">
          <div class="loading-indicator" id="missing-loading">데이터를 불러오는 중...</div>
          <div id="missing-list" style="display: none;"></div>
        </div>

        <div id="existing-tab" class="tab-content">
          <div class="loading-indicator" id="existing-loading">데이터를 불러오는 중...</div>
          <div id="existing-list" style="display: none;"></div>
          <div id="existing-pagination" style="display: none; text-align: center; margin-top: 1rem;">
            <button class="btn-secondary" onclick="loadExistingPage('prev')" id="existing-prev-btn">← 이전</button>
            <span id="existing-page-info" style="margin: 0 1rem; color: #6c757d;"></span>
            <button class="btn-secondary" onclick="loadExistingPage('next')" id="existing-next-btn">다음 →</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 회차 정보 모달 -->
  <div id="round-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">회차 정보</h3>
        <button type="button" class="btn-close" onclick="closeRoundModal()">×</button>
      </div>

      <div class="modal-body">
        <div id="modal-loading" class="loading-indicator">정보를 불러오는 중...</div>

        <div id="modal-content" style="display: none;">
          <!-- 회차 기본 정보 -->
          <div class="round-info-section">
            <h4>📅 기본 정보</h4>
            <div class="info-row">
              <span class="info-label">회차:</span>
              <span id="modal-round" class="info-value">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">추첨일:</span>
              <span id="modal-date" class="info-value">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">상태:</span>
              <span id="modal-status" class="info-value">-</span>
            </div>
          </div>

          <!-- 당첨 번호 -->
          <div class="winning-numbers-section">
            <h4>🎯 당첨 번호</h4>
            <div id="modal-numbers" class="numbers-display">
              <div class="numbers">
                <!-- 번호들이 JavaScript로 동적 생성 -->
              </div>
              <div class="bonus-section">
                <span class="plus">+</span>
                <span class="bonus" id="modal-bonus">-</span>
                <span class="bonus-label">보너스</span>
              </div>
            </div>
          </div>

          <!-- 판매점 정보 -->
          <div class="shops-section">
            <h4>🏪 당첨 판매점</h4>
            <div id="modal-shops">
              <!-- 판매점 정보가 JavaScript로 동적 생성 -->
            </div>
          </div>

          <!-- 액션 버튼들 -->
          <div class="modal-actions">
            <button type="button" class="btn-action" onclick="crawlSpecificRound()">
              🔄 이 회차 재수집
            </button>
            <button type="button" class="btn-action" onclick="viewDrawDetail()">
              📊 상세 분석 보기
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Collection Panel -->
  <section id="data-collection" class="card actions-card">
    <div class="card-header">
      <h2>🔄 로또 데이터 크롤링</h2>
    </div>

    <div class="action-groups-vertical">
      <!-- Progress Status - 위쪽으로 이동 -->
      <section class="card progress-card" id="progress-section">
        <div class="card-header">
          <h3>⚡ 크롤링 진행 상태</h3>
        </div>
        <div id="progress-container">
          <div class="progress-status">
            <div class="status-text" id="status-text">대기중</div>
            <div class="operation-type" id="operation-type"></div>
            <button type="button" class="btn-danger btn-stop" id="stop-btn" onclick="stopCrawling()" style="display: none;">
              ⏹️ 중지
            </button>
          </div>
          <div class="progress-details" id="progress-details" style="display: none;">
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="progress-text" id="progress-text">0%</div>
            </div>
            <div class="round-info">
              <span id="current-round-info">현재: -</span>
              <span id="total-rounds-info">전체: -</span>
            </div>
            <div class="time-info">
              <span id="elapsed-time">경과: 0초</span>
              <span id="remaining-time" style="display: none;">예상 남은 시간: -</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 크롤링 옵션 선택 -->
      <div class="crawling-type-selector">
        <h4>크롤링 데이터 선택</h4>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="both" checked>
            <span class="radio-label">당첨번호 + 판매점 (전체)</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="numbers">
            <span class="radio-label">당첨번호만</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="shops">
            <span class="radio-label">판매점만</span>
          </label>
        </div>
      </div>

      <div class="action-group">
        <div class="crawling-grid">
          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">1</span>
              <h4>전체 다시 크롤링</h4>
            </div>
            <p class="option-desc">1회차부터 최신회차까지 모든 데이터를 다시 수집합니다</p>
            <button type="button" class="btn-primary" onclick="startCrawling('full')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">2</span>
              <h4>빠진회차 크롤링</h4>
            </div>
            <p class="option-desc">누락된 회차만 선별하여 데이터를 수집합니다</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('missing')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">3</span>
              <h4>최신회차 크롤링</h4>
            </div>
            <p class="option-desc">가장 최근 추첨회차 데이터만 업데이트합니다</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('latest')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">4</span>
              <h4>범위 크롤링</h4>
            </div>
            <p class="option-desc">지정한 회차 범위의 데이터를 수집합니다</p>
            <div class="range-input">
              <input type="number" id="startRound" min="1" placeholder="시작 회차" />
              <span>~</span>
              <input type="number" id="endRound" min="1" placeholder="끝 회차" />
            </div>
            <button type="button" class="btn-secondary" onclick="startRangeCrawling()">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">5</span>
              <h4>특정회차 크롤링</h4>
            </div>
            <p class="option-desc">원하는 회차를 지정하여 해당 데이터만 수집합니다</p>
            <div class="specific-round-input">
              <input type="number" id="specificRound" min="1" placeholder="회차 번호" />
              <button type="button" class="btn-secondary" onclick="startSpecificCrawling()">실행</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</div> <!-- End main-content -->

<style>
.crawling-type-selector {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.crawling-type-selector h4 {
  margin-bottom: 0.8rem;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
}

.radio-group {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  color: #333;
}

.radio-option input[type="radio"] {
  margin: 0;
  transform: scale(1.1);
}

.crawling-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-top: 1rem;
}

.crawling-option {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1.2rem;
  transition: all 0.3s ease;
}

.crawling-option:hover {
  border-color: #667eea;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.option-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.option-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  font-weight: bold;
  border-radius: 50%;
  font-size: 1rem;
}

.option-header h4 {
  margin: 0;
  color: #333;
  font-size: 1.1rem;
}

.option-desc {
  color: #666;
  margin-bottom: 1.2rem;
  line-height: 1.4;
  font-size: 0.9rem;
}

.range-input {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.range-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.range-input span {
  font-weight: bold;
  color: #666;
}

.specific-round-input {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.specific-round-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.btn-primary, .btn-secondary {
  width: 100%;
  padding: 0.8rem 1.2rem;
  border: none;
  border-radius: 0.4rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.specific-round-input .btn-secondary {
  width: auto;
  padding: 0.5rem 1rem;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
  margin-top: 1rem;
  position: relative;
  transition: opacity 0.3s ease;
}

.info-item {
  text-align: center;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border: 2px solid #e9ecef;
  border-radius: 0.8rem;
  transition: all 0.3s ease;
  position: relative;
}

.info-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
  border-color: #667eea;
}

.info-item h4 {
  margin: 0 0 0.8rem 0;
  color: #666;
  font-size: 0.95rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.3rem;
}

.info-item p {
  margin: 0;
  font-size: 1.8rem;
  font-weight: bold;
  color: #333;
  transition: color 0.3s ease;
}

/* 툴팁 스타일 */
.tooltip-container {
  position: relative;
}

.tooltip-icon {
  font-size: 0.75rem;
  cursor: help;
  opacity: 0.6;
  transition: opacity 0.3s ease;
}

.tooltip-icon:hover {
  opacity: 1;
}

.tooltip-text {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: #2d3748;
  color: white;
  padding: 0.6rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.8rem;
  font-weight: normal;
  white-space: nowrap;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  pointer-events: none;
}

.tooltip-text::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #2d3748;
}

.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
  top: -70px;
}

/* 로딩 오버레이 */
.stats-loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10;
  border-radius: 0.5rem;
  gap: 1rem;
}

.stats-loading-overlay.hidden {
  display: none;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #e9ecef;
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.stats-loading-overlay p {
  color: #667eea;
  font-weight: 600;
  margin: 0;
}

/* 로딩 중 텍스트 애니메이션 */
.stat-loading {
  color: #667eea !important;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* 에러 메시지 스타일 */
.stats-error {
  text-align: center;
  padding: 2rem;
  background: linear-gradient(135deg, #fff5f5, #ffffff);
  border: 2px solid #fed7d7;
  border-radius: 0.8rem;
  margin-top: 1rem;
}

.error-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.error-message {
  color: #c53030;
  font-weight: 600;
  margin-bottom: 1.5rem;
  font-size: 1.1rem;
}

.btn-retry {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-retry:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Progress Card Styles */
.progress-card {
  background: #fff;
  margin-bottom: 1.5rem;
}

.progress-card .card-header h3 {
  margin: 0;
  font-size: 1.3rem;
  color: #333;
}

/* Progress Status Styles */
.progress-status {
  text-align: center;
  margin-bottom: 1rem;
}

.status-text {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.5rem;
}

.operation-type {
  font-size: 1rem;
  color: #666;
  font-weight: 500;
}

.progress-details {
  margin-top: 1.5rem;
}

.progress-bar-container {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.progress-bar {
  flex: 1;
  height: 20px;
  background: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 10px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-text {
  font-weight: bold;
  color: #333;
  min-width: 50px;
}

.round-info, .time-info {
  display: flex;
  justify-content: space-between;
  margin: 0.5rem 0;
  font-size: 0.9rem;
  color: #666;
}

.round-info span, .time-info span {
  font-weight: 500;
}

.progress-status {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: center;
}

.btn-stop {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
}

.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* 토스트 애니메이션 */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

.toast-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.toast-message {
  color: #744210;
  font-weight: 600;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .crawling-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .radio-group {
    flex-direction: column;
    gap: 0.8rem;
  }

  .crawling-option {
    padding: 1rem;
  }

  .info-grid {
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .info-item {
    padding: 1.2rem 0.8rem;
  }

  .info-item h4 {
    font-size: 0.85rem;
  }

  .info-item p {
    font-size: 1.5rem;
  }

  .tooltip-text {
    font-size: 0.75rem;
    padding: 0.5rem 0.8rem;
    white-space: normal;
    max-width: 200px;
  }

  .range-input {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .specific-round-input {
    flex-direction: column;
    gap: 0.5rem;
  }

  .specific-round-input .btn-secondary {
    width: 100%;
  }

  .crawling-type-selector {
    padding: 0.8rem;
  }

  .progress-card .card-header h3 {
    font-size: 1.2rem;
  }

  .status-text {
    font-size: 1.3rem;
  }

  .warning-toast {
    max-width: 90% !important;
    right: 5% !important;
    top: 10px !important;
  }

  .stats-error {
    padding: 1.5rem 1rem;
  }

  .error-message {
    font-size: 0.95rem;
  }
}

/* 데이터 상세 정보 스타일 */
.btn-detail {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.4rem;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-detail:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.detail-panel {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border: 2px solid #e9ecef;
  border-radius: 0.8rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e9ecef;
}

.detail-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.2rem;
}

.btn-close {
  background: #dc3545;
  color: white;
  border: none;
  padding: 0.3rem 0.8rem;
  border-radius: 0.4rem;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-close:hover {
  background: #c82333;
  transform: scale(1.1);
}

.detail-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #e9ecef;
}

.tab-btn {
  background: none;
  border: none;
  padding: 0.8rem 1.5rem;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
}

.tab-btn.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.tab-btn:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.detail-content {
  min-height: 400px;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.loading-indicator {
  text-align: center;
  padding: 2rem;
  color: #666;
  font-style: italic;
}

.round-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 0.5rem;
  margin-top: 1rem;
  max-height: 400px;
  overflow-y: auto;
  padding: 0.5rem;
  border: 1px solid #e9ecef;
  border-radius: 0.5rem;
}

.round-item {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.4rem;
  padding: 0.5rem;
  text-align: center;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.round-item.missing {
  background: #fff5f5;
  border-color: #fed7d7;
  color: #c53030;
}

.round-item.existing {
  background: #f0fff4;
  border-color: #c6f6d5;
  color: #25543e;
}

.round-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.stat-card {
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border: 2px solid #e9ecef;
  border-radius: 0.8rem;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-card:hover {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #667eea;
  margin-bottom: 0.5rem;
}

.stat-label {
  color: #666;
  font-weight: 600;
}

.range-display {
  margin-bottom: 1rem;
  padding: 1rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border-radius: 0.8rem;
  text-align: center;
  font-weight: 600;
}

@media (max-width: 768px) {
  .detail-tabs {
    flex-direction: column;
    gap: 0;
  }

  .tab-btn {
    border-bottom: none;
    border-right: 3px solid transparent;
  }

  .tab-btn.active {
    border-right-color: #667eea;
    border-bottom-color: transparent;
  }

  .round-list {
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 0.3rem;
  }

  .summary-stats {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95% !important;
    max-height: 90vh !important;
    margin: 2.5vh auto !important;
  }

  .modal-actions {
    flex-direction: column !important;
  }
}

/* 회차 정보 모달 스타일 */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  width: 80%;
  max-width: 800px;
  max-height: 80vh;
  border-radius: 1rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from { opacity: 0; transform: translateY(-50px) scale(0.9); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 600;
}

.modal-body {
  padding: 2rem;
  max-height: 60vh;
  overflow-y: auto;
}

.round-info-section,
.winning-numbers-section,
.shops-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border-radius: 0.8rem;
  border: 1px solid #e9ecef;
}

.round-info-section h4,
.winning-numbers-section h4,
.shops-section h4 {
  margin: 0 0 1rem 0;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
  border-bottom: 2px solid #667eea;
  padding-bottom: 0.5rem;
}

.info-row {
  display: flex;
  margin-bottom: 0.8rem;
  align-items: center;
}

.info-label {
  font-weight: 600;
  color: #666;
  min-width: 80px;
  margin-right: 1rem;
}

.info-value {
  color: #333;
  font-weight: 500;
}

.numbers-display {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.numbers-display .numbers {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.numbers-display .number {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.9rem;
  color: white;
  background: linear-gradient(135deg, #4299e1, #3182ce);
  box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
}

.numbers-display .bonus-section {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.numbers-display .plus {
  font-size: 1.5rem;
  color: #718096;
  font-weight: 600;
}

.numbers-display .bonus {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.9rem;
  color: white;
  background: linear-gradient(135deg, #f56565, #e53e3e);
  box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
}

.numbers-display .bonus-label {
  font-size: 0.8rem;
  color: #718096;
  font-weight: 500;
}

.shop-item {
  padding: 1rem;
  background: #f7fafc;
  border-radius: 0.5rem;
  border-left: 4px solid #667eea;
  margin-bottom: 1rem;
}

.shop-rank {
  font-weight: 700;
  color: #667eea;
  margin-bottom: 0.5rem;
}

.shop-name {
  font-weight: 600;
  color: #333;
  margin-bottom: 0.3rem;
}

.shop-method {
  font-size: 0.9rem;
  color: #4299e1;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.shop-address {
  font-size: 0.85rem;
  color: #718096;
  line-height: 1.4;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  padding: 1.5rem;
  background: #f8f9fa;
  margin: -2rem -2rem 0 -2rem;
}

.modal-actions .btn-action {
  flex: 1;
  padding: 0.8rem 1.2rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  text-align: center;
}

.modal-actions .btn-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.no-data-message {
  text-align: center;
  padding: 2rem;
  color: #718096;
  font-style: italic;
}
</style>

<script>
let progressInterval;
let lastUpdateTime = 0;

function formatTime(seconds) {
  if (seconds < 60) return `${seconds}초`;
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}분 ${remainingSeconds}초`;
}

function getCrawlingType() {
  const checkedRadio = document.querySelector('input[name="crawling-type"]:checked');
  return checkedRadio ? checkedRadio.value : 'both';
}

function startCrawling(type) {
  const crawlingType = getCrawlingType();
  const url = `/update-${type}`;

  // 크롤링 시작 전 UI 즉시 업데이트
  const statusText = document.getElementById('status-text');
  const operationType = document.getElementById('operation-type');
  const stopBtn = document.getElementById('stop-btn');

  statusText.textContent = '시작중...';
  let operationTypeText = '';
  switch(type) {
    case 'full': operationTypeText = '[전체 크롤링]'; break;
    case 'missing': operationTypeText = '[빠진회차 크롤링]'; break;
    case 'latest': operationTypeText = '[최신회차 크롤링]'; break;
  }
  operationType.textContent = operationTypeText;

  // 즉시 진행 모니터링 시작
  startProgressMonitoring();

  const formData = new FormData();
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch(url, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
      // 오류 시 상태 초기화
      statusText.textContent = '대기중';
      operationType.textContent = '';
      stopProgressMonitoring();
    }
  })
  .catch(error => {
    console.error('Crawling error:', error);
    // 에러 발생해도 모니터링 계속 (서버에서 크롤링이 시작되었을 수 있음)
  });
}

function startRangeCrawling() {
  const startRound = document.getElementById('startRound').value;
  const endRound = document.getElementById('endRound').value;
  const crawlingType = getCrawlingType();

  if (!startRound || !endRound) {
    alert('시작 회차와 끝 회차를 모두 입력해주세요.');
    return;
  }

  if (parseInt(startRound) > parseInt(endRound)) {
    alert('시작 회차가 끝 회차보다 클 수 없습니다.');
    return;
  }

  const formData = new FormData();
  formData.append('start', startRound);
  formData.append('end', endRound);
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch('/update-range', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Range crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function startSpecificCrawling() {
  const round = document.getElementById('specificRound').value;
  const crawlingType = getCrawlingType();

  if (!round) {
    alert('회차 번호를 입력해주세요.');
    return;
  }

  const formData = new FormData();
  formData.append('round', round);
  formData.append('data_type', crawlingType);
  formData.append('csrf_token', window.csrfToken);

  fetch('/update', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Specific crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function updateProgress() {
  const currentTime = Date.now();

  // 너무 빈번한 업데이트 방지 (최소 500ms 간격)
  if (currentTime - lastUpdateTime < 500) {
    return;
  }

  lastUpdateTime = currentTime;

  fetch('/api/crawling-progress')
    .then(response => response.json())
    .then(data => {
      const statusText = document.getElementById('status-text');
      const operationType = document.getElementById('operation-type');
      const progressDetails = document.getElementById('progress-details');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const currentRoundInfo = document.getElementById('current-round-info');
      const totalRoundsInfo = document.getElementById('total-rounds-info');
      const elapsedTime = document.getElementById('elapsed-time');
      const remainingTime = document.getElementById('remaining-time');

      // 상태 텍스트 업데이트 (깜빡임 방지)
      if (statusText.textContent !== data.status) {
        statusText.textContent = data.status;
      }

      const operationText = data.operation_type ? `[${data.operation_type}]` : '';
      if (operationType.textContent !== operationText) {
        operationType.textContent = operationText;
      }

      if (data.is_running) {
        // 진행 상황 표시
        progressDetails.style.display = 'block';

        // 중지 버튼 표시
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.style.display = 'block';

        // 진행률 계산 및 업데이트
        const percentage = data.total_rounds > 0 ?
          Math.round((data.completed_rounds / data.total_rounds) * 100) : 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;

        // 회차 정보 업데이트
        currentRoundInfo.textContent = `현재: ${data.current_round}회`;
        totalRoundsInfo.textContent = `전체: ${data.total_rounds}회 (완료: ${data.completed_rounds})`;

        // 시간 정보 업데이트
        if (data.elapsed_seconds) {
          elapsedTime.textContent = `경과: ${formatTime(data.elapsed_seconds)}`;
        }

        if (data.estimated_remaining_seconds && data.estimated_remaining_seconds > 0) {
          remainingTime.textContent = `예상 남은 시간: ${formatTime(data.estimated_remaining_seconds)}`;
          remainingTime.style.display = 'inline';
        } else {
          remainingTime.style.display = 'none';
        }
      } else {
        // 크롤링 완료 또는 대기 상태
        if (data.status !== '대기중') {
          // 완료 상태 잠시 표시 후 숨김
          setTimeout(() => {
            if (!document.querySelector('#status-text').textContent.includes('진행중')) {
              progressDetails.style.display = 'none';
            }
          }, 3000);
        } else {
          progressDetails.style.display = 'none';
        }

        // 중지 버튼 숨김
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.style.display = 'none';

        // 크롤링 완료시 진행 모니터링 중지
        if (data.status.includes('완료') || data.status === '대기중') {
          stopProgressMonitoring();
        }
      }
    })
    .catch(error => {
      console.error('Progress update error:', error);
      // 에러 발생시 잠시 후 재시도
      setTimeout(updateProgress, 2000);
    });
}

function startProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }

  // 즉시 한 번 업데이트
  updateProgress();

  // 주기적 업데이트 (1초 간격)
  progressInterval = setInterval(updateProgress, 1000);
}

function stopProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

// 크롤링 중지 함수
function stopCrawling() {
  const confirmed = confirm('진행 중인 크롤링을 중지하시겠습니까?');

  if (!confirmed) {
    return;
  }

  const stopBtn = document.getElementById('stop-btn');
  stopBtn.disabled = true;
  stopBtn.innerHTML = '⏳ 중지중...';

  fetch('/api/stop-crawling', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'csrf_token=' + encodeURIComponent(window.csrfToken)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 중지 성공 - UI 즉시 업데이트
      document.getElementById('status-text').textContent = '중지됨';
      document.getElementById('operation-type').textContent = '';
      stopBtn.style.display = 'none';
      stopProgressMonitoring();

      // 3초 후 대기중으로 변경
      setTimeout(() => {
        document.getElementById('status-text').textContent = '대기중';
        document.getElementById('progress-details').style.display = 'none';
      }, 3000);
    } else {
      alert(`중지 실패: ${data.message}`);
      stopBtn.disabled = false;
      stopBtn.innerHTML = '⏹️ 중지';
    }
  })
  .catch(error => {
    console.error('Stop crawling error:', error);
    alert('중지 요청 중 오류가 발생했습니다.');
    stopBtn.disabled = false;
    stopBtn.innerHTML = '⏹️ 중지';
  });
}

// 페이지 로드시 진행 상태 확인
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  loadBasicStats();

  // 진행 중인 작업이 있으면 모니터링 시작
  setTimeout(() => {
    const statusText = document.getElementById('status-text').textContent;
    if (statusText.includes('진행중') || statusText.includes('수집중')) {
      startProgressMonitoring();
    }
  }, 500);
});

// 페이지 언로드시 정리
window.addEventListener('beforeunload', function() {
  stopProgressMonitoring();
});

// 기본 통계 정보 로드
async function loadBasicStats() {
  const loadingOverlay = document.getElementById('stats-loading-overlay');
  const statsContent = document.getElementById('stats-content');
  const statsError = document.getElementById('stats-error');

  try {
    // 로딩 시작
    loadingOverlay.classList.remove('hidden');
    statsContent.style.opacity = '0.3';
    statsError.style.display = 'none';

    const response = await fetch('/api/data-stats');

    // HTTP 에러 체크
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    // API 에러 응답 처리
    if (data.error) {
      throw new Error(data.error);
    }

    // 정상 데이터 처리
    updateStatsUI(data);

    // 로딩 완료
    loadingOverlay.classList.add('hidden');
    statsContent.style.opacity = '1';

    // 경고 메시지가 있으면 사용자에게 알림
    if (data.warning) {
      console.warn('Data stats warning:', data.warning);
      showWarningToast(data.warning);
    }

  } catch (error) {
    console.error('Failed to load basic stats:', error);

    // 로딩 오버레이 숨김
    loadingOverlay.classList.add('hidden');
    statsContent.style.opacity = '0.3';

    // 에러 메시지 표시
    const errorMessage = statsError.querySelector('.error-message');
    errorMessage.textContent = `데이터를 불러오는데 실패했습니다: ${error.message}`;
    statsError.style.display = 'block';
  }
}

// UI 업데이트 함수
function updateStatsUI(data) {
  // 기본 통계
  document.getElementById('total-rounds-display').textContent = `${data.total_rounds || 0}회`;
  document.getElementById('latest-round-display').textContent = `${data.latest_round || 0}회`;

  // 누락 회차 - "?" 표시 시 클릭 안내
  const missingElement = document.getElementById('missing-count');
  if (data.missing_count === "?") {
    missingElement.innerHTML = '<span style="color: #667eea; cursor: pointer; text-decoration: underline;" title="클릭하여 상세 정보 확인" onclick="showDetailPanel()">클릭하여 확인</span>';
  } else {
    missingElement.textContent = `${data.missing_count || 0}회`;
  }

  // 완성도 - 색상 코딩
  const completionRate = data.completion_rate || 0;
  const completionElement = document.getElementById('completion-rate');
  completionElement.textContent = `${completionRate}%`;

  // 완성도에 따라 색상 변경
  if (completionRate >= 95) {
    completionElement.style.color = '#48bb78'; // 녹색
  } else if (completionRate >= 80) {
    completionElement.style.color = '#ed8936'; // 주황색
  } else {
    completionElement.style.color = '#f56565'; // 빨강색
  }

  // 데이터베이스 용량
  document.getElementById('db-size').textContent = data.db_size || '0 MB';

  // 판매점 정보
  if (data.table_stats) {
    document.getElementById('shops-count').textContent = `${data.table_stats.shops || 0}개`;
  }

  // 빠른 모드 표시 (선택적)
  if (data.fast_mode) {
    console.log('✓ 빠른 로딩 모드 - 상세 통계는 Detail 클릭');
  }

  // 로딩 클래스 제거
  document.querySelectorAll('.stat-loading').forEach(el => {
    el.classList.remove('stat-loading');
  });
}

// 경고 토스트 메시지 표시
function showWarningToast(message) {
  // 토스트 요소 생성
  const toast = document.createElement('div');
  toast.className = 'warning-toast';
  toast.innerHTML = `
    <div class="toast-icon">⚠️</div>
    <div class="toast-message">${message}</div>
  `;

  // 스타일 추가
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #fff5e6, #ffffff);
    border: 2px solid #fbd38d;
    border-radius: 0.8rem;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    max-width: 400px;
    animation: slideInRight 0.3s ease;
  `;

  document.body.appendChild(toast);

  // 3초 후 제거
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// 상세 정보 패널 토글
function toggleDataDetail() {
  const panel = document.getElementById('data-detail-panel');

  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    loadDetailData();
  } else {
    panel.style.display = 'none';
  }
}

// 누락 회차 클릭 시 Detail 패널 자동 열기
function showDetailPanel() {
  const panel = document.getElementById('data-detail-panel');

  if (panel.style.display === 'none') {
    panel.style.display = 'block';

    // "누락" 탭으로 자동 전환
    showDetailTab('missing');

    // 패널로 스크롤
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// 탭 전환
function showDetailTab(tabName) {
  // 모든 탭 비활성화
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  // 선택된 탭 활성화
  document.querySelector(`button[onclick="showDetailTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');

  // 데이터 로드
  loadTabData(tabName);
}

// 탭별 데이터 로드
async function loadTabData(tabName) {
  const loadingId = `${tabName}-loading`;
  const contentId = `${tabName}-list`;

  document.getElementById(loadingId).style.display = 'block';
  document.getElementById(contentId).style.display = 'none';

  try {
    const response = await fetch(`/api/data-detail/${tabName}`);
    const data = await response.json();

    // 에러 응답 체크
    if (data.error) {
      throw new Error(data.error);
    }

    document.getElementById(loadingId).style.display = 'none';
    document.getElementById(contentId).style.display = 'block';

    switch(tabName) {
      case 'missing':
        renderMissingRounds(data);
        break;
      case 'existing':
        renderExistingRounds(data);
        break;
    }
  } catch (error) {
    console.error(`Failed to load ${tabName} data:`, error);
    document.getElementById(loadingId).style.display = 'block';
    document.getElementById(loadingId).textContent = `데이터를 불러오는데 실패했습니다: ${error.message}`;
  }
}

// 전체 데이터 로드
async function loadDetailData() {
  loadTabData('missing');
}

// 누락 회차 렌더링
function renderMissingRounds(data) {
  const container = document.getElementById('missing-list');

  if (data.rounds.length === 0) {
    container.innerHTML = '<p class="no-data">누락된 회차가 없습니다! 🎉</p>';
    return;
  }

  const rangeDisplay = `<div class="range-display">누락 회차: ${data.total_missing}개 (${data.range.start}~${data.range.end} 중)</div>`;

  const roundsList = `<div class="round-list">${data.rounds.map(round =>
    `<div class="round-item missing" onclick="showRoundInfo(${round})">${round}</div>`
  ).join('')}</div>`;

  const moreInfo = data.has_more ?
    `<div class="more-info">⚡ 빠른 로딩을 위해 최대 100개만 표시됩니다</div>` : '';

  container.innerHTML = rangeDisplay + roundsList + moreInfo;
}

// 현재 페이지 상태 저장
let currentExistingPage = 1;
let totalExistingPages = 1;

// 저장된 회차 렌더링
function renderExistingRounds(data) {
  const container = document.getElementById('existing-list');
  const pagination = document.getElementById('existing-pagination');

  const rangeDisplay = `<div class="range-display">저장된 회차: ${data.total_existing}개 (${data.range.start}~${data.range.end} 중)</div>`;

  const roundsList = `<div class="round-list">${data.rounds.map(round =>
    `<div class="round-item existing" onclick="showRoundInfo(${round})">${round}</div>`
  ).join('')}</div>`;

  container.innerHTML = rangeDisplay + roundsList;

  // 페이징 정보 업데이트
  currentExistingPage = data.page || 1;
  const perPage = data.per_page || 100;
  totalExistingPages = Math.ceil(data.total_existing / perPage);

  if (totalExistingPages > 1) {
    pagination.style.display = 'block';
    document.getElementById('existing-page-info').textContent = `${currentExistingPage} / ${totalExistingPages} 페이지`;

    // 버튼 상태 업데이트
    document.getElementById('existing-prev-btn').disabled = currentExistingPage <= 1;
    document.getElementById('existing-next-btn').disabled = currentExistingPage >= totalExistingPages;
  } else {
    pagination.style.display = 'none';
  }
}

// 저장된 회차 페이지 로드
async function loadExistingPage(direction) {
  let newPage = currentExistingPage;

  if (direction === 'prev' && currentExistingPage > 1) {
    newPage = currentExistingPage - 1;
  } else if (direction === 'next' && currentExistingPage < totalExistingPages) {
    newPage = currentExistingPage + 1;
  } else {
    return; // 이동할 수 없으면 종료
  }

  const loadingId = 'existing-loading';
  const contentId = 'existing-list';

  document.getElementById(loadingId).style.display = 'block';
  document.getElementById(contentId).style.display = 'none';

  try {
    const response = await fetch(`/api/data-detail/existing?page=${newPage}`);
    const data = await response.json();

    if (data.error) {
      throw new Error(data.error);
    }

    document.getElementById(loadingId).style.display = 'none';
    document.getElementById(contentId).style.display = 'block';

    renderExistingRounds(data);
  } catch (error) {
    console.error('Failed to load existing rounds page:', error);
    document.getElementById(loadingId).textContent = `페이지를 불러오는데 실패했습니다: ${error.message}`;
  }
}

// 회차 정보 모달 열기
async function showRoundInfo(round) {
  const modal = document.getElementById('round-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalLoading = document.getElementById('modal-loading');
  const modalContent = document.getElementById('modal-content');

  // 모달 초기화
  modalTitle.textContent = `${round}회차 정보`;
  modalLoading.style.display = 'block';
  modalContent.style.display = 'none';
  modal.style.display = 'flex';

  // 현재 선택된 회차 저장 (액션 버튼에서 사용)
  window.currentModalRound = round;

  try {
    // 회차 데이터 로드
    const drawResponse = await fetch(`/api/draw/${round}`);
    const shopsResponse = await fetch(`/api/shops/${round}`);

    let drawData = null;
    let shopsData = null;

    if (drawResponse.ok) {
      drawData = await drawResponse.json();
    }

    if (shopsResponse.ok) {
      shopsData = await shopsResponse.json();
    }

    // 모달 내용 업데이트
    updateModalContent(round, drawData, shopsData);

    modalLoading.style.display = 'none';
    modalContent.style.display = 'block';

  } catch (error) {
    console.error('Failed to load round data:', error);
    modalLoading.innerHTML = '데이터를 불러오는데 실패했습니다.';
  }
}

// 모달 내용 업데이트
function updateModalContent(round, drawData, shopsData) {
  // 기본 정보 업데이트
  document.getElementById('modal-round').textContent = `${round}회`;
  document.getElementById('modal-date').textContent = drawData ?
    new Date(drawData.draw_date).toLocaleDateString('ko-KR') : '데이터 없음';
  document.getElementById('modal-status').textContent = drawData ? '저장됨' : '누락됨';

  // 당첨 번호 업데이트
  const numbersContainer = document.querySelector('#modal-numbers .numbers');
  const bonusElement = document.getElementById('modal-bonus');

  if (drawData && drawData.numbers) {
    // 당첨 번호 표시
    numbersContainer.innerHTML = drawData.numbers.map(num =>
      `<span class="number">${num}</span>`
    ).join('');
    bonusElement.textContent = drawData.bonus || '-';
  } else {
    numbersContainer.innerHTML = '<span class="no-data-message">당첨 번호 정보가 없습니다</span>';
    bonusElement.textContent = '-';
  }

  // 판매점 정보 업데이트
  const shopsContainer = document.getElementById('modal-shops');

  if (shopsData && shopsData.length > 0) {
    shopsContainer.innerHTML = shopsData.map(shop => `
      <div class="shop-item">
        <div class="shop-rank">${shop.rank}등 당첨점</div>
        <div class="shop-name">${shop.name}</div>
        ${shop.method ? `<div class="shop-method">${shop.method}</div>` : ''}
        ${shop.address ? `<div class="shop-address">${shop.address}</div>` : ''}
        ${shop.winners_count ? `<div class="shop-winners">당첨자 수: ${shop.winners_count}명</div>` : ''}
      </div>
    `).join('');
  } else {
    shopsContainer.innerHTML = '<div class="no-data-message">판매점 정보가 없습니다</div>';
  }
}

// 모달 닫기
function closeRoundModal() {
  document.getElementById('round-modal').style.display = 'none';
  window.currentModalRound = null;
}

// 모달 바깥 영역 클릭시 닫기
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('round-modal');
  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeRoundModal();
    }
  });

  // ESC 키로 모달 닫기
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeRoundModal();
    }
  });
});

// 특정 회차 재수집
async function crawlSpecificRound() {
  if (!window.currentModalRound) return;

  const confirmed = confirm(`${window.currentModalRound}회차를 다시 수집하시겠습니까?`);
  if (!confirmed) return;

  try {
    const formData = new FormData();
    formData.append('round', window.currentModalRound);
    formData.append('data_type', 'both');
    formData.append('csrf_token', window.csrfToken);

    const response = await fetch('/update', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      alert(`${window.currentModalRound}회차 수집이 시작되었습니다.`);
      closeRoundModal();
      // 크롤링 진행 상태 모니터링 시작
      startProgressMonitoring();
    } else {
      alert('수집 요청에 실패했습니다.');
    }
  } catch (error) {
    console.error('Crawl request failed:', error);
    alert('수집 요청 중 오류가 발생했습니다.');
  }
}

// 상세 분석 보기
function viewDrawDetail() {
  if (!window.currentModalRound) return;

  // 새 탭에서 회차 상세 페이지 열기
  const url = `/draw-info?round=${window.currentModalRound}`;
  window.open(url, '_blank');
}
</script>
{% endblock %}
