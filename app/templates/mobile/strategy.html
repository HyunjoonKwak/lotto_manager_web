{% extends "mobile/base.html" %}

{% block title %}모바일 전략분석{% endblock %}

{% block content %}
<!-- 모바일 헤더 -->
<div class="mobile-header">
  <div class="title">
    <h1>📊 전략분석</h1>
    <div class="subtitle">AI 기반 번호 추천</div>
  </div>
</div>

<!-- 추천 번호 카드 -->
{% if recommendations %}
<div class="mobile-card">
  <div class="card-header">
    <h2>🎯 AI 추천 번호</h2>
    <button class="refresh-btn" onclick="refreshRecommendations()">🔄</button>
  </div>

  {% for rec in recommendations[:3] %}
  <div class="recommendation-item">
    <div class="rec-header">
      <span class="rec-type">AI 추천 #{{ loop.index }}</span>
      <span class="rec-score">추천</span>
    </div>

    <div class="numbers">
      {% for num in rec %}
      <span class="number">{{ num }}</span>
      {% endfor %}
    </div>

    <div class="rec-actions">
      <button class="btn-small btn-primary" onclick="addToPurchase('{{ rec|join(',') }}')">
        구매 추가
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- 구매 목록 -->
{% if purchases %}
<div class="mobile-card">
  <div class="card-header">
    <h2>🛒 최근 구매</h2>
    <span class="count">{{ purchases|length }}건</span>
  </div>

  <div class="purchase-list">
    {% for purchase in purchases[:5] %}
    <div class="purchase-item">
      <div class="purchase-header">
        <span class="purchase-date">{{ purchase.purchase_date.strftime('%m/%d %H:%M') }}</span>
        <span class="purchase-round">{{ purchase.round }}회</span>
      </div>

      <div class="numbers">
        {% for num in purchase.numbers.split(',') %}
        <span class="number small">{{ num }}</span>
        {% endfor %}
      </div>

      {% if purchase.winning_amount %}
      <div class="winning-result">
        <span class="winning-amount">{{ "{:,}".format(purchase.winning_amount) }}원 당첨!</span>
      </div>
      {% endif %}
    </div>
    {% endfor %}

    {% if purchases|length > 5 %}
    <div class="more-items">
      <a href="{{ url_for('main.purchase_history') }}">전체 구매내역 보기 →</a>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- 통계 카드 -->
<div class="mobile-card">
  <div class="card-header">
    <h2>📈 나의 통계</h2>
  </div>

  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-number">{{ total_purchases or 0 }}</div>
      <div class="stat-label">총 구매</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ total_spent or 0 | int }}원</div>
      <div class="stat-label">총 구매금액</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ total_winnings or 0 | int }}원</div>
      <div class="stat-label">총 당첨금액</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ win_rate or 0 }}%</div>
      <div class="stat-label">당첨률</div>
    </div>
  </div>
</div>

<!-- 수동 번호 입력 (개선된 버전) -->
<div class="mobile-card">
  <div class="card-header">
    <h2>✏️ 수동 번호 입력</h2>
  </div>

  <!-- 입력 방식 선택 -->
  <div class="input-tabs">
    <button class="tab-button" data-method="grid" onclick="switchMobileMethod('grid')">
      🎯 직접 선택
    </button>
    <button class="tab-button active" data-method="text" onclick="switchMobileMethod('text')">
      ✏️ 텍스트 입력
    </button>
    <button class="tab-button" data-method="random" onclick="switchMobileMethod('random')">
      🎲 랜덤
    </button>
  </div>

  <!-- 회차 입력 -->
  <div class="round-input-section">
    <label>대상 회차 (선택사항)</label>
    <input type="number" id="mobileRound" placeholder="자동 설정" class="mobile-input">
  </div>

  <!-- 그리드 선택 방식 -->
  <div class="input-method-mobile grid-method">
    <div class="mobile-number-grid">
      {% for i in range(1, 46) %}
      <button class="mobile-number-btn" data-number="{{ i }}" onclick="toggleMobileNumber({{ i }})">{{ i }}</button>
      {% endfor %}
    </div>

    <div class="mobile-selected">
      <div class="selected-info">
        <span>선택된 번호 (<span id="mobileSelectedCount">0</span>/6)</span>
        <button class="clear-mobile-btn" onclick="clearMobileSelection()">초기화</button>
      </div>
      <div class="mobile-selected-display" id="mobileSelectedDisplay">
        번호를 선택하세요
      </div>
    </div>
  </div>

  <!-- 텍스트 입력 방식 -->
  <div class="input-method-mobile text-method active">
    <div class="text-input-section">
      <label>번호 입력 (1-45 사이의 6개 숫자)</label>
      <input type="text" id="mobileNumbers" placeholder="예: 1, 7, 12, 23, 32, 40" class="mobile-input">
      <button class="mobile-btn secondary" onclick="parseMobileNumbers()">번호 적용</button>
    </div>

    <!-- 텍스트 입력에서도 선택된 번호 표시 -->
    <div class="mobile-selected">
      <div class="selected-info">
        <span>선택된 번호 (<span id="mobileSelectedCountText">0</span>/6)</span>
        <button class="clear-mobile-btn" onclick="clearMobileSelection()">초기화</button>
      </div>
      <div class="mobile-selected-display" id="mobileSelectedDisplayText">
        번호를 입력하고 적용 버튼을 눌러주세요
      </div>
    </div>
  </div>

  <!-- 랜덤 생성 방식 -->
  <div class="input-method-mobile random-method">
    <div class="random-buttons">
      <button class="mobile-btn secondary" onclick="generateMobileRandom()">🎲 완전 랜덤</button>
      <button class="mobile-btn secondary" onclick="generateMobileRandom('hot')">🔥 빈출번호 기반</button>
      <button class="mobile-btn secondary" onclick="generateMobileRandom('cold')">❄️ 미출번호 기반</button>
    </div>
  </div>

  <!-- 추가 버튼 -->
  <div class="add-section">
    <button class="mobile-btn primary large" id="mobileAddBtn" onclick="addMobileNumbers()" disabled>
      ➕ 번호 추가하기
    </button>
  </div>
</div>

<!-- 빠른 액션 -->
<div class="mobile-card">
  <div class="card-header">
    <h2>🎲 빠른 액션</h2>
  </div>

  <div class="action-buttons">
    <button class="btn-action" onclick="getNewRecommendation()">
      <span class="action-icon">🔮</span>
      <span class="action-text">새 추천받기</span>
    </button>
    <button class="btn-action" onclick="quickPurchase()">
      <span class="action-icon">⚡</span>
      <span class="action-text">빠른 구매</span>
    </button>
    <a href="{{ url_for('main.crawling_page') }}" class="btn-action">
      <span class="action-icon">🔄</span>
      <span class="action-text">데이터 업데이트</span>
    </a>
  </div>
</div>

<!-- 데스크톱 버전 링크 -->
<div class="desktop-link">
  <a href="{{ url_for('main.strategy') }}?desktop=1" class="link-desktop">
    🖥️ 데스크톱 버전으로 보기
  </a>
</div>
{% endblock %}

{% block scripts %}
<style>
.refresh-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 0.3rem 0.6rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  cursor: pointer;
}

.recommendation-item {
  padding: 1rem;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
  margin-bottom: 0.5rem;
  border-radius: 0.8rem;
}

.recommendation-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.rec-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.rec-type {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
}

.rec-score {
  font-size: 0.8rem;
  color: #718096;
  font-weight: 500;
}

.rec-reason {
  font-size: 0.8rem;
  color: #4a5568;
  margin: 0.5rem 0;
  line-height: 1.4;
}

.rec-actions {
  margin-top: 0.5rem;
}

.btn-small {
  padding: 0.4rem 0.8rem;
  font-size: 0.8rem;
  border-radius: 0.5rem;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.purchase-list {
  padding: 1rem;
}

.purchase-item {
  padding: 0.8rem;
  background: #f8fafc;
  margin-bottom: 0.5rem;
  border-radius: 0.8rem;
  border-left: 3px solid #4299e1;
}

.purchase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.purchase-date {
  font-size: 0.85rem;
  color: #718096;
}

.purchase-round {
  font-size: 0.8rem;
  background: #e2e8f0;
  padding: 0.2rem 0.5rem;
  border-radius: 0.3rem;
  color: #4a5568;
  font-weight: 500;
}

.number.small {
  width: 2rem;
  height: 2rem;
  font-size: 0.75rem;
}

.winning-result {
  margin-top: 0.5rem;
}

.winning-amount {
  color: #e53e3e;
  font-weight: 700;
  font-size: 0.9rem;
}

.more-items {
  text-align: center;
  padding: 0.8rem;
}

.more-items a {
  color: #4299e1;
  text-decoration: none;
  font-weight: 500;
  font-size: 0.9rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  padding: 1rem;
}

.stat-item {
  text-align: center;
  padding: 1rem;
  background: linear-gradient(135deg, #f7fafc, #edf2f7);
  border-radius: 0.8rem;
}

.stat-number {
  font-size: 1.2rem;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 0.3rem;
}

.stat-label {
  font-size: 0.8rem;
  color: #718096;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 1rem;
}

.btn-action {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f7fafc, #edf2f7);
  border: 1px solid #e2e8f0;
  border-radius: 0.8rem;
  text-decoration: none;
  color: #4a5568;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-action:active {
  transform: scale(0.98);
  background: linear-gradient(135deg, #edf2f7, #e2e8f0);
}

.action-icon {
  font-size: 1.3rem;
}

.action-text {
  font-size: 0.9rem;
}

/* 모바일 수동 입력 개선 스타일 */
.input-tabs {
  display: flex;
  background: #f1f5f9;
  border-radius: 0.8rem;
  padding: 0.3rem;
  margin-bottom: 1rem;
}

.tab-button {
  flex: 1;
  padding: 0.6rem 0.4rem;
  border: none;
  background: transparent;
  border-radius: 0.5rem;
  font-size: 0.8rem;
  font-weight: 500;
  color: #64748b;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.tab-button.active {
  background: white;
  color: #1e40af;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.input-method-mobile {
  display: none;
  padding: 1rem;
}

.input-method-mobile.active {
  display: block;
}

.round-input-section {
  margin-bottom: 1.5rem;
}

.round-input-section label {
  display: block;
  font-size: 0.85rem;
  color: #4a5568;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.mobile-input {
  width: 100%;
  padding: 0.8rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.6rem;
  font-size: 1rem;
  background: white;
  transition: border-color 0.2s;
}

.mobile-input:focus {
  outline: none;
  border-color: #4299e1;
}

.mobile-number-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 0.6rem;
  margin-bottom: 1.5rem;
}

.mobile-number-btn {
  aspect-ratio: 1;
  border: 2px solid #e2e8f0;
  background: white;
  border-radius: 0.6rem;
  font-size: 0.9rem;
  font-weight: 600;
  color: #4a5568;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
}

.mobile-number-btn:active {
  transform: scale(0.95);
}

.mobile-number-btn.selected {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  border-color: #3182ce;
  color: white;
  transform: scale(1.05);
}

.mobile-selected {
  background: #f8fafc;
  border-radius: 0.8rem;
  padding: 1rem;
  margin-bottom: 1rem;
}

.selected-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.8rem;
  font-size: 0.85rem;
  font-weight: 500;
  color: #4a5568;
}

.clear-mobile-btn {
  background: #ef4444;
  color: white;
  border: none;
  padding: 0.4rem 0.8rem;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
}

.mobile-selected-display {
  min-height: 3rem;
  background: white;
  border: 2px dashed #cbd5e0;
  border-radius: 0.6rem;
  padding: 0.8rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  color: #718096;
}

.mobile-selected-display .number {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  color: white;
  padding: 0.3rem 0.6rem;
  border-radius: 0.4rem;
  font-weight: 600;
  font-size: 0.8rem;
}

.text-input-section {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.text-input-section label {
  font-size: 0.85rem;
  color: #4a5568;
  font-weight: 500;
}

.mobile-btn {
  padding: 0.8rem 1.2rem;
  border: none;
  border-radius: 0.6rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.mobile-btn.primary {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  color: white;
}

.mobile-btn.primary:active {
  transform: scale(0.98);
  background: linear-gradient(135deg, #3182ce, #2c5aa0);
}

.mobile-btn.secondary {
  background: #f1f5f9;
  color: #4a5568;
  border: 1px solid #e2e8f0;
}

.mobile-btn.secondary:active {
  background: #e2e8f0;
}

.mobile-btn.large {
  font-size: 1rem;
  padding: 1rem 1.5rem;
}

.mobile-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.random-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.add-section {
  margin-top: 1.5rem;
  text-align: center;
}
</style>

<script>
// 추천 새로고침
async function refreshRecommendations() {
  const response = await fetch('/api/refresh-recommendations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });

  if (response.ok) {
    window.location.reload();
  } else {
    alert('추천 새로고침에 실패했습니다.');
  }
}

// 구매 추가
function addToPurchase(numbers) {
  // 간단한 확인 후 구매 페이지로 이동
  const confirmed = confirm(`추천 번호 ${numbers}를 구매하시겠습니까?`);
  if (confirmed) {
    // 구매 페이지로 리다이렉트 (번호 포함)
    window.location.href = `/purchases?auto_numbers=${encodeURIComponent(numbers)}`;
  }
}

// 새 추천받기
async function getNewRecommendation() {
  const response = await fetch('/api/recommend');
  if (response.ok) {
    window.location.reload();
  } else {
    alert('새 추천을 받는데 실패했습니다.');
  }
}

// 빠른 구매
function quickPurchase() {
  window.location.href = '{{ url_for("main.purchase_history") }}';
}

// 모바일 수동 입력 기능
let mobileSelectedNumbers = [];

// 입력 방식 변경
function switchMobileMethod(method, keepSelection = false) {
  // 탭 버튼 활성화
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.method === method) {
      btn.classList.add('active');
    }
  });

  // 입력 방식 화면 변경
  document.querySelectorAll('.input-method-mobile').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelector(`.${method}-method`).classList.add('active');

  // 선택 유지 옵션이 없으면 초기화
  if (!keepSelection) {
    clearMobileSelection();
  }
}

// 번호 선택/해제
function toggleMobileNumber(num) {
  const index = mobileSelectedNumbers.indexOf(num);

  if (index > -1) {
    // 이미 선택된 번호면 제거
    mobileSelectedNumbers.splice(index, 1);
    document.querySelector(`[data-number="${num}"]`).classList.remove('selected');
  } else {
    // 6개 초과 선택 방지
    if (mobileSelectedNumbers.length >= 6) {
      alert('최대 6개 번호까지 선택할 수 있습니다.');
      return;
    }
    // 새 번호 추가
    mobileSelectedNumbers.push(num);
    document.querySelector(`[data-number="${num}"]`).classList.add('selected');
  }

  updateMobileDisplay();
}

// 선택된 번호 화면 업데이트
function updateMobileDisplay() {
  const countElement = document.getElementById('mobileSelectedCount');
  const displayElement = document.getElementById('mobileSelectedDisplay');
  const countElementText = document.getElementById('mobileSelectedCountText');
  const displayElementText = document.getElementById('mobileSelectedDisplayText');
  const addBtn = document.getElementById('mobileAddBtn');

  // 선택된 번호 개수 업데이트
  const count = mobileSelectedNumbers.length;
  console.log('updateMobileDisplay 호출됨, 선택된 번호:', mobileSelectedNumbers);

  if (countElement) countElement.textContent = count;
  if (countElementText) countElementText.textContent = count;

  // 선택된 번호 표시
  let displayHTML;
  if (count === 0) {
    displayHTML = '번호를 선택하세요';
    if (displayElementText) displayElementText.innerHTML = '번호를 입력하고 적용 버튼을 눌러주세요';
  } else {
    const sortedNumbers = [...mobileSelectedNumbers].sort((a, b) => a - b);
    displayHTML = sortedNumbers.map(num =>
      `<span class="number">${num}</span>`
    ).join('');
    if (displayElementText) displayElementText.innerHTML = displayHTML;
  }
  if (displayElement) displayElement.innerHTML = displayHTML;

  // 추가 버튼 활성화/비활성화
  if (addBtn) {
    addBtn.disabled = count !== 6;
    console.log('추가 버튼 상태:', addBtn.disabled ? '비활성화' : '활성화');
  }
}

// 선택 초기화
function clearMobileSelection() {
  mobileSelectedNumbers = [];
  document.querySelectorAll('.mobile-number-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  const textInput = document.getElementById('mobileNumbers');
  if (textInput) {
    textInput.value = '';
  }
  updateMobileDisplay();
}

// 텍스트 입력 번호 처리
function parseMobileNumbers() {
  console.log('parseMobileNumbers 함수 호출됨');

  const input = document.getElementById('mobileNumbers').value.trim();
  console.log('입력된 텍스트:', input);

  if (!input) {
    alert('번호를 입력해주세요.');
    return;
  }

  // 숫자 추출 (쉼표, 공백, 하이픈 등으로 구분)
  const numbers = input.match(/\d+/g);
  console.log('추출된 숫자들:', numbers);

  if (!numbers || numbers.length !== 6) {
    alert('정확히 6개의 번호를 입력해주세요.');
    return;
  }

  // 번호 유효성 검사
  const validNumbers = [];
  for (let numStr of numbers) {
    const num = parseInt(numStr);
    if (num < 1 || num > 45) {
      alert(`${num}은 유효하지 않은 번호입니다. (1-45 사이의 번호만 가능)`);
      return;
    }
    if (validNumbers.includes(num)) {
      alert(`${num}은 중복된 번호입니다.`);
      return;
    }
    validNumbers.push(num);
  }

  console.log('유효한 번호들:', validNumbers);

  // 배열에 번호 설정
  mobileSelectedNumbers = [...validNumbers];

  console.log('mobileSelectedNumbers 설정 완료:', mobileSelectedNumbers);
  console.log('현재 활성 탭:', document.querySelector('.tab-button.active')?.dataset.method);

  // 화면 업데이트
  updateMobileDisplay();

  // 성공 메시지
  const sortedNumbers = validNumbers.sort((a,b) => a-b);
  alert(`번호가 적용되었습니다!\n선택된 번호: ${sortedNumbers.join(', ')}\n\n이제 하단의 "번호 추가하기" 버튼을 눌러주세요.`);
}

// 랜덤 번호 생성
function generateMobileRandom(type = 'normal') {
  clearMobileSelection();

  let numbers = [];

  if (type === 'hot') {
    // 빈출번호 기반 (실제로는 가중치 적용해야 하지만 여기서는 단순화)
    const hotNumbers = [1, 7, 17, 23, 27, 31, 34, 40, 43, 44]; // 예시 빈출번호
    while (numbers.length < 6) {
      const num = hotNumbers[Math.floor(Math.random() * hotNumbers.length)];
      if (!numbers.includes(num)) {
        numbers.push(num);
      }
    }
  } else if (type === 'cold') {
    // 미출번호 기반
    const coldNumbers = [2, 8, 13, 16, 22, 28, 33, 37, 39, 42]; // 예시 미출번호
    while (numbers.length < 6) {
      const num = coldNumbers[Math.floor(Math.random() * coldNumbers.length)];
      if (!numbers.includes(num)) {
        numbers.push(num);
      }
    }
  } else {
    // 완전 랜덤
    while (numbers.length < 6) {
      const num = Math.floor(Math.random() * 45) + 1;
      if (!numbers.includes(num)) {
        numbers.push(num);
      }
    }
  }

  // 선택된 번호들을 배열에 추가
  numbers.forEach(num => {
    mobileSelectedNumbers.push(num);
    document.querySelector(`[data-number="${num}"]`).classList.add('selected');
  });

  // 그리드 방식으로 전환하여 선택 표시 (선택 상태 유지)
  switchMobileMethod('grid', true);
  updateMobileDisplay();
}

// 번호 추가하기
function addMobileNumbers() {
  if (mobileSelectedNumbers.length !== 6) {
    alert('6개의 번호를 모두 선택해주세요.');
    return;
  }

  const round = document.getElementById('mobileRound').value;
  const numbers = [...mobileSelectedNumbers].sort((a, b) => a - b);

  // 구매 페이지로 이동 (번호 포함)
  const params = new URLSearchParams();
  params.append('auto_numbers', numbers.join(','));
  if (round) {
    params.append('round', round);
  }

  window.location.href = `/purchases?${params.toString()}`;
}

// 즉시 실행으로 기본 체크
console.log('모바일 전략분석 페이지 JavaScript 로드됨');
console.log('현재 URL:', window.location.href);
console.log('User Agent:', navigator.userAgent);

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded 이벤트 발생');
  console.log('페이지 로드 완료, 초기화 시작');

  // DOM 요소 존재 확인
  const addBtn = document.getElementById('mobileAddBtn');
  const textInput = document.getElementById('mobileNumbers');
  const countText = document.getElementById('mobileSelectedCountText');

  console.log('DOM 요소 확인:');
  console.log('- mobileAddBtn:', addBtn ? '존재' : '없음');
  console.log('- mobileNumbers:', textInput ? '존재' : '없음');
  console.log('- mobileSelectedCountText:', countText ? '존재' : '없음');

  // 텍스트 입력 탭을 기본으로 설정
  switchMobileMethod('text');

  // 초기 상태 업데이트
  updateMobileDisplay();

  console.log('초기화 완료');
});
</script>
{% endblock %}
