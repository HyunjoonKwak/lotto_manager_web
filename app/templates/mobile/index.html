{% extends "mobile/base.html" %}

{% block title %}ëª¨ë°”ì¼ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
</script>

<!-- ëª¨ë°”ì¼ í—¤ë” -->
<div class="mobile-header">
  <div class="title">
    <h1>ğŸ¯ ë¡œë˜ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="subtitle">ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</div>
  </div>

  <!-- í˜„ì¬ ì‹œê°„ ë° ì¹´ìš´íŠ¸ë‹¤ìš´ -->
  <div class="time-section">
    <div class="current-time" id="currentTime"></div>
    <div class="countdown" id="nextDrawCountdown"></div>
  </div>
</div>

<!-- ìƒˆ íšŒì°¨ ì•Œë¦¼ (ëª¨ë°”ì¼ìš©) -->
<div class="mobile-alert" id="newDrawAlert" style="display: none;">
  <div class="alert-content">
    <span class="alert-icon">âš¡</span>
    <span class="alert-text" id="alertMessage">ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span>
  </div>
  <button class="alert-btn" onclick="checkForNewDraw()">ì§€ê¸ˆ í™•ì¸í•˜ê¸°</button>
</div>

<!-- ìµœì‹  ì¶”ì²¨ ê²°ê³¼ -->
{% if latest %}
<div class="mobile-card">
  <div class="card-header">
    <h2>{{ latest.round }}íšŒ ìµœì‹  ê²°ê³¼</h2>
    <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
  </div>

  <div class="numbers-section">
    <div class="numbers">
      {% for num in latest.numbers_list() %}
      <span class="number">{{ num }}</span>
      {% endfor %}
    </div>
    <div class="bonus-section">
      <span class="plus">+</span>
      <span class="bonus number">{{ latest.bonus }}</span>
      <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
    </div>
  </div>

  <div class="mobile-actions">
    <button class="btn-primary" id="checkNewDrawBtn" onclick="checkForNewDraw()">
      ìƒˆ íšŒì°¨ í™•ì¸
    </button>
    <a href="https://dhlottery.co.kr/gameResult.do?method=byWin" target="_blank" class="btn-lotto">
      ğŸ² ë¡œë˜êµ¬ë§¤
    </a>
  </div>
</div>
{% else %}
<div class="mobile-card error">
  <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
  <p>ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì •ë³´ì¡°íšŒì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
</div>
{% endif %}

<!-- ë‹¹ì²¨ì  ì •ë³´ -->
{% if latest and shops_rank1 %}
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸª {{ latest.round }}íšŒ 1ë“± ë‹¹ì²¨ì </h2>
    <span class="count">{{ shops_rank1|length }}ê°œ</span>
  </div>

  {% if shops_rank1|length > 0 %}
  <div class="shops-list">
    {% for shop in shops_rank1[:3] %}
    <div class="shop-item">
      <div class="shop-name">{{ shop.name }}</div>
      <div class="shop-method">{{ shop.method or 'êµ¬ë¶„ì—†ìŒ' }}</div>
      <div class="shop-address">{{ shop.address }}</div>
    </div>
    {% endfor %}
    {% if shops_rank1|length > 3 %}
    <div class="more-shops">
      ì™¸ {{ shops_rank1|length - 3 }}ê°œ ë”ë³´ê¸° â†’
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- ë¹ ë¥¸ ë©”ë‰´ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ”— ë¹ ë¥¸ ë©”ë‰´</h2>
  </div>

  <div class="quick-menu">
    <a href="{{ url_for('main.strategy') }}" class="menu-item">
      <span class="menu-icon">ğŸ“Š</span>
      <span class="menu-text">ì „ëµë¶„ì„</span>
    </a>
    <a href="{{ url_for('main.purchase_history') }}" class="menu-item">
      <span class="menu-icon">ğŸ›’</span>
      <span class="menu-text">êµ¬ë§¤ë‚´ì—­</span>
    </a>
    <a href="{{ url_for('main.info_page') }}" class="menu-item">
      <span class="menu-icon">ğŸ“‹</span>
      <span class="menu-text">ì •ë³´ì¡°íšŒ</span>
    </a>
    <a href="{{ url_for('main.crawling_page') }}" class="menu-item">
      <span class="menu-icon">ğŸ”„</span>
      <span class="menu-text">ë°ì´í„°ìˆ˜ì§‘</span>
    </a>
  </div>
</div>

<!-- ë°ìŠ¤í¬í†± ë²„ì „ ë§í¬ -->
<div class="desktop-link">
  <a href="/?desktop=1" class="link-desktop">
    ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ë²„ì „ìœ¼ë¡œ ë³´ê¸°
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// ëª¨ë°”ì¼ìš© ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateCurrentTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  const dateStr = now.toLocaleDateString('ko-KR', {
    month: 'long',
    day: 'numeric',
    weekday: 'short'
  });
  document.getElementById('currentTime').textContent = `${dateStr} ${timeStr}`;
}

// ì¹´ìš´íŠ¸ë‹¤ìš´ í•¨ìˆ˜ (ì¼ë°˜ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
function updateCountdown() {
  const now = new Date();

  // ë‹¤ìŒ í† ìš”ì¼ 8ì‹œ 45ë¶„ ê³„ì‚° (ë¡œë˜ ì¶”ì²¨ ì‹œê°„) - ì¼ë°˜ í˜ì´ì§€ì™€ ë™ì¼
  let nextSaturday = new Date(now);
  const daysUntilSaturday = (6 - now.getDay()) % 7; // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼

  if (now.getDay() === 6) {  // í˜„ì¬ê°€ í† ìš”ì¼
    if (now.getHours() < 20 || (now.getHours() === 20 && now.getMinutes() < 45)) {
      // ì˜¤ëŠ˜ ì¶”ì²¨ ì „ì´ë©´ ì˜¤ëŠ˜
      nextSaturday.setHours(20, 45, 0, 0);
    } else {
      // ì˜¤ëŠ˜ ì¶”ì²¨ì´ ëë‚¬ìœ¼ë©´ ë‹¤ìŒ ì£¼ í† ìš”ì¼
      nextSaturday.setDate(now.getDate() + 7);
      nextSaturday.setHours(20, 45, 0, 0);
    }
  } else {
    // ë‹¤ìŒ í† ìš”ì¼ë¡œ ì„¤ì •
    nextSaturday.setDate(now.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday));
    nextSaturday.setHours(20, 45, 0, 0);
  }

  const timeDiff = nextSaturday - now;

  if (timeDiff <= 0) {
    document.getElementById('nextDrawCountdown').innerHTML = '<span class="countdown-icon">ğŸ¯</span><span class="countdown-text">ì¶”ì²¨ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</span>';
    return;
  }

  const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

  let countdownHtml = '<span class="countdown-icon">ğŸ¯</span>';

  if (days > 0) {
    // ë‚ ì§œ ë‹¨ìœ„ë¡œ í‘œì‹œ (í•˜ë£¨ ì´ìƒ ë‚¨ìŒ) - ëª¨ë°”ì¼ì€ í•­ìƒ ì¤„ë°”ê¿ˆ í¬í•¨
    countdownHtml += `<span class="countdown-text">ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€<br>${days}ì¼ ${hours}ì‹œê°„</span>`;
  } else {
    // ì‹œê°„/ë¶„/ì´ˆ ë‹¨ìœ„ë¡œ í‘œì‹œ (í•˜ë£¨ ì´í•˜ ë‚¨ìŒ)
    if (hours > 0) {
      countdownHtml += `<span class="countdown-text">ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€<br>${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ</span>`;
    } else if (minutes > 0) {
      countdownHtml += `<span class="countdown-text">ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€<br>${minutes}ë¶„ ${seconds}ì´ˆ</span>`;
    } else {
      countdownHtml += `<span class="countdown-text">${seconds}ì´ˆ í›„ ì¶”ì²¨</span>`;
    }
  }

  document.getElementById('nextDrawCountdown').innerHTML = countdownHtml;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  updateCurrentTime();
  updateCountdown();

  setInterval(() => {
    updateCurrentTime();
    updateCountdown();
  }, 1000);

  checkIfNewDrawNeeded();
});

// ìƒˆ íšŒì°¨ í™•ì¸ì´ í•„ìš”í•œì§€ ì²´í¬ (ì¼ë°˜ í˜ì´ì§€ì™€ ì™„ì „íˆ ë™ì¼í•œ ë¡œì§)
function checkIfNewDrawNeeded() {
  const drawDateText = document.querySelector('.draw-date');
  if (!drawDateText || !drawDateText.textContent.trim()) return;

  // ì¶”ì²¨ë‚ ì§œ íŒŒì‹± (YYYY-MM-DD í˜•ì‹ ê°€ì •)
  const drawDate = new Date(drawDateText.textContent.trim());
  const today = new Date();

  // ë‹¤ìŒ í† ìš”ì¼ 8ì‹œ 45ë¶„ ê³„ì‚° (ë¡œë˜ ì¶”ì²¨ ì‹œê°„) - ì¼ë°˜ í˜ì´ì§€ì™€ ë™ì¼
  const nextSaturday = new Date(today);
  const daysUntilSaturday = (6 - today.getDay()) % 7; // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
  if (daysUntilSaturday === 0 && today.getHours() < 21) {
    // ì˜¤ëŠ˜ì´ í† ìš”ì¼ì´ê³  ì¶”ì²¨ ì „ì´ë©´
    nextSaturday.setHours(20, 45, 0, 0);
  } else {
    // ë‹¤ìŒ í† ìš”ì¼ë¡œ ì„¤ì •
    nextSaturday.setDate(today.getDate() + (daysUntilSaturday || 7));
    nextSaturday.setHours(20, 45, 0, 0);
  }

  // ë§ˆì§€ë§‰ ì¶”ì²¨ì—ì„œ ë‹¤ìŒ ì¶”ì²¨ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
  const weeksSinceLastDraw = Math.floor((today - drawDate) / (1000 * 60 * 60 * 24 * 7));
  const shouldHaveNewDraw = weeksSinceLastDraw >= 1 && today >= nextSaturday;

  if (shouldHaveNewDraw) {
    const alertDiv = document.getElementById('newDrawAlert');
    if (alertDiv) {
      alertDiv.style.display = 'block';
      // ì•Œë¦¼ ë©”ì‹œì§€ë„ ë” êµ¬ì²´ì ìœ¼ë¡œ ë³€ê²½
      const alertMessage = document.getElementById('alertMessage');
      if (alertMessage) {
        const hoursLeft = Math.max(0, Math.floor((nextSaturday - today) / (1000 * 60 * 60)));
        if (hoursLeft > 0) {
          alertMessage.textContent = `ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤! (ë‹¤ìŒ ì¶”ì²¨: ${hoursLeft}ì‹œê°„ í›„)`;
        } else {
          alertMessage.textContent = 'ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
        }
      }
    }
  }
}

// ìƒˆ íšŒì°¨ í™•ì¸ í•¨ìˆ˜ (ì¼ë°˜ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§ ì ìš©)
async function checkForNewDraw() {
  const button = document.getElementById('checkNewDrawBtn');
  const originalText = button.innerHTML;

  button.disabled = true;
  button.innerHTML = '<span class="spinner">â³</span> í™•ì¸ì¤‘...';

  try {
    // ìƒˆë¡œìš´ íšŒì°¨ê°€ ìˆëŠ”ì§€ í™•ì¸
    const response = await fetch('/api/check-new-draw');
    const data = await response.json();

    // ìƒì„¸í•œ ë©”ì‹œì§€ ë¨¼ì € í‘œì‹œ
    let alertMessage = data.message || 'ìƒˆë¡œìš´ ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';

    // ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ í¬í•¨ (ëª¨ë°”ì¼ì—ì„œëŠ” ê°„ì†Œí™”)
    if (data.draw_completed && data.next_draw_time) {
      const nextDrawDate = new Date(data.next_draw_time);
      const formattedTime = nextDrawDate.toLocaleDateString('ko-KR', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      alertMessage += `\në‹¤ìŒ ì¶”ì²¨: ${formattedTime}`;
    } else if (!data.draw_completed && data.hours_until_draw > 0) {
      alertMessage += `\n(${data.hours_until_draw}ì‹œê°„ í›„ ì¶”ì²¨)`;
    }

    if (data.has_new_draw) {
      // ì¶”ì²¨ ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¥¸ ë‹¤ë¥¸ í™•ì¸ ë©”ì‹œì§€ (ëª¨ë°”ì¼ ìµœì í™”)
      let confirmMessage;
      if (data.draw_completed) {
        confirmMessage = `ğŸ¯ ${data.latest_round}íšŒ ì¶”ì²¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìƒˆë¡œìš´ ê²°ê³¼ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      } else {
        confirmMessage = `ğŸ“ˆ ${data.latest_round}íšŒ ê²°ê³¼ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.\n\nì§€ê¸ˆ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      }

      const confirmed = confirm(confirmMessage);

      if (confirmed) {
        button.innerHTML = '<span class="spinner">â³</span> ì—…ë°ì´íŠ¸ì¤‘...';

        // ìµœì‹  íšŒì°¨ ë°ì´í„° ì—…ë°ì´íŠ¸
        const updateResponse = await fetch('/api/update-new-draw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            round: data.latest_round,
            csrf_token: window.csrfToken
          })
        });

        const updateData = await updateResponse.json();

        if (updateData.success) {
          alert(`âœ… ${data.latest_round}íšŒ ì¶”ì²¨ ê²°ê³¼ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          // ì•Œë¦¼ ìˆ¨ê¸°ê¸°
          const alertDiv = document.getElementById('newDrawAlert');
          if (alertDiv) {
            alertDiv.style.display = 'none';
          }
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateData.message}`);
        }
      }
    } else {
      alert(alertMessage);
    }
  } catch (error) {
    console.error('Error checking for new draw:', error);
    alert('âŒ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
</script>
{% endblock %}
