{% extends "mobile/base.html" %}
{% block title %}êµ¬ë§¤ê´€ë¦¬ - ëª¨ë°”ì¼{% endblock %}
{% block content %}

<!-- CSRF Token -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>

<div class="mobile-header">
  <div class="title">
    <h1>ğŸ›’ êµ¬ë§¤ê´€ë¦¬</h1>
    <div class="subtitle">ë²ˆí˜¸ ì…ë ¥ ë° ê´€ë¦¬</div>
  </div>
</div>

<!-- íšŒì°¨ ì„ íƒ ì¹´ë“œ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ¯ íšŒì°¨ ì„ íƒ</h2>
  </div>

  <div style="padding: 1rem;">
    <div style="background: linear-gradient(135deg, #f7fafc, #edf2f7); padding: 1rem; border-radius: 0.8rem; margin-bottom: 1rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <span style="font-weight: 600; color: #4a5568;">ì„ íƒëœ íšŒì°¨</span>
        <span style="font-size: 1.5rem; font-weight: 700; color: #667eea;">{{ selected_round }}íšŒ</span>
      </div>
      <div style="font-size: 0.85rem; color: #718096; text-align: center;">
        {% if draw_info %}
          {{ draw_info['date'] }} ({{ draw_info['day'] }}) ì¶”ì²¨ ì˜ˆì •<br>
          <span style="color: #e53e3e; font-weight: 600;">{{ draw_info['dday'] }}</span>
        {% endif %}
      </div>
    </div>

    <div style="display: flex; gap: 0.5rem;">
      {% for i in range(max(1, selected_round - 1), selected_round + 4) %}
      <button onclick="changeRound({{ i }})"
              class="round-btn {% if i == selected_round %}active{% endif %}"
              style="flex: 1; padding: 0.8rem; border: 2px solid {% if i == selected_round %}#667eea{% else %}#e2e8f0{% endif %};
                     background: {% if i == selected_round %}linear-gradient(135deg, #667eea, #764ba2){% else %}white{% endif %};
                     color: {% if i == selected_round %}white{% else %}#4a5568{% endif %};
                     border-radius: 0.5rem; font-weight: 600; font-size: 0.9rem; cursor: pointer;">
        {{ i }}íšŒ
      </button>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ì…ë ¥ ë°©ì‹ ì„ íƒ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ“ ì…ë ¥ ë°©ì‹</h2>
  </div>

  <div class="quick-menu" style="padding: 0.5rem;">
    <a href="{{ url_for('main.mobile_strategy') }}" class="menu-item" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">
      <div class="menu-icon">ğŸ¤–</div>
      <div class="menu-text">AI ì¶”ì²œ</div>
    </a>
    <button onclick="showManualInput()" class="menu-item" style="border: 2px solid #4299e1; cursor: pointer;">
      <div class="menu-icon">ğŸ¯</div>
      <div class="menu-text">ìˆ˜ë™ ì…ë ¥</div>
    </button>
    <button onclick="showTextInput()" class="menu-item" style="border: 2px solid #48bb78; cursor: pointer;">
      <div class="menu-icon">âŒ¨ï¸</div>
      <div class="menu-text">í…ìŠ¤íŠ¸ ì…ë ¥</div>
    </button>
    <button onclick="showRandomInput()" class="menu-item" style="border: 2px solid #ed8936; cursor: pointer;">
      <div class="menu-icon">ğŸ²</div>
      <div class="menu-text">ëœë¤ ìƒì„±</div>
    </button>
  </div>
</div>

<!-- ìˆ˜ë™ ì…ë ¥ ì„¹ì…˜ -->
<div id="manualInputSection" class="mobile-card" style="display: none;">
  <div class="card-header">
    <h2>ğŸ¯ ìˆ˜ë™ ì…ë ¥</h2>
    <button onclick="clearSelection()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.85rem; cursor: pointer;">
      ì´ˆê¸°í™”
    </button>
  </div>

  <div style="padding: 1rem;">
    <!-- ì„ íƒëœ ë²ˆí˜¸ í‘œì‹œ -->
    <div style="background: linear-gradient(135deg, #f7fafc, #edf2f7); padding: 1rem; border-radius: 0.8rem; margin-bottom: 1rem; min-height: 60px;">
      <div style="font-size: 0.85rem; color: #718096; margin-bottom: 0.5rem;">
        ì„ íƒëœ ë²ˆí˜¸ (<span id="selectedCount">0</span>/6)
      </div>
      <div id="selectedNumbers" style="display: flex; gap: 0.3rem; flex-wrap: wrap; min-height: 40px;"></div>
    </div>

    <!-- ë²ˆí˜¸ ê·¸ë¦¬ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;" id="numberGrid"></div>

    <button onclick="addManualNumbers()" class="btn-primary" style="width: 100%; margin-top: 1rem; padding: 1rem; font-size: 1rem;">
      ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    </button>
  </div>
</div>

<!-- í…ìŠ¤íŠ¸ ì…ë ¥ ì„¹ì…˜ -->
<div id="textInputSection" class="mobile-card" style="display: none;">
  <div class="card-header">
    <h2>âŒ¨ï¸ í…ìŠ¤íŠ¸ ì…ë ¥</h2>
  </div>

  <div style="padding: 1rem;">
    <div style="margin-bottom: 0.8rem;">
      <textarea id="textNumbers" placeholder="ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1,7,12,23,32,40)"
                style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 0.8rem; font-size: 1rem; min-height: 100px; resize: vertical;"></textarea>
      <div style="font-size: 0.85rem; color: #718096; margin-top: 0.5rem;">
        ğŸ’¡ ì½¤ë§ˆ(,) ë˜ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ 6ê°œ ë²ˆí˜¸ ì…ë ¥
      </div>
    </div>
    <button onclick="addTextNumbers()" class="btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
      ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    </button>
  </div>
</div>

<!-- ëœë¤ ìƒì„± ì„¹ì…˜ -->
<div id="randomInputSection" class="mobile-card" style="display: none;">
  <div class="card-header">
    <h2>ğŸ² ëœë¤ ìƒì„±</h2>
  </div>

  <div style="padding: 1rem;">
    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
      <button onclick="generateRandom('pure')" style="padding: 1rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 0.8rem; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
        ğŸ² ì™„ì „ ëœë¤
      </button>
      <button onclick="generateRandom('frequent')" style="padding: 1rem; background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; border-radius: 0.8rem; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
        ğŸ“Š ë¹ˆì¶œë²ˆí˜¸ ê¸°ë°˜
      </button>
      <button onclick="generateRandom('infrequent')" style="padding: 1rem; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; border-radius: 0.8rem; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
        ğŸ”® ë¯¸ì¶œë²ˆí˜¸ ê¸°ë°˜
      </button>
    </div>

    <!-- ìƒì„±ëœ ë²ˆí˜¸ í‘œì‹œ -->
    <div id="generatedNumbers" style="background: linear-gradient(135deg, #f7fafc, #edf2f7); padding: 1rem; border-radius: 0.8rem; margin-bottom: 1rem; min-height: 60px; display: none;">
      <div style="font-size: 0.85rem; color: #718096; margin-bottom: 0.5rem;">ìƒì„±ëœ ë²ˆí˜¸</div>
      <div id="generatedNumbersDisplay" style="display: flex; gap: 0.3rem; flex-wrap: wrap;"></div>
    </div>

    <button onclick="addGeneratedNumbers()" id="addGeneratedBtn" class="btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem; display: none;">
      ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    </button>
  </div>
</div>

<!-- ì¥ë°”êµ¬ë‹ˆ -->
<div class="mobile-card">
  <div class="card-header">
    <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>
    <span class="count" id="cartCount">{{ draft_purchases|length }}ê°œ</span>
  </div>

  <div id="cartList" style="padding: 1rem;">
    {% if draft_purchases %}
      {% for purchase in draft_purchases %}
      <div class="shop-item" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1;">
          <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem;">
            {% for num in purchase.numbers_list() %}
            <span style="width: 1.8rem; height: 1.8rem; border-radius: 50%; background: linear-gradient(135deg, #4299e1, #3182ce); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">{{ num }}</span>
            {% endfor %}
          </div>
          <div style="font-size: 0.8rem; color: #718096;">
            {{ purchase.purchase_round }}íšŒ |
            {% if purchase.source == 'ai' %}ğŸ¤– AI
            {% elif purchase.source == 'manual' %}ğŸ¯ ìˆ˜ë™
            {% elif purchase.source == 'random' %}ğŸ² ëœë¤
            {% elif purchase.source == 'qr' %}ğŸ“± QR
            {% else %}ğŸ“ ì…ë ¥{% endif %}
          </div>
        </div>
        <button onclick="deleteDraft({{ purchase.id }})" style="background: linear-gradient(135deg, #f56565, #e53e3e); color: white; border: none; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.85rem; cursor: pointer;">
          ì‚­ì œ
        </button>
      </div>
      {% endfor %}

      <button onclick="confirmAllPurchases()" class="btn-primary" style="width: 100%; margin-top: 1rem; padding: 1rem; font-size: 1rem; background: linear-gradient(135deg, #48bb78, #38a169);">
        ì „ì²´ êµ¬ë§¤ í™•ì • ({{ draft_purchases|length }}ê°œ)
      </button>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #718096;">
      <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ›’</div>
      <div style="font-size: 0.9rem;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- ë°ìŠ¤í¬í†± ë²„ì „ ë§í¬ -->
<div class="desktop-link">
  <a href="{{ url_for('main.buy') }}?desktop=1" class="link-desktop">
    ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ë²„ì „ìœ¼ë¡œ ë³´ê¸°
  </a>
</div>

<style>
  .number-ball {
    width: 2.2rem;
    height: 2.2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: white;
    background: linear-gradient(135deg, #4299e1, #3182ce);
    box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
  }

  .number-btn {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 50%;
    border: 2px solid #e2e8f0;
    background: white;
    color: #4a5568;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .number-btn.selected {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: #667eea;
    transform: scale(1.1);
  }

  .number-btn:active {
    transform: scale(0.95);
  }
</style>

{% endblock %}

{% block scripts %}
<script>
  let selectedNumbers = [];
  let currentRound = {{ selected_round }};
  let generatedNumbers = [];

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²ˆí˜¸ ê·¸ë¦¬ë“œ ìƒì„±
  document.addEventListener('DOMContentLoaded', function() {
    createNumberGrid();
  });

  // ë²ˆí˜¸ ê·¸ë¦¬ë“œ ìƒì„±
  function createNumberGrid() {
    const grid = document.getElementById('numberGrid');
    grid.innerHTML = '';

    for (let i = 1; i <= 45; i++) {
      const btn = document.createElement('button');
      btn.className = 'number-btn';
      btn.textContent = i;
      btn.onclick = () => toggleNumber(i);
      grid.appendChild(btn);
    }
  }

  // ë²ˆí˜¸ í† ê¸€
  function toggleNumber(num) {
    const index = selectedNumbers.indexOf(num);

    if (index > -1) {
      selectedNumbers.splice(index, 1);
    } else {
      if (selectedNumbers.length >= 6) {
        alert('ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      selectedNumbers.push(num);
    }

    selectedNumbers.sort((a, b) => a - b);
    updateSelectedDisplay();
    updateNumberButtons();
  }

  // ì„ íƒëœ ë²ˆí˜¸ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateSelectedDisplay() {
    const display = document.getElementById('selectedNumbers');
    const count = document.getElementById('selectedCount');

    count.textContent = selectedNumbers.length;
    display.innerHTML = '';

    selectedNumbers.forEach(num => {
      const ball = document.createElement('span');
      ball.className = 'number-ball';
      ball.textContent = num;
      display.appendChild(ball);
    });
  }

  // ë²ˆí˜¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateNumberButtons() {
    const buttons = document.querySelectorAll('.number-btn');
    buttons.forEach((btn, index) => {
      const num = index + 1;
      if (selectedNumbers.includes(num)) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
  }

  // ì„ íƒ ì´ˆê¸°í™”
  function clearSelection() {
    selectedNumbers = [];
    updateSelectedDisplay();
    updateNumberButtons();
  }

  // ì…ë ¥ ë°©ì‹ í‘œì‹œ
  function showManualInput() {
    hideAllInputSections();
    document.getElementById('manualInputSection').style.display = 'block';
  }

  function showTextInput() {
    hideAllInputSections();
    document.getElementById('textInputSection').style.display = 'block';
  }

  function showRandomInput() {
    hideAllInputSections();
    document.getElementById('randomInputSection').style.display = 'block';
  }

  function hideAllInputSections() {
    document.getElementById('manualInputSection').style.display = 'none';
    document.getElementById('textInputSection').style.display = 'none';
    document.getElementById('randomInputSection').style.display = 'none';
  }

  // íšŒì°¨ ë³€ê²½
  function changeRound(round) {
    window.location.href = `{{ url_for('main.mobile_buy') }}?round=${round}`;
  }

  // ìˆ˜ë™ ì…ë ¥ ì¶”ê°€
  async function addManualNumbers() {
    if (selectedNumbers.length !== 6) {
      alert('6ê°œì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    await addToCart(selectedNumbers, 'manual');
    clearSelection();
  }

  // í…ìŠ¤íŠ¸ ì…ë ¥ ì¶”ê°€
  async function addTextNumbers() {
    const text = document.getElementById('textNumbers').value.trim();
    if (!text) {
      alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const numbers = text.split(/[,\s]+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 45);

    if (numbers.length !== 6) {
      alert('ì •í™•íˆ 6ê°œì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1-45 ë²”ìœ„).');
      return;
    }

    await addToCart(numbers, 'manual');
    document.getElementById('textNumbers').value = '';
  }

  // ëœë¤ ìƒì„±
  async function generateRandom(type) {
    try {
      const response = await fetch(`/api/random-numbers?type=${type}&count=6`, {
        headers: {
          'X-CSRFToken': window.csrfToken
        }
      });

      if (!response.ok) throw new Error('ëœë¤ ìƒì„± ì‹¤íŒ¨');

      const data = await response.json();
      generatedNumbers = data.numbers.sort((a, b) => a - b);

      // í‘œì‹œ
      const display = document.getElementById('generatedNumbersDisplay');
      display.innerHTML = '';

      generatedNumbers.forEach(num => {
        const ball = document.createElement('span');
        ball.className = 'number-ball';
        ball.textContent = num;
        display.appendChild(ball);
      });

      document.getElementById('generatedNumbers').style.display = 'block';
      document.getElementById('addGeneratedBtn').style.display = 'block';

    } catch (error) {
      alert('ëœë¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(error);
    }
  }

  // ìƒì„±ëœ ë²ˆí˜¸ ì¶”ê°€
  async function addGeneratedNumbers() {
    if (generatedNumbers.length !== 6) {
      alert('ë¨¼ì € ë²ˆí˜¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    await addToCart(generatedNumbers, 'random');

    // ì´ˆê¸°í™”
    generatedNumbers = [];
    document.getElementById('generatedNumbers').style.display = 'none';
    document.getElementById('addGeneratedBtn').style.display = 'none';
  }

  // ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
  async function addToCart(numbers, source) {
    try {
      const response = await fetch('/api/purchases/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': window.csrfToken
        },
        body: JSON.stringify({
          numbers: numbers.join(','),
          round: currentRound,
          source: source
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        location.reload();
      } else {
        alert(result.message || 'ì¶”ê°€ ì‹¤íŒ¨');
      }

    } catch (error) {
      alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(error);
    }
  }

  // ì¥ë°”êµ¬ë‹ˆ í•­ëª© ì‚­ì œ
  async function deleteDraft(id) {
    if (!confirm('ì´ ë²ˆí˜¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
      const response = await fetch(`/api/purchases/draft/${id}/delete`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': window.csrfToken
        }
      });

      const result = await response.json();

      if (result.success) {
        location.reload();
      } else {
        alert(result.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }

    } catch (error) {
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(error);
    }
  }

  // ì „ì²´ êµ¬ë§¤ í™•ì •
  async function confirmAllPurchases() {
    if (!confirm('ì¥ë°”êµ¬ë‹ˆì˜ ëª¨ë“  ë²ˆí˜¸ë¥¼ êµ¬ë§¤ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
      const response = await fetch('/api/purchases/confirm', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': window.csrfToken
        }
      });

      const result = await response.json();

      if (result.success) {
        alert(`${result.count}ê°œì˜ ë²ˆí˜¸ê°€ êµ¬ë§¤ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        location.reload();
      } else {
        alert(result.message || 'êµ¬ë§¤ í™•ì • ì‹¤íŒ¨');
      }

    } catch (error) {
      alert('êµ¬ë§¤ í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(error);
    }
  }
</script>
{% endblock %}
