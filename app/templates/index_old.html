{% extends "base.html" %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
</script>

<div class="header">
  <div class="title-section">
    <h1>ğŸ  ëŒ€ì‹œë³´ë“œ</h1>
    <div class="muted">ë¡œë˜ ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</div>
  </div>
  <div class="date-section">
    <div class="current-date" id="currentDate"></div>
    <div class="countdown-date" id="nextDrawCountdown"></div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results -->
  {% if latest %}
  <section class="card highlight-card">
    <div class="card-header">
      <h2>ğŸ¯ {{ latest.round }}íšŒ ìµœì‹  ì¶”ì²¨ê²°ê³¼</h2>
      <div class="header-actions">
        <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
        <button id="checkNewDrawBtn" class="btn-update" onclick="checkForNewDraw()">
          ìƒˆ íšŒì°¨ í™•ì¸
        </button>
        <a href="https://dhlottery.co.kr/gameResult.do?method=byWin" target="_blank" class="btn-lotto-site">
          ğŸ² ë¡œë˜êµ¬ë§¤
        </a>
      </div>
    </div>

    <!-- ìƒˆ íšŒì°¨ ì•Œë¦¼ -->
    <div id="newDrawAlert" class="new-draw-alert" style="display: none;">
      <div class="alert-content">
        <span class="alert-icon">âš¡</span>
        <span class="alert-message">ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span>
        <button onclick="checkForNewDraw()" class="alert-btn">ì§€ê¸ˆ í™•ì¸í•˜ê¸°</button>
      </div>
    </div>
    <div class="draw-result">
      <div class="numbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball">{{ latest.bonus }}</span>
        <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
      </div>
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
    <p>ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì •ë³´ì¡°íšŒ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
  </section>
  {% endif %}



  <!-- Latest Winning Shops -->
  {% if latest and shops_rank1 %}
  <section class="card">
    <div class="card-header">
      <h2>ğŸª {{ latest.round }}íšŒ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h2>
    </div>

    {% if shops_rank1|length > 0 %}
    <div class="table-container">
      <table>
        <thead>
          <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
        </thead>
        <tbody>
          {% for s in shops_rank1 %}
          <tr>
            <td>{{ s.sequence or '' }}</td>
            <td><strong>{{ s.name }}</strong></td>
            <td><span class="badge-method">{{ s.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
            <td>{{ s.address }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="info-box">
      <p>ì•„ì§ 1ë“± ë‹¹ì²¨ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    <div style="margin-top: 1rem; text-align: center;">
      <p><small>ë” ìì„¸í•œ ë‹¹ì²¨ì  ì •ë³´ëŠ” <a href="{{ url_for('main.info_page') }}">ì •ë³´ì¡°íšŒ í˜ì´ì§€</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</small></p>
    </div>
  </section>
  {% endif %}

</div> <!-- End main-content -->

<style>
/* í—¤ë” ìŠ¤íƒ€ì¼ */
.title-section {
  flex: 1;
}

.date-section {
  text-align: right;
}

.current-date {
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.countdown-date {
  font-size: 0.85rem;
  color: #007bff;
  font-weight: 600;
  background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
  padding: 0.3rem 0.6rem;
  border-radius: 0.4rem;
  border: 1px solid rgba(0, 123, 255, 0.2);
  display: inline-block;
}

/* ìƒˆ íšŒì°¨ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
.new-draw-alert {
  background: linear-gradient(135deg, #ff6b6b, #ffa726);
  color: white;
  border-radius: 0.5rem;
  margin: 1rem 0;
  padding: 0;
  overflow: hidden;
  animation: slideDown 0.3s ease;
}

.alert-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
}

.alert-icon {
  font-size: 1.5rem;
}

.alert-message {
  flex: 1;
  font-weight: 500;
}

.alert-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.alert-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.btn-update {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-update:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.btn-update:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-lotto-site {
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  white-space: nowrap;
  display: inline-block;
}

.btn-lotto-site:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  color: white;
  text-decoration: none;
}

/* ë°ìŠ¤í¬í†± ì „ìš© - ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
</style>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ í‘œì‹œ (ì´ˆë‹¨ìœ„ê¹Œì§€)
  function updateCurrentTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    });
    const timeStr = now.toLocaleTimeString('ko-KR', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    document.getElementById('currentDate').textContent = `${dateStr} ${timeStr}`;
  }

  // ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚° ë° í‘œì‹œ
  function updateCountdown() {
    const now = new Date();

    // ë‹¤ìŒ í† ìš”ì¼ 8ì‹œ 45ë¶„ ê³„ì‚° (ë¡œë˜ ì¶”ì²¨ ì‹œê°„)
    let nextSaturday = new Date(now);
    const daysUntilSaturday = (6 - now.getDay()) % 7; // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼

    if (now.getDay() === 6) {  // í˜„ì¬ê°€ í† ìš”ì¼
      if (now.getHours() < 20 || (now.getHours() === 20 && now.getMinutes() < 45)) {
        // ì˜¤ëŠ˜ ì¶”ì²¨ ì „ì´ë©´ ì˜¤ëŠ˜
        nextSaturday.setHours(20, 45, 0, 0);
      } else {
        // ì˜¤ëŠ˜ ì¶”ì²¨ì´ ëë‚¬ìœ¼ë©´ ë‹¤ìŒ ì£¼ í† ìš”ì¼
        nextSaturday.setDate(now.getDate() + 7);
        nextSaturday.setHours(20, 45, 0, 0);
      }
    } else {
      // ë‹¤ìŒ í† ìš”ì¼ë¡œ ì„¤ì •
      nextSaturday.setDate(now.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday));
      nextSaturday.setHours(20, 45, 0, 0);
    }

    const timeDiff = nextSaturday - now;

    if (timeDiff <= 0) {
      document.getElementById('nextDrawCountdown').textContent = 'ğŸ¯ ì¶”ì²¨ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤';
      return;
    }

    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

    let countdownText = '';

    // ëª¨ë°”ì¼ ì²´í¬
    const isMobile = window.innerWidth <= 768;

    if (days > 0) {
      // ë‚ ì§œ ë‹¨ìœ„ë¡œ í‘œì‹œ (í•˜ë£¨ ì´ìƒ ë‚¨ìŒ)
      if (isMobile) {
        countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€\n${days}ì¼ ${hours}ì‹œê°„`;
      } else {
        countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€ ${days}ì¼ ${hours}ì‹œê°„`;
      }
    } else {
      // ì‹œê°„/ë¶„/ì´ˆ ë‹¨ìœ„ë¡œ í‘œì‹œ (í•˜ë£¨ ì´í•˜ ë‚¨ìŒ)
      if (hours > 0) {
        if (isMobile) {
          countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€\n${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        } else {
          countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€ ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
      } else if (minutes > 0) {
        if (isMobile) {
          countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€\n${minutes}ë¶„ ${seconds}ì´ˆ`;
        } else {
          countdownText = `ğŸ¯ ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
      } else {
        countdownText = `ğŸ¯ ${seconds}ì´ˆ í›„ ì¶”ì²¨`;
      }
    }

    // ëª¨ë°”ì¼ì—ì„œëŠ” ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
    if (isMobile) {
      document.getElementById('nextDrawCountdown').innerHTML = countdownText.replace('\n', '<br>');
    } else {
      document.getElementById('nextDrawCountdown').textContent = countdownText;
    }
  }

  // ì´ˆê¸° ì‹œê°„ í‘œì‹œ
  updateCurrentTime();
  updateCountdown();

  // ë§¤ì´ˆë§ˆë‹¤ ì‹œê°„ ë° ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
  setInterval(() => {
    updateCurrentTime();
    updateCountdown();
  }, 1000);

  // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
  window.addEventListener('resize', () => {
    updateCountdown();
  });

  // ìƒˆ íšŒì°¨ í™•ì¸ ìœ ë„
  checkIfNewDrawNeeded();
});

// ìƒˆ íšŒì°¨ í™•ì¸ì´ í•„ìš”í•œì§€ ì²´í¬
function checkIfNewDrawNeeded() {
  const drawDateText = document.querySelector('.draw-date').textContent.trim();
  if (!drawDateText) return;

  // ì¶”ì²¨ë‚ ì§œ íŒŒì‹± (YYYY-MM-DD í˜•ì‹ ê°€ì •)
  const drawDate = new Date(drawDateText);
  const today = new Date();

  // ë‹¤ìŒ í† ìš”ì¼ 8ì‹œ 45ë¶„ ê³„ì‚° (ë¡œë˜ ì¶”ì²¨ ì‹œê°„)
  const nextSaturday = new Date(today);
  const daysUntilSaturday = (6 - today.getDay()) % 7; // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
  if (daysUntilSaturday === 0 && today.getHours() < 21) {
    // ì˜¤ëŠ˜ì´ í† ìš”ì¼ì´ê³  ì¶”ì²¨ ì „ì´ë©´
    nextSaturday.setHours(20, 45, 0, 0);
  } else {
    // ë‹¤ìŒ í† ìš”ì¼ë¡œ ì„¤ì •
    nextSaturday.setDate(today.getDate() + (daysUntilSaturday || 7));
    nextSaturday.setHours(20, 45, 0, 0);
  }

  // ë§ˆì§€ë§‰ ì¶”ì²¨ì—ì„œ ë‹¤ìŒ ì¶”ì²¨ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
  const weeksSinceLastDraw = Math.floor((today - drawDate) / (1000 * 60 * 60 * 24 * 7));
  const shouldHaveNewDraw = weeksSinceLastDraw >= 1 && today >= nextSaturday;

  if (shouldHaveNewDraw) {
    const alertDiv = document.getElementById('newDrawAlert');
    if (alertDiv) {
      alertDiv.style.display = 'block';
      // ì•Œë¦¼ ë©”ì‹œì§€ë„ ë” êµ¬ì²´ì ìœ¼ë¡œ ë³€ê²½
      const alertMessage = alertDiv.querySelector('.alert-message');
      if (alertMessage) {
        const hoursLeft = Math.max(0, Math.floor((nextSaturday - today) / (1000 * 60 * 60)));
        if (hoursLeft > 0) {
          alertMessage.textContent = `ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤! (ë‹¤ìŒ ì¶”ì²¨: ${hoursLeft}ì‹œê°„ í›„)`;
        } else {
          alertMessage.textContent = 'ìƒˆë¡œìš´ íšŒì°¨ê°€ ì¶”ì²¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
        }
      }
    }
  }
}

async function checkForNewDraw() {
  const button = document.getElementById('checkNewDrawBtn');
  const originalText = button.innerHTML;

  button.disabled = true;
  button.innerHTML = '<span class="spinner">â³</span> í™•ì¸ì¤‘...';

  try {
    // ìƒˆë¡œìš´ íšŒì°¨ê°€ ìˆëŠ”ì§€ í™•ì¸
    const response = await fetch('/api/check-new-draw');
    const data = await response.json();

    // ìƒì„¸í•œ ë©”ì‹œì§€ ë¨¼ì € í‘œì‹œ
    let alertMessage = data.message || 'ìƒˆë¡œìš´ ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';

    // ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ í¬í•¨
    if (data.draw_completed && data.next_draw_time) {
      alertMessage += `\në‹¤ìŒ ì¶”ì²¨: ${data.next_draw_time}`;
    } else if (!data.draw_completed && data.hours_until_draw > 0) {
      alertMessage += `\n(${data.hours_until_draw}ì‹œê°„ í›„ ì¶”ì²¨)`;
    }

    if (data.has_new_draw) {
      // ì¶”ì²¨ ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¥¸ ë‹¤ë¥¸ í™•ì¸ ë©”ì‹œì§€
      let confirmMessage;
      if (data.draw_completed) {
        confirmMessage = `${data.message}\n\n${data.latest_round}íšŒ ì¶”ì²¨ ê²°ê³¼ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      } else {
        confirmMessage = `${data.message}\n\n${data.latest_round}íšŒ ê²°ê³¼ë¥¼ ì§€ê¸ˆ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      }

      const confirmed = confirm(confirmMessage);

      if (confirmed) {
        button.innerHTML = '<span class="spinner">â³</span> ì—…ë°ì´íŠ¸ì¤‘...';

        // ìµœì‹  íšŒì°¨ ë°ì´í„° ì—…ë°ì´íŠ¸
        const updateResponse = await fetch('/api/update-new-draw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            round: data.latest_round,
            csrf_token: window.csrfToken
          })
        });

        const updateData = await updateResponse.json();

        if (updateData.success) {
          alert(`${data.latest_round}íšŒ ì¶”ì²¨ ê²°ê³¼ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateData.message}`);
        }
      }
    } else {
      alert(alertMessage);
    }
  } catch (error) {
    console.error('Error checking for new draw:', error);
    alert('í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
</script>

{% endblock %}
