{% extends "base.html" %}

{% block content %}
<div class="header">
  <div class="title-stats">
    <h1>ğŸ¯ {{ latest.round }}íšŒ ì¶”ì²¨ê²°ê³¼</h1>
    <div class="stats">
      <div class="stat">ì´ íšŒì°¨: {{ total_rounds }}</div>
      <a href="{{ url_for('main.info_page') }}" class="btn-secondary">â† ì •ë³´ì¡°íšŒ</a>
    </div>
  </div>
  <div class="lookup-row">
    <div class="lookup-simple">
      <input type="number" id="lookupRound" placeholder="íšŒì°¨ ì…ë ¥" min="1" max="{{ latest.round if latest else 1000 }}" value="{{ latest.round }}">
      <button type="button" onclick="lookupRound()" class="btn-lookup">ì¡°íšŒ</button>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Current Draw Results with Winning Shops -->
  {% if latest %}
  <section class="card highlight-card" id="currentDrawSection">
    <div class="card-header">
      <h2 id="drawTitle">ğŸ¯ {{ latest.round }}íšŒ ì¶”ì²¨ê²°ê³¼</h2>
      <span class="draw-date" id="drawDate">{{ latest.draw_date if latest.draw_date else '' }}</span>
    </div>
    <div class="draw-result">
      <div class="numbers" id="drawNumbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball" id="drawBonus">{{ latest.bonus }}</span>
        <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
      </div>
    </div>

    <!-- ë‹¹ì²¨ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
    <div class="prize-info" id="prizeInfo">
      <div class="prize-stats">
        {% if latest.total_sales %}
        <div class="prize-stat">
          <span class="stat-label">ì´ íŒë§¤ì•¡</span>
          <span class="stat-value">{{ "{:,}".format(latest.total_sales) }}ì›</span>
        </div>
        <div class="prize-stat">
          <span class="stat-label">ì´ íŒë§¤ìˆ˜</span>
          <span class="stat-value">{{ "{:,}".format(latest.total_sales // 1000) }}ê²Œì„</span>
        </div>
        {% endif %}

        {% if latest.first_prize_amount or latest.first_prize_winners %}
        <div class="prize-stat highlight">
          <span class="stat-label">1ë“±</span>
          <div class="stat-details">
            {% if latest.first_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.first_prize_amount) }}ì›</span>{% endif %}
            {% if latest.first_prize_winners %}<span class="stat-winners">{{ latest.first_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.total_sales and latest.first_prize_winners %}
        <div class="prize-stat probability-stat">
          <span class="stat-label">í™•ë¥  ë¶„ì„</span>
          <div class="stat-details">
            {% set total_games = latest.total_sales // 1000 %}
            {% set expected_winners = (total_games / 8145060) | round(1) %}
            {% set actual_winners = latest.first_prize_winners %}
            {% set probability_ratio = (actual_winners / expected_winners) if expected_winners > 0 else 0 %}

            <span class="stat-expected">ì˜ˆìƒ: {{ expected_winners }}ëª…</span>
            <span class="stat-actual">ì‹¤ì œ: {{ actual_winners }}ëª…</span>
            {% if probability_ratio > 1.5 %}
              <span class="stat-analysis lucky">ğŸ€ í–‰ìš´ì˜ íšŒì°¨</span>
            {% elif probability_ratio < 0.5 %}
              <span class="stat-analysis unlucky">ğŸ˜… ì•„ì‰¬ìš´ íšŒì°¨</span>
            {% else %}
              <span class="stat-analysis normal">ğŸ“Š í‰ê· ì </span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.second_prize_amount or latest.second_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">2ë“±</span>
          <div class="stat-details">
            {% if latest.second_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.second_prize_amount) }}ì›</span>{% endif %}
            {% if latest.second_prize_winners %}<span class="stat-winners">{{ latest.second_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.third_prize_amount or latest.third_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">3ë“±</span>
          <div class="stat-details">
            {% if latest.third_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.third_prize_amount) }}ì›</span>{% endif %}
            {% if latest.third_prize_winners %}<span class="stat-winners">{{ latest.third_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.fourth_prize_amount or latest.fourth_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">4ë“±</span>
          <div class="stat-details">
            {% if latest.fourth_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.fourth_prize_amount) }}ì›</span>{% endif %}
            {% if latest.fourth_prize_winners %}<span class="stat-winners">{{ latest.fourth_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.fifth_prize_amount or latest.fifth_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">5ë“±</span>
          <div class="stat-details">
            {% if latest.fifth_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.fifth_prize_amount) }}ì›</span>{% endif %}
            {% if latest.fifth_prize_winners %}<span class="stat-winners">{{ latest.fifth_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Current Round Winning Shops -->
  <section class="card" id="shopsSection">
    <div class="card-header">
      <h2 id="shopsTitle">ğŸª {{ latest.round }}íšŒ ë‹¹ì²¨ì  ì •ë³´</h2>
    </div>
    <div id="shopsContent">

    {% if shops_rank1 %}
    <div class="shops-section">
      <h4>ğŸ¥‡ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank1 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td><strong>{{ shop.name }}</strong></td>
              <td><span class="badge-method">{{ shop.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    {% if shops_rank2_total > 0 %}
    <div id="rank2-section" class="shops-section">
      <div class="section-header">
        <h4>ğŸ¥ˆ 2ë“± ë‹¹ì²¨ì  (ì´ {{ shops_rank2_total }}ê°œ)</h4>
        {% if shops_rank2_total_pages > 1 %}
        <div class="page-info">
          <span>í˜ì´ì§€ {{ shops_rank2_page }}/{{ shops_rank2_total_pages }}</span>
        </div>
        {% endif %}
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank2 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td>{{ shop.name }}</td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if shops_rank2_total_pages > 1 %}
      <div class="pagination-controls">
        <button
          type="button"
          class="page-btn prev-btn"
          onclick="changeRank2Page({{ shops_rank2_page - 1 }})"
          {% if shops_rank2_page <= 1 %}disabled{% endif %}>
          â—€ ì´ì „
        </button>

        <span class="page-display">{{ shops_rank2_page }} / {{ shops_rank2_total_pages }}</span>

        <button
          type="button"
          class="page-btn next-btn"
          onclick="changeRank2Page({{ shops_rank2_page + 1 }})"
          {% if shops_rank2_page >= shops_rank2_total_pages %}disabled{% endif %}>
          ë‹¤ìŒ â–¶
        </button>
      </div>

      {% if shops_rank2_total_pages > 3 %}
      <div class="quick-jump">
        <span>ë¹ ë¥¸ ì´ë™:</span>
        <button type="button" class="jump-btn" onclick="changeRank2Page(1)">1</button>
        {% if shops_rank2_total_pages > 2 %}
          <button type="button" class="jump-btn" onclick="changeRank2Page({{ (shops_rank2_total_pages + 1) // 2 }})">{{ (shops_rank2_total_pages + 1) // 2 }}</button>
        {% endif %}
        <button type="button" class="jump-btn" onclick="changeRank2Page({{ shops_rank2_total_pages }})">{{ shops_rank2_total_pages }}</button>
      </div>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if not shops_rank1 and not shops_rank2 %}
    <div class="info-box">
      <p>ì•„ì§ ë‹¹ì²¨ì  ì •ë³´ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
    <p>í•´ë‹¹ íšŒì°¨ì˜ ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="{{ url_for('main.info_page') }}">ì •ë³´ì¡°íšŒ</a>ë¡œ ëŒì•„ê°€ê±°ë‚˜ <a href="{{ url_for('main.crawling_page') }}">í¬ë¡¤ë§ í˜ì´ì§€</a>ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
  </section>
  {% endif %}

  <!-- Navigation -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ”„ íšŒì°¨ ì´ë™</h2>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
      <div style="display: flex; align-items: center; gap: 1rem;">
        {% if latest and latest.round > 1 %}
          <a href="{{ url_for('main.draw_info') }}?round={{ latest.round - 1 }}" class="btn-secondary">
            â† {{ latest.round - 1 }}íšŒ
          </a>
        {% endif %}
        {% if latest %}
        <div style="font-size: 1.2rem; font-weight: bold; color: #667eea; padding: 0 1rem;">
          {{ latest.round }}íšŒ
        </div>
        <a href="{{ url_for('main.draw_info') }}?round={{ latest.round + 1 }}" class="btn-secondary">
          {{ latest.round + 1 }}íšŒ â†’
        </a>
        {% endif %}
      </div>

      <form method="get" action="{{ url_for('main.draw_info') }}" style="display: flex; gap: 0.5rem; align-items: center;">
        <input type="number" name="round" min="1" max="9999" value="{{ latest.round if latest else '' }}" placeholder="íšŒì°¨" style="width: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem;" />
        <button type="submit" class="btn-accent">ì´ë™</button>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <div class="footer">
    <p>í—¬ìŠ¤ì²´í¬: <code><a href="/health">/health</a></code></p>
  </div>

</div> <!-- End main-content -->

<script>
  function changeRank2Page(newPage) {
    if (newPage < 1) return;

    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('rank2_page', newPage);

    // Navigate with new page parameter
    window.location.href = `${window.location.pathname}?${urlParams.toString()}#rank2-section`;
  }

  // íŠ¹ì •íšŒì°¨ ì¡°íšŒ
  function lookupRound() {
    const roundInput = document.getElementById('lookupRound');
    const round = parseInt(roundInput.value);

    if (!round || round < 1) {
      alert('ìœ íš¨í•œ íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì§ì ‘ draw-info í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = `{{ url_for('main.draw_info') }}?round=${round}`;
  }

  // ì—”í„°í‚¤ ì§€ì›
  document.getElementById('lookupRound').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      lookupRound();
    }
  });
</script>
{% endblock %}