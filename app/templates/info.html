{% extends "base.html" %}

{% block content %}
<div class="header">
  <div class="title-stats">
    <h1>ğŸ” ë¡œë˜ ì •ë³´ì¡°íšŒ</h1>
    <div class="stats">
      <div class="stat">ì €ì¥ íšŒì°¨: {{ total_rounds }}</div>
      {% if latest %}<div class="stat">ìµœê·¼ íšŒì°¨: {{ latest.round }}</div>{% endif %}
    </div>
  </div>
  <div class="lookup-row">
    <div class="lookup-simple">
      <input type="number" id="lookupRound" placeholder="íšŒì°¨ ì…ë ¥" min="1" max="{{ latest.round if latest else 1000 }}">
      <button type="button" onclick="lookupRound()" class="btn-lookup">ì¡°íšŒ</button>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results with Winning Shops -->
  {% if latest %}
  <section class="card highlight-card" id="currentDrawSection">
    <div class="card-header">
      <h2 id="drawTitle">ğŸ¯ {{ latest.round }}íšŒ ìµœì‹  ì¶”ì²¨ê²°ê³¼</h2>
      <span class="draw-date" id="drawDate">{{ latest.draw_date if latest.draw_date else '' }}</span>
    </div>
    <div class="draw-result">
      <div class="numbers" id="drawNumbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball" id="drawBonus">{{ latest.bonus }}</span>
        <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
      </div>
    </div>

    <!-- ë‹¹ì²¨ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
    <div class="prize-info" id="prizeInfo">
      <div class="prize-stats">
        {% if latest.total_sales %}
        <div class="prize-stat">
          <span class="stat-label">ì´ íŒë§¤ì•¡</span>
          <span class="stat-value">{{ "{:,}".format(latest.total_sales) }}ì›</span>
        </div>
        <div class="prize-stat">
          <span class="stat-label">ì´ íŒë§¤ìˆ˜</span>
          <span class="stat-value">{{ "{:,}".format(latest.total_sales // 1000) }}ê²Œì„</span>
        </div>
        {% endif %}

        {% if latest.first_prize_amount or latest.first_prize_winners %}
        <div class="prize-stat highlight">
          <span class="stat-label">1ë“±</span>
          <div class="stat-details">
            {% if latest.first_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.first_prize_amount) }}ì›</span>{% endif %}
            {% if latest.first_prize_winners %}<span class="stat-winners">{{ latest.first_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.total_sales and latest.first_prize_winners %}
        <div class="prize-stat probability-stat">
          <span class="stat-label">í™•ë¥  ë¶„ì„</span>
          <div class="stat-details">
            {% set total_games = latest.total_sales // 1000 %}
            {% set expected_winners = (total_games / 8145060) | round(1) %}
            {% set actual_winners = latest.first_prize_winners %}
            {% set probability_ratio = (actual_winners / expected_winners) if expected_winners > 0 else 0 %}

            <span class="stat-expected">ì˜ˆìƒ: {{ expected_winners }}ëª…</span>
            <span class="stat-actual">ì‹¤ì œ: {{ actual_winners }}ëª…</span>
            {% if probability_ratio > 1.5 %}
              <span class="stat-analysis lucky">ğŸ€ í–‰ìš´ì˜ íšŒì°¨</span>
            {% elif probability_ratio < 0.5 %}
              <span class="stat-analysis unlucky">ğŸ˜… ì•„ì‰¬ìš´ íšŒì°¨</span>
            {% else %}
              <span class="stat-analysis normal">ğŸ“Š í‰ê· ì </span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.second_prize_amount or latest.second_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">2ë“±</span>
          <div class="stat-details">
            {% if latest.second_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.second_prize_amount) }}ì›</span>{% endif %}
            {% if latest.second_prize_winners %}<span class="stat-winners">{{ latest.second_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.third_prize_amount or latest.third_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">3ë“±</span>
          <div class="stat-details">
            {% if latest.third_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.third_prize_amount) }}ì›</span>{% endif %}
            {% if latest.third_prize_winners %}<span class="stat-winners">{{ latest.third_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.fourth_prize_amount or latest.fourth_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">4ë“±</span>
          <div class="stat-details">
            {% if latest.fourth_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.fourth_prize_amount) }}ì›</span>{% endif %}
            {% if latest.fourth_prize_winners %}<span class="stat-winners">{{ latest.fourth_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}

        {% if latest.fifth_prize_amount or latest.fifth_prize_winners %}
        <div class="prize-stat">
          <span class="stat-label">5ë“±</span>
          <div class="stat-details">
            {% if latest.fifth_prize_amount %}<span class="stat-amount">{{ "{:,}".format(latest.fifth_prize_amount) }}ì›</span>{% endif %}
            {% if latest.fifth_prize_winners %}<span class="stat-winners">{{ latest.fifth_prize_winners }}ëª…</span>{% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Latest Winning Shops -->
  <section class="card" id="shopsSection">
    <div class="card-header">
      <h2 id="shopsTitle">ğŸª {{ latest.round }}íšŒ ë‹¹ì²¨ì  ì •ë³´</h2>
    </div>
    <div id="shopsContent">

    {% if shops_rank1 %}
    <div class="shops-section">
      <h4>ğŸ¥‡ 1ë“± ë‹¹ì²¨ì  ({{ shops_rank1|length }}ê°œ)</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank1 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td><strong>{{ shop.name }}</strong></td>
              <td><span class="badge-method">{{ shop.method or 'êµ¬ë¶„ì—†ìŒ' }}</span></td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    {% if shops_rank2_total > 0 %}
    <div id="rank2-section" class="shops-section">
      <div class="section-header">
        <h4>ğŸ¥ˆ 2ë“± ë‹¹ì²¨ì  (ì´ {{ shops_rank2_total }}ê°œ)</h4>
        {% if shops_rank2_total_pages > 1 %}
        <div class="page-info">
          <span>í˜ì´ì§€ {{ shops_rank2_page }}/{{ shops_rank2_total_pages }}</span>
        </div>
        {% endif %}
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>ì£¼ì†Œ</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank2 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td>{{ shop.name }}</td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if shops_rank2_total_pages > 1 %}
      <div class="pagination-controls">
        <button
          type="button"
          class="page-btn prev-btn"
          onclick="changeRank2Page({{ shops_rank2_page - 1 }})"
          {% if shops_rank2_page <= 1 %}disabled{% endif %}>
          â—€ ì´ì „
        </button>

        <span class="page-display">{{ shops_rank2_page }} / {{ shops_rank2_total_pages }}</span>

        <button
          type="button"
          class="page-btn next-btn"
          onclick="changeRank2Page({{ shops_rank2_page + 1 }})"
          {% if shops_rank2_page >= shops_rank2_total_pages %}disabled{% endif %}>
          ë‹¤ìŒ â–¶
        </button>
      </div>

      {% if shops_rank2_total_pages > 3 %}
      <div class="quick-jump">
        <span>ë¹ ë¥¸ ì´ë™:</span>
        <button type="button" class="jump-btn" onclick="changeRank2Page(1)">1</button>
        {% if shops_rank2_total_pages > 2 %}
          <button type="button" class="jump-btn" onclick="changeRank2Page({{ (shops_rank2_total_pages + 1) // 2 }})">{{ (shops_rank2_total_pages + 1) // 2 }}</button>
        {% endif %}
        <button type="button" class="jump-btn" onclick="changeRank2Page({{ shops_rank2_total_pages }})">{{ shops_rank2_total_pages }}</button>
      </div>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if not shops_rank1 and not shops_rank2 %}
    <div class="info-box">
      <p>ì•„ì§ ë‹¹ì²¨ì  ì •ë³´ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>âš ï¸ ë°ì´í„° ì—†ìŒ</h2>
    <p>ì¶”ì²¨ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="{{ url_for('main.crawling_page') }}">í¬ë¡¤ë§ í˜ì´ì§€</a>ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.</p>
  </section>
  {% endif %}



  <!-- Recent draws table -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ“Š ìµœê·¼ 10íšŒ ì¶”ì²¨ ê¸°ë¡</h2>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>íšŒì°¨</th><th>ë‚ ì§œ</th><th>ë‹¹ì²¨ë²ˆí˜¸</th><th>ë³´ë„ˆìŠ¤</th></tr>
        </thead>
        <tbody>
          {% for d in draws %}
          <tr>
            <td><strong>{{ d.round }}íšŒ</strong></td>
            <td>{{ d.draw_date if d.draw_date else '-' }}</td>
            <td class="numbers-cell">
              {% for num in d.numbers_list() %}
                <span class="small-number-ball">{{ num }}</span>
              {% endfor %}
            </td>
            <td class="bonus-cell">{{ d.bonus }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Footer -->
  <div class="footer">
    <p>í—¬ìŠ¤ì²´í¬: <code><a href="/health">/health</a></code></p>
  </div>

</div> <!-- End main-content -->

<script>
  function changeRank2Page(newPage) {
    if (newPage < 1) return;

    // Save current scroll position
    const currentScroll = window.pageYOffset;
    sessionStorage.setItem('infoScrollPosition', currentScroll);

    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('rank2_page', newPage);

    // Navigate with new page parameter
    window.location.href = `${window.location.pathname}?${urlParams.toString()}#rank2-section`;
  }

  // íŠ¹ì •íšŒì°¨ ì¡°íšŒ
  function lookupRound() {
    const roundInput = document.getElementById('lookupRound');
    const round = parseInt(roundInput.value);

    if (!round || round < 1) {
      alert('ìœ íš¨í•œ íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ê¸°ì¡´ í‘œì‹œ ì—…ë°ì´íŠ¸
    const drawTitle = document.getElementById('drawTitle');
    const drawDate = document.getElementById('drawDate');
    const drawNumbers = document.getElementById('drawNumbers');
    const drawBonus = document.getElementById('drawBonus');
    const shopsTitle = document.getElementById('shopsTitle');
    const shopsContent = document.getElementById('shopsContent');

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    drawTitle.innerHTML = `ğŸ” ${round}íšŒ ì¡°íšŒì¤‘...`;

    fetch(`/api/draw-info/${round}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const draw = data.draw;
        const shops = data.shops;

        // ë‹¹ì²¨ë²ˆí˜¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        drawTitle.innerHTML = `ğŸ¯ ${draw.round}íšŒ ì¶”ì²¨ê²°ê³¼`;
        drawDate.textContent = draw.draw_date || '';

        // ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        drawNumbers.innerHTML = draw.numbers_list.map(num =>
          `<span class="number-ball">${num}</span>`
        ).join('');
        drawBonus.textContent = draw.bonus;

        // ë‹¹ì²¨ê¸ˆì•¡ ì •ë³´ ì—…ë°ì´íŠ¸
        const prizeInfo = document.getElementById('prizeInfo');
        if (prizeInfo) {
          let prizeHtml = '<div class="prize-stats">';

          // ì´ íŒë§¤ì•¡
          if (draw.total_sales) {
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">ì´ íŒë§¤ì•¡</span>
                <span class="stat-value">${draw.total_sales.toLocaleString()}ì›</span>
              </div>`;

            // ì´ íŒë§¤ìˆ˜ (íŒë§¤ì•¡ì„ 1000ìœ¼ë¡œ ë‚˜ëˆˆ ê°’)
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">ì´ íŒë§¤ìˆ˜</span>
                <span class="stat-value">${Math.floor(draw.total_sales / 1000).toLocaleString()}ê²Œì„</span>
              </div>`;
          }

          // 1ë“± ì •ë³´
          if (draw.first_prize_amount || draw.first_prize_winners) {
            prizeHtml += `
              <div class="prize-stat highlight">
                <span class="stat-label">1ë“±</span>
                <div class="stat-details">
                  ${draw.first_prize_amount ? `<span class="stat-amount">${draw.first_prize_amount.toLocaleString()}ì›</span>` : ''}
                  ${draw.first_prize_winners ? `<span class="stat-winners">${draw.first_prize_winners}ëª…</span>` : ''}
                </div>
              </div>`;
          }

          // í™•ë¥  ë¶„ì„
          if (draw.total_sales && draw.first_prize_winners) {
            const totalGames = Math.floor(draw.total_sales / 1000);
            const expectedWinners = Math.round((totalGames / 8145060) * 10) / 10; // ì†Œìˆ˜ì  1ìë¦¬
            const actualWinners = draw.first_prize_winners;
            const probabilityRatio = expectedWinners > 0 ? actualWinners / expectedWinners : 0;

            let analysisText = '';
            let analysisClass = '';
            if (probabilityRatio > 1.5) {
              analysisText = 'ğŸ€ í–‰ìš´ì˜ íšŒì°¨';
              analysisClass = 'lucky';
            } else if (probabilityRatio < 0.5) {
              analysisText = 'ğŸ˜… ì•„ì‰¬ìš´ íšŒì°¨';
              analysisClass = 'unlucky';
            } else {
              analysisText = 'ğŸ“Š í‰ê· ì ';
              analysisClass = 'normal';
            }

            prizeHtml += `
              <div class="prize-stat probability-stat">
                <span class="stat-label">í™•ë¥  ë¶„ì„</span>
                <div class="stat-details">
                  <span class="stat-expected">ì˜ˆìƒ: ${expectedWinners}ëª…</span>
                  <span class="stat-actual">ì‹¤ì œ: ${actualWinners}ëª…</span>
                  <span class="stat-analysis ${analysisClass}">${analysisText}</span>
                </div>
              </div>`;
          }

          // 2ë“± ì •ë³´
          if (draw.second_prize_amount || draw.second_prize_winners) {
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">2ë“±</span>
                <div class="stat-details">
                  ${draw.second_prize_amount ? `<span class="stat-amount">${draw.second_prize_amount.toLocaleString()}ì›</span>` : ''}
                  ${draw.second_prize_winners ? `<span class="stat-winners">${draw.second_prize_winners}ëª…</span>` : ''}
                </div>
              </div>`;
          }

          // 3ë“± ì •ë³´
          if (draw.third_prize_amount || draw.third_prize_winners) {
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">3ë“±</span>
                <div class="stat-details">
                  ${draw.third_prize_amount ? `<span class="stat-amount">${draw.third_prize_amount.toLocaleString()}ì›</span>` : ''}
                  ${draw.third_prize_winners ? `<span class="stat-winners">${draw.third_prize_winners}ëª…</span>` : ''}
                </div>
              </div>`;
          }

          // 4ë“± ì •ë³´
          if (draw.fourth_prize_amount || draw.fourth_prize_winners) {
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">4ë“±</span>
                <div class="stat-details">
                  ${draw.fourth_prize_amount ? `<span class="stat-amount">${draw.fourth_prize_amount.toLocaleString()}ì›</span>` : ''}
                  ${draw.fourth_prize_winners ? `<span class="stat-winners">${draw.fourth_prize_winners}ëª…</span>` : ''}
                </div>
              </div>`;
          }

          // 5ë“± ì •ë³´
          if (draw.fifth_prize_amount || draw.fifth_prize_winners) {
            prizeHtml += `
              <div class="prize-stat">
                <span class="stat-label">5ë“±</span>
                <div class="stat-details">
                  ${draw.fifth_prize_amount ? `<span class="stat-amount">${draw.fifth_prize_amount.toLocaleString()}ì›</span>` : ''}
                  ${draw.fifth_prize_winners ? `<span class="stat-winners">${draw.fifth_prize_winners}ëª…</span>` : ''}
                </div>
              </div>`;
          }

          prizeHtml += '</div>';
          prizeInfo.innerHTML = prizeHtml;
        }

        // ë‹¹ì²¨ì  ì •ë³´ ì—…ë°ì´íŠ¸
        shopsTitle.innerHTML = `ğŸª ${draw.round}íšŒ ë‹¹ì²¨ì  ì •ë³´`;

        if (shops && (shops.rank1 || shops.rank2)) {
          let shopsHtml = '';

          // 1ë“± ë‹¹ì²¨ì 
          if (shops.rank1 && shops.rank1.length > 0) {
            shopsHtml += `
              <div class="shops-section">
                <h4>ğŸ¥‡ 1ë“± ë‹¹ì²¨ì  (${shops.rank1.length}ê°œ)</h4>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>êµ¬ë¶„</th><th>ì£¼ì†Œ</th></tr>
                    </thead>
                    <tbody>
                      ${shops.rank1.map(shop => `
                        <tr>
                          <td>${shop.sequence || ''}</td>
                          <td><strong>${shop.name}</strong></td>
                          <td><span class="badge-method">${shop.method || 'êµ¬ë¶„ì—†ìŒ'}</span></td>
                          <td>${shop.address || ''}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>`;
          }

          // 2ë“± ë‹¹ì²¨ì  (30ê°œì”© í˜ì´ì§•)
          if (shops.rank2 && shops.rank2.length > 0) {
            const rank2Total = shops.rank2_total || shops.rank2.length;
            const currentPage = shops.rank2_page || 1;
            const totalPages = shops.rank2_total_pages || 1;

            // ì „ì—­ ë³€ìˆ˜ì— í˜„ì¬ ìƒíƒœ ì €ì¥ (í˜ì´ì§•ìš©)
            window.currentRound = draw.round;
            window.currentRank2Page = currentPage;
            window.rank2TotalPages = totalPages;

            shopsHtml += `
              <div class="shops-section" id="rank2-section">
                <div class="section-header">
                  <h4>ğŸ¥ˆ 2ë“± ë‹¹ì²¨ì  (ì´ ${rank2Total}ê°œ)</h4>
                  ${totalPages > 1 ? `
                    <div class="page-info">
                      <span>í˜ì´ì§€ ${currentPage}/${totalPages}</span>
                    </div>
                  ` : ''}
                </div>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr><th>ìˆœë²ˆ</th><th>ìƒí˜¸</th><th>ì£¼ì†Œ</th></tr>
                    </thead>
                    <tbody id="rank2TableBody">
                      ${shops.rank2.map(shop => `
                        <tr>
                          <td>${shop.sequence || ''}</td>
                          <td>${shop.name}</td>
                          <td>${shop.address || ''}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ${totalPages > 1 ? `
                  <div class="pagination-controls">
                    <button
                      type="button"
                      class="page-btn prev-btn"
                      onclick="changeDynamicRank2Page(${currentPage - 1})"
                      ${currentPage <= 1 ? 'disabled' : ''}>
                      â—€ ì´ì „
                    </button>

                    <span class="page-display" id="dynamicPageDisplay">${currentPage} / ${totalPages}</span>

                    <button
                      type="button"
                      class="page-btn next-btn"
                      onclick="changeDynamicRank2Page(${currentPage + 1})"
                      ${currentPage >= totalPages ? 'disabled' : ''}>
                      ë‹¤ìŒ â–¶
                    </button>
                  </div>

                  ${totalPages > 3 ? `
                    <div class="quick-jump">
                      <span>ë¹ ë¥¸ ì´ë™:</span>
                      <button type="button" class="jump-btn" onclick="changeDynamicRank2Page(1)">1</button>
                      ${totalPages > 2 ? `
                        <button type="button" class="jump-btn" onclick="changeDynamicRank2Page(${Math.ceil(totalPages / 2)})">${Math.ceil(totalPages / 2)}</button>
                      ` : ''}
                      <button type="button" class="jump-btn" onclick="changeDynamicRank2Page(${totalPages})">${totalPages}</button>
                    </div>
                  ` : ''}
                ` : ''}
              </div>`;
          }

          shopsContent.innerHTML = shopsHtml;
        } else {
          shopsContent.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">ë‹¹ì²¨ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        roundInput.value = '';

      } else {
        alert(data.error);
        drawTitle.innerHTML = `ğŸ¯ ${document.querySelector('[data-original-round]')?.getAttribute('data-original-round') || 'ìµœì‹ '}íšŒ ì¶”ì²¨ê²°ê³¼`;
      }
    })
    .catch(error => {
      alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      drawTitle.innerHTML = `ğŸ¯ ${document.querySelector('[data-original-round]')?.getAttribute('data-original-round') || 'ìµœì‹ '}íšŒ ì¶”ì²¨ê²°ê³¼`;
    });
  }

  // ë™ì  2ë“± ë‹¹ì²¨ì  í˜ì´ì§•
  function changeDynamicRank2Page(newPage) {
    if (!window.currentRound || !newPage || newPage < 1 || newPage > window.rank2TotalPages) {
      return;
    }

    // API í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const drawTitle = document.getElementById('drawTitle');
    const pageInfo = document.querySelector('#rank2-section .page-info span');

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    if (pageInfo) {
      pageInfo.textContent = 'ë¡œë”© ì¤‘...';
    }

    fetch(`/api/draw-info/${window.currentRound}?page=${newPage}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.shops && data.shops.rank2) {
        const shops = data.shops;
        const currentPage = shops.rank2_page || newPage;
        const totalPages = shops.rank2_total_pages || 1;

        // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        window.currentRank2Page = currentPage;

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('rank2TableBody');
        if (tbody) {
          tbody.innerHTML = shops.rank2.map(shop => `
            <tr>
              <td>${shop.sequence || ''}</td>
              <td>${shop.name}</td>
              <td>${shop.address || ''}</td>
            </tr>
          `).join('');
        }

        // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
        if (pageInfo) {
          pageInfo.textContent = `í˜ì´ì§€ ${currentPage}/${totalPages}`;
        }

        const pageDisplay = document.getElementById('dynamicPageDisplay');
        if (pageDisplay) {
          pageDisplay.textContent = `${currentPage} / ${totalPages}`;
        }

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        const prevBtn = document.querySelector('#rank2-section .prev-btn');
        const nextBtn = document.querySelector('#rank2-section .next-btn');

        if (prevBtn) {
          prevBtn.disabled = currentPage <= 1;
          prevBtn.onclick = () => changeDynamicRank2Page(currentPage - 1);
        }

        if (nextBtn) {
          nextBtn.disabled = currentPage >= totalPages;
          nextBtn.onclick = () => changeDynamicRank2Page(currentPage + 1);
        }

        // ë¹ ë¥¸ ì´ë™ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        const jumpBtns = document.querySelectorAll('#rank2-section .jump-btn');
        jumpBtns.forEach(btn => {
          const targetPage = parseInt(btn.textContent);
          btn.onclick = () => changeDynamicRank2Page(targetPage);
        });

      } else {
        if (pageInfo) {
          pageInfo.textContent = 'ë¡œë”© ì‹¤íŒ¨';
        }
        alert('í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch(error => {
      console.error('Pagination error:', error);
      if (pageInfo) {
        pageInfo.textContent = 'ë¡œë”© ì‹¤íŒ¨';
      }
      alert('í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Restore scroll position for pagination
    const savedScroll = sessionStorage.getItem('infoScrollPosition');
    if (savedScroll && window.location.hash === '#rank2-section') {
      setTimeout(() => {
        window.scrollTo(0, parseInt(savedScroll));
        sessionStorage.removeItem('infoScrollPosition');
      }, 100);
    }
  });
</script>

<style>

/* ì‘ì€ ë²ˆí˜¸ ë³¼ ìŠ¤íƒ€ì¼ */
.small-number-ball {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: var(--acc);
  color: white;
  border-radius: 50%;
  font-size: 0.75rem;
  font-weight: bold;
  margin-right: 2px;
}

.numbers-cell {
  min-width: 160px;
}

.bonus-cell {
  font-weight: bold;
  color: #ff6b6b;
  text-align: center;
}

/* Simple table-based shops styles */
.shops-section {
  margin-bottom: 1.5rem;
}

.shops-section h4 {
  margin-bottom: 0.75rem;
  color: #333;
  font-size: 1.1rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.page-info {
  font-size: 0.9rem;
  color: #666;
  background: #f8f9fa;
  padding: 0.5rem 0.75rem;
  border-radius: 0.25rem;
}

.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.page-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.page-btn:hover:not(:disabled) {
  background: #5a67d8;
}

.page-btn:disabled {
  background: #e2e8f0;
  color: #a0aec0;
  cursor: not-allowed;
}

.page-display {
  font-weight: 500;
  color: #333;
  padding: 0.5rem 1rem;
  background: #f8f9fa;
  border-radius: 0.25rem;
}

.quick-jump {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
  font-size: 0.9rem;
}

.jump-btn {
  background: #f8f9fa;
  border: 1px solid #e2e8f0;
  color: #667eea;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.jump-btn:hover {
  background: #667eea;
  color: white;
}

.lookup-panel {
  margin-top: 1rem;
}

.lookup-description {
  margin-bottom: 1.5rem;
}

/* í—¤ë” ìŠ¤íƒ€ì¼ */
.title-stats {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.stats {
  text-align: right;
}

.lookup-row {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-top: 1rem;
}

.lookup-simple {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.lookup-simple input {
  width: 100px;
  padding: 0.5rem;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  text-align: center;
}

.lookup-simple input:focus {
  outline: none;
  border-color: #667eea;
}

.btn-lookup {
  background: #667eea;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn-lookup:hover {
  background: #5a67d8;
}


@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .title-stats {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .lookup-row {
    flex-direction: column;
    gap: 0.5rem;
    align-items: stretch;
  }

  .section-header {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .pagination-controls {
    gap: 0.5rem;
  }

  .page-btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }

  .form-row {
    flex-direction: column;
    gap: 0.5rem;
  }

  .prize-stats {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .prize-stat {
    padding: 0.75rem;
  }

  .stat-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
  }
}

/* ë‹¹ì²¨ê¸ˆì•¡ ì •ë³´ ìŠ¤íƒ€ì¼ */
.prize-info {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.prize-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.prize-stat {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 1rem;
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.prize-stat:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.prize-stat.highlight {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  border-color: #ffc107;
  font-weight: 600;
}

.stat-label {
  display: block;
  font-size: 0.9rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.stat-value {
  display: block;
  font-size: 1.1rem;
  font-weight: 700;
  color: #495057;
}

.stat-details {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.stat-amount {
  font-size: 1.1rem;
  font-weight: 700;
  color: #28a745;
}

.stat-winners {
  font-size: 0.9rem;
  color: #6c757d;
  background: #f8f9fa;
  padding: 0.2rem 0.5rem;
  border-radius: 0.25rem;
}

.prize-stat.highlight .stat-amount {
  color: #d39e00;
}

.prize-stat.highlight .stat-winners {
  background: rgba(255, 255, 255, 0.7);
}
</style>
{% endblock %}
