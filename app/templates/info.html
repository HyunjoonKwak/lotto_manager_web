{% extends "base.html" %}

{% block content %}
<div class="header">
  <div class="title-stats">
    <h1>🔍 로또 정보조회</h1>
    <div class="stats">
      <div class="stat">저장 회차: {{ total_rounds }}</div>
      {% if latest %}<div class="stat">최근 회차: {{ latest.round }}</div>{% endif %}
    </div>
  </div>
  <div class="lookup-row">
    <div class="lookup-simple">
      <input type="number" id="lookupRound" placeholder="회차 입력" min="1" max="{{ latest.round if latest else 1000 }}">
      <button type="button" onclick="lookupRound()" class="btn-lookup">조회</button>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results with Winning Shops -->
  {% if latest %}
  <section class="card highlight-card" id="currentDrawSection">
    <div class="card-header">
      <h2 id="drawTitle">🎯 {{ latest.round }}회 최신 추첨결과</h2>
      <span class="draw-date" id="drawDate">{{ latest.draw_date if latest.draw_date else '' }}</span>
    </div>
    <div class="draw-result">
      <div class="numbers" id="drawNumbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball" id="drawBonus">{{ latest.bonus }}</span>
        <span class="bonus-label">보너스</span>
      </div>
    </div>
  </section>

  <!-- Latest Winning Shops -->
  <section class="card" id="shopsSection">
    <div class="card-header">
      <h2 id="shopsTitle">🏪 {{ latest.round }}회 당첨점 정보</h2>
    </div>
    <div id="shopsContent">

    {% if shops_rank1 %}
    <div class="shops-section">
      <h4>🥇 1등 당첨점 ({{ shops_rank1|length }}개)</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>순번</th><th>상호</th><th>구분</th><th>주소</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank1 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td><strong>{{ shop.name }}</strong></td>
              <td><span class="badge-method">{{ shop.method or '구분없음' }}</span></td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    {% if shops_rank2_total > 0 %}
    <div id="rank2-section" class="shops-section">
      <div class="section-header">
        <h4>🥈 2등 당첨점 (총 {{ shops_rank2_total }}개)</h4>
        {% if shops_rank2_total_pages > 1 %}
        <div class="page-info">
          <span>페이지 {{ shops_rank2_page }}/{{ shops_rank2_total_pages }}</span>
        </div>
        {% endif %}
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr><th>순번</th><th>상호</th><th>주소</th></tr>
          </thead>
          <tbody>
            {% for shop in shops_rank2 %}
            <tr>
              <td>{{ shop.sequence or '' }}</td>
              <td>{{ shop.name }}</td>
              <td>{{ shop.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if shops_rank2_total_pages > 1 %}
      <div class="pagination-controls">
        <button
          type="button"
          class="page-btn prev-btn"
          onclick="changeRank2Page({{ shops_rank2_page - 1 }})"
          {% if shops_rank2_page <= 1 %}disabled{% endif %}>
          ◀ 이전
        </button>

        <span class="page-display">{{ shops_rank2_page }} / {{ shops_rank2_total_pages }}</span>

        <button
          type="button"
          class="page-btn next-btn"
          onclick="changeRank2Page({{ shops_rank2_page + 1 }})"
          {% if shops_rank2_page >= shops_rank2_total_pages %}disabled{% endif %}>
          다음 ▶
        </button>
      </div>

      {% if shops_rank2_total_pages > 3 %}
      <div class="quick-jump">
        <span>빠른 이동:</span>
        <button type="button" class="jump-btn" onclick="changeRank2Page(1)">1</button>
        {% if shops_rank2_total_pages > 2 %}
          <button type="button" class="jump-btn" onclick="changeRank2Page({{ (shops_rank2_total_pages + 1) // 2 }})">{{ (shops_rank2_total_pages + 1) // 2 }}</button>
        {% endif %}
        <button type="button" class="jump-btn" onclick="changeRank2Page({{ shops_rank2_total_pages }})">{{ shops_rank2_total_pages }}</button>
      </div>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if not shops_rank1 and not shops_rank2 %}
    <div class="info-box">
      <p>아직 당첨점 정보가 수집되지 않았습니다.</p>
    </div>
    {% endif %}
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>⚠️ 데이터 없음</h2>
    <p>추첨 결과 데이터가 없습니다. <a href="{{ url_for('main.crawling_page') }}">크롤링 페이지</a>에서 데이터를 업데이트해주세요.</p>
  </section>
  {% endif %}


  <!-- 번호 분석 섹션 -->
  {% if most_frequent %}
  <section class="card">
    <div class="card-header">
      <h2>📈 번호 분석 (최근 {{ analysis_limit }}회)</h2>
    </div>

    <!-- 빈출/저출 번호 -->
    <div class="analysis-grid">
      <div class="analysis-item">
        <h4>🔥 최다 빈출번호</h4>
        <div class="number-frequency-list">
          {% for num, freq in most_frequent[:5] %}
          <div class="frequency-item hot">
            <span class="freq-number">{{ num }}</span>
            <span class="freq-count">{{ freq }}회</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="analysis-item">
        <h4>❄️ 최소 빈출번호</h4>
        <div class="number-frequency-list">
          {% for num, freq in least_frequent[:5] %}
          <div class="frequency-item cold">
            <span class="freq-number">{{ num }}</span>
            <span class="freq-count">{{ freq }}회</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="analysis-item">
        <h4>🎲 홀짝 패턴</h4>
        <div class="pattern-list">
          {% for pattern, count in patterns.odd_even_patterns.items() %}
          <div class="pattern-item">
            <span class="pattern-name">{{ pattern }}</span>
            <span class="pattern-count">{{ count }}회</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="analysis-item">
        <h4>💡 합계 분포</h4>
        <div class="pattern-list">
          {% for range_name, count in patterns.sum_ranges.items() %}
          <div class="pattern-item">
            <span class="pattern-name">{{ range_name }}</span>
            <span class="pattern-count">{{ count }}회</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 조합 분석 -->
    {% if combinations %}
    <div class="combinations-section">
      <h4>🤝 자주 나오는 번호 조합 (상위 5개)</h4>
      <div class="combinations-list">
        {% for pair, freq in combinations %}
        <div class="combination-item">
          <div class="combination-numbers">
            <span class="combo-number">{{ pair[0] }}</span>
            <span class="combo-separator">+</span>
            <span class="combo-number">{{ pair[1] }}</span>
          </div>
          <span class="combo-freq">{{ freq }}회</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </section>
  {% endif %}

  <!-- Recent draws table -->
  <section class="card">
    <div class="card-header">
      <h2>📊 최근 10회 추첨 기록</h2>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>회차</th><th>날짜</th><th>당첨번호</th><th>보너스</th></tr>
        </thead>
        <tbody>
          {% for d in draws %}
          <tr>
            <td><strong>{{ d.round }}회</strong></td>
            <td>{{ d.draw_date if d.draw_date else '-' }}</td>
            <td class="numbers-cell">
              {% for num in d.numbers_list() %}
                <span class="small-number-ball">{{ num }}</span>
              {% endfor %}
            </td>
            <td class="bonus-cell">{{ d.bonus }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Footer -->
  <div class="footer">
    <p>헬스체크: <code><a href="/health">/health</a></code></p>
  </div>

</div> <!-- End main-content -->

<script>
  function changeRank2Page(newPage) {
    if (newPage < 1) return;

    // Save current scroll position
    const currentScroll = window.pageYOffset;
    sessionStorage.setItem('infoScrollPosition', currentScroll);

    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('rank2_page', newPage);

    // Navigate with new page parameter
    window.location.href = `${window.location.pathname}?${urlParams.toString()}#rank2-section`;
  }

  // 특정회차 조회
  function lookupRound() {
    const roundInput = document.getElementById('lookupRound');
    const round = parseInt(roundInput.value);

    if (!round || round < 1) {
      alert('유효한 회차 번호를 입력해주세요.');
      return;
    }

    // 기존 표시 업데이트
    const drawTitle = document.getElementById('drawTitle');
    const drawDate = document.getElementById('drawDate');
    const drawNumbers = document.getElementById('drawNumbers');
    const drawBonus = document.getElementById('drawBonus');
    const shopsTitle = document.getElementById('shopsTitle');
    const shopsContent = document.getElementById('shopsContent');

    // 로딩 상태 표시
    drawTitle.innerHTML = `🔍 ${round}회 조회중...`;

    fetch(`/api/draw-info/${round}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const draw = data.draw;
        const shops = data.shops;

        // 당첨번호 표시 업데이트
        drawTitle.innerHTML = `🎯 ${draw.round}회 추첨결과`;
        drawDate.textContent = draw.draw_date || '';

        // 번호 업데이트
        drawNumbers.innerHTML = draw.numbers_list.map(num =>
          `<span class="number-ball">${num}</span>`
        ).join('');
        drawBonus.textContent = draw.bonus;

        // 당첨점 정보 업데이트
        shopsTitle.innerHTML = `🏪 ${draw.round}회 당첨점 정보`;

        if (shops && shops.length > 0) {
          const rank1Shops = shops.filter(s => s.rank === '1');
          const rank2Shops = shops.filter(s => s.rank === '2');

          let shopsHtml = '';

          if (rank1Shops.length > 0) {
            shopsHtml += `
              <div class="shops-section">
                <h4>🥇 1등 당첨점 (${rank1Shops.length}개)</h4>
                <div class="table-container">
                  <table>
                    <thead><tr><th>상호</th><th>주소</th></tr></thead>
                    <tbody>
                      ${rank1Shops.map(shop => `
                        <tr>
                          <td><strong>${shop.name}</strong></td>
                          <td>${shop.address || ''}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>`;
          }

          if (rank2Shops.length > 0) {
            // 2등 당첨점 페이지네이션 (10개씩)
            window.currentRank2Shops = rank2Shops;
            window.currentRank2Page = 1;
            window.rank2PerPage = 10;

            shopsHtml += `
              <div class="shops-section" id="rank2-section">
                <div class="section-header">
                  <h4>🥈 2등 당첨점 (${rank2Shops.length}개)</h4>
                  ${rank2Shops.length > 10 ? `<div class="page-info">페이지 1 / ${Math.ceil(rank2Shops.length / 10)}</div>` : ''}
                </div>
                <div class="table-container" id="rank2Table">
                  <table>
                    <thead><tr><th>상호</th><th>주소</th></tr></thead>
                    <tbody id="rank2TableBody">
                      ${rank2Shops.slice(0, 10).map(shop => `
                        <tr>
                          <td><strong>${shop.name}</strong></td>
                          <td>${shop.address || ''}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ${rank2Shops.length > 10 ? `
                  <div class="pagination-controls">
                    <button type="button" class="page-btn prev-btn" id="rank2PrevBtn" onclick="changeRank2PageDynamic(-1)" disabled>◀ 이전</button>
                    <span class="page-display" id="rank2PageDisplay">1 / ${Math.ceil(rank2Shops.length / 10)}</span>
                    <button type="button" class="page-btn next-btn" id="rank2NextBtn" onclick="changeRank2PageDynamic(1)" ${rank2Shops.length <= 10 ? 'disabled' : ''}>다음 ▶</button>
                  </div>
                ` : ''}
              </div>`;
          }

          shopsContent.innerHTML = shopsHtml;
        } else {
          shopsContent.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">당첨점 정보가 없습니다.</p>';
        }

        // 입력 필드 초기화
        roundInput.value = '';

      } else {
        alert(data.error);
        drawTitle.innerHTML = `🎯 ${document.querySelector('[data-original-round]')?.getAttribute('data-original-round') || '최신'}회 추첨결과`;
      }
    })
    .catch(error => {
      alert('조회 중 오류가 발생했습니다.');
      drawTitle.innerHTML = `🎯 ${document.querySelector('[data-original-round]')?.getAttribute('data-original-round') || '최신'}회 추첨결과`;
    });
  }

  // 동적 2등 당첨점 페이지네이션
  function changeRank2PageDynamic(direction) {
    if (!window.currentRank2Shops) return;

    const totalPages = Math.ceil(window.currentRank2Shops.length / window.rank2PerPage);
    const newPage = window.currentRank2Page + direction;

    if (newPage < 1 || newPage > totalPages) return;

    window.currentRank2Page = newPage;

    // 테이블 업데이트
    const startIdx = (newPage - 1) * window.rank2PerPage;
    const endIdx = startIdx + window.rank2PerPage;
    const pageShops = window.currentRank2Shops.slice(startIdx, endIdx);

    const tbody = document.getElementById('rank2TableBody');
    tbody.innerHTML = pageShops.map(shop => `
      <tr>
        <td><strong>${shop.name}</strong></td>
        <td>${shop.address || ''}</td>
      </tr>
    `).join('');

    // 페이지 정보 및 버튼 상태 업데이트
    const pageDisplay = document.getElementById('rank2PageDisplay');
    const pageInfo = document.querySelector('.page-info');
    const prevBtn = document.getElementById('rank2PrevBtn');
    const nextBtn = document.getElementById('rank2NextBtn');

    if (pageDisplay) pageDisplay.textContent = `${newPage} / ${totalPages}`;
    if (pageInfo) pageInfo.textContent = `페이지 ${newPage} / ${totalPages}`;

    if (prevBtn) prevBtn.disabled = newPage <= 1;
    if (nextBtn) nextBtn.disabled = newPage >= totalPages;
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Restore scroll position for pagination
    const savedScroll = sessionStorage.getItem('infoScrollPosition');
    if (savedScroll && window.location.hash === '#rank2-section') {
      setTimeout(() => {
        window.scrollTo(0, parseInt(savedScroll));
        sessionStorage.removeItem('infoScrollPosition');
      }, 100);
    }
  });
</script>

<style>
/* 번호 분석 스타일 */
.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin: 1.5rem 0;
}

.analysis-item {
  background: #f8f9fa;
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 1rem;
}

.analysis-item h4 {
  margin: 0 0 1rem 0;
  color: #333;
  font-size: 1rem;
  font-weight: 600;
}

.number-frequency-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.frequency-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem;
  border-radius: 6px;
  font-weight: 500;
}

.frequency-item.hot {
  background: #ffebee;
  border: 1px solid #ef9a9a;
}

.frequency-item.cold {
  background: #e3f2fd;
  border: 1px solid #90caf9;
}

.freq-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: var(--acc);
  color: white;
  border-radius: 50%;
  font-size: 0.9rem;
  font-weight: bold;
}

.freq-count {
  color: #666;
  font-size: 0.9rem;
}

.pattern-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.pattern-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
}

.pattern-name {
  font-size: 0.9rem;
  color: #333;
}

.pattern-count {
  color: #666;
  font-size: 0.85rem;
  font-weight: 500;
}

.combinations-section {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--card-border);
}

.combinations-section h4 {
  margin: 0 0 1rem 0;
  color: #333;
  font-size: 1rem;
  font-weight: 600;
}

.combinations-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 0.75rem;
}

.combination-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
}

.combination-numbers {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.combo-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: var(--acc);
  color: white;
  border-radius: 50%;
  font-size: 0.8rem;
  font-weight: bold;
}

.combo-separator {
  color: #666;
  font-weight: bold;
}

.combo-freq {
  color: #666;
  font-size: 0.8rem;
  font-weight: 500;
}

@media (max-width: 768px) {
  .analysis-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .combinations-list {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
  }
}

/* 작은 번호 볼 스타일 */
.small-number-ball {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: var(--acc);
  color: white;
  border-radius: 50%;
  font-size: 0.75rem;
  font-weight: bold;
  margin-right: 2px;
}

.numbers-cell {
  min-width: 160px;
}

.bonus-cell {
  font-weight: bold;
  color: #ff6b6b;
  text-align: center;
}

/* Simple table-based shops styles */
.shops-section {
  margin-bottom: 1.5rem;
}

.shops-section h4 {
  margin-bottom: 0.75rem;
  color: #333;
  font-size: 1.1rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.page-info {
  font-size: 0.9rem;
  color: #666;
  background: #f8f9fa;
  padding: 0.5rem 0.75rem;
  border-radius: 0.25rem;
}

.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.page-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.page-btn:hover:not(:disabled) {
  background: #5a67d8;
}

.page-btn:disabled {
  background: #e2e8f0;
  color: #a0aec0;
  cursor: not-allowed;
}

.page-display {
  font-weight: 500;
  color: #333;
  padding: 0.5rem 1rem;
  background: #f8f9fa;
  border-radius: 0.25rem;
}

.quick-jump {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
  font-size: 0.9rem;
}

.jump-btn {
  background: #f8f9fa;
  border: 1px solid #e2e8f0;
  color: #667eea;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.jump-btn:hover {
  background: #667eea;
  color: white;
}

.lookup-panel {
  margin-top: 1rem;
}

.lookup-description {
  margin-bottom: 1.5rem;
}

/* 헤더 스타일 */
.title-stats {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.stats {
  text-align: right;
}

.lookup-row {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-top: 1rem;
}

.lookup-simple {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.lookup-simple input {
  width: 100px;
  padding: 0.5rem;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  text-align: center;
}

.lookup-simple input:focus {
  outline: none;
  border-color: #667eea;
}

.btn-lookup {
  background: #667eea;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn-lookup:hover {
  background: #5a67d8;
}


@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .title-stats {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .lookup-row {
    flex-direction: column;
    gap: 0.5rem;
    align-items: stretch;
  }

  .section-header {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .pagination-controls {
    gap: 0.5rem;
  }

  .page-btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }

  .form-row {
    flex-direction: column;
    gap: 0.5rem;
  }
}
</style>
{% endblock %}
